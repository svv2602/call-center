# Фаза 3 — Сервисы: Шиномонтаж и консультации

## Цель фазы

Расширить возможности агента: запись на шиномонтаж с выбором даты/времени/точки обслуживания, а также экспертные консультации по подбору шин.

## Пререквизиты

- Фаза 2 (заказы) завершена и стабильно работает
- Store API расширен эндпоинтами для записи на шиномонтаж
- Агент наработал статистику типичных вопросов из фаз 1–2

## Сценарии

### 3.1 Запись на шиномонтаж

**Триггер:** "Хочу записатися на шиномонтаж" / "Коли можна поставити шини?"

**Поток:**
```
Клиент: "Хочу записатися на шиномонтаж"
Агент: "Звичайно! В якому місті вам зручно?"
Клиент: "Київ"
Агент:  → tool call: get_fitting_stations(city="Київ")
        → API: 3 точки
Агент: "У Києві є 3 точки шиномонтажу:
        1. Вулиця Червоноармійська 15 — Подільський район
        2. Проспект Перемоги 50 — Шевченківський район
        3. Вулиця Здолбунівська 7а — Позняки
        Яка вам зручніша?"
Клиент: "Позняки"
Агент:  → tool call: get_fitting_slots(station_id="3", date_from="today")
        → API: свободные слоты
Агент: "На Позняках найближчі вільні дати:
        Завтра, 15 березня — 10:00, 14:00, 16:00
        Післязавтра, 16 березня — 9:00, 11:00, 13:00
        Який час вам підходить?"
Клиент: "Завтра о 14"
Агент:  → tool call: book_fitting(station_id="3", date="2025-03-15",
                      time="14:00", phone="+380...", vehicle="Toyota Camry 2020")
Агент: "Записав вас на завтра, 15 березня, о 14:00 на Здолбунівській 7а.
        На ваш номер прийде SMS-підтвердження.
        Не забудьте взяти з собою шини або повідомте, якщо шини вже у нас.
        Чи є ще якісь питання?"
```

**Доп. сценарии:**
- Клиент купил шины у нас → автоматически связать с заказом
- Перенос/отмена записи
- Уточнение стоимости монтажа (зависит от радиуса, типа услуги)

### 3.2 Консультация по подбору шин

**Триггер:** сложные вопросы, сравнение, рекомендации.

В отличие от простого подбора (фаза 1), здесь агент выступает экспертом:

**Примеры диалогов:**

```
Клиент: "Що краще — Michelin чи Continental для зими?"
Агент: [Использует knowledge base + search_tires для сравнения]
       "Обидва — відмінний вибір для зими. Michelin X-Ice North 4 краще
        тримає на льоду, Continental IceContact 3 — тихіший на асфальті.
        Для міської їзди я б рекомендував Continental, для заміського —
        Michelin. Який стиль водіння вам ближчий?"
```

```
Клиент: "У мене бюджет 10000 гривень на комплект, що порадите?"
Агент:  → tool call: search_tires(vehicle=..., max_total_price=10000, qty=4)
        "В рамках 10 000 гривень за комплект є кілька варіантів:
         1. Premiorri Viamaggiore 205/55 R16 — 6000 грн/комплект
         2. Rosava Snowgard Van 205/55 R16 — 7200 грн/комплект
         3. Debica Frigo 2 205/55 R16 — 8800 грн/комплект
         Що вас цікавить?"
```

**Механизм экспертных знаний:**

Используем RAG (Retrieval-Augmented Generation):
- База знаний: характеристики брендов, сравнения, типичные рекомендации
- Загружается в LLM как контекст при консультационных вопросах
- Обновляется менеджерами магазина через админку

### 3.3 Комплексные сценарии

Фаза 3 позволяет связывать сценарии в цепочки:

```
Подбор шин → Оформление заказа → Запись на шиномонтаж

"Мені потрібні зимові шини на Камрі і записатися на монтаж"
→ Агент проводит подбор
→ Оформляет заказ
→ Предлагает записаться на монтаж
→ Записывает на удобное время
```

## Новые tools для LLM

```python
new_tools = [
    {
        "name": "get_fitting_stations",
        "description": "Получить список точек шиномонтажа",
        "input_schema": {
            "type": "object",
            "properties": {
                "city": {"type": "string"},
            },
            "required": ["city"],
        },
    },
    {
        "name": "get_fitting_slots",
        "description": "Получить доступные слоты для записи",
        "input_schema": {
            "type": "object",
            "properties": {
                "station_id": {"type": "string"},
                "date_from": {"type": "string", "description": "YYYY-MM-DD или 'today'"},
                "date_to": {"type": "string"},
                "service_type": {
                    "type": "string",
                    "enum": ["tire_change", "balancing", "full_service"],
                },
            },
            "required": ["station_id"],
        },
    },
    {
        "name": "book_fitting",
        "description": "Записать клиента на шиномонтаж",
        "input_schema": {
            "type": "object",
            "properties": {
                "station_id": {"type": "string"},
                "date": {"type": "string", "description": "YYYY-MM-DD"},
                "time": {"type": "string", "description": "HH:MM"},
                "customer_phone": {"type": "string"},
                "vehicle_info": {"type": "string"},
                "service_type": {"type": "string"},
                "tire_diameter": {"type": "integer"},
                "linked_order_id": {"type": "string", "description": "Связанный заказ"},
            },
            "required": ["station_id", "date", "time", "customer_phone"],
        },
    },
    {
        "name": "cancel_fitting",
        "description": "Отменить или перенести запись на шиномонтаж",
        "input_schema": {
            "type": "object",
            "properties": {
                "booking_id": {"type": "string"},
                "action": {"type": "string", "enum": ["cancel", "reschedule"]},
                "new_date": {"type": "string"},
                "new_time": {"type": "string"},
            },
            "required": ["booking_id", "action"],
        },
    },
    {
        "name": "get_fitting_price",
        "description": "Узнать стоимость шиномонтажа",
        "input_schema": {
            "type": "object",
            "properties": {
                "station_id": {"type": "string"},
                "tire_diameter": {"type": "integer"},
                "service_type": {"type": "string"},
            },
            "required": ["tire_diameter"],
        },
    },
    {
        "name": "search_knowledge_base",
        "description": "Поиск по базе знаний магазина (характеристики шин, рекомендации, FAQ)",
        "input_schema": {
            "type": "object",
            "properties": {
                "query": {"type": "string"},
            },
            "required": ["query"],
        },
    },
]
```

## Store API — новые эндпоинты

| Метод | Endpoint | Описание |
|-------|----------|----------|
| GET | `/api/v1/fitting/stations` | Список точек шиномонтажа |
| GET | `/api/v1/fitting/stations/{id}/slots` | Доступные слоты |
| POST | `/api/v1/fitting/bookings` | Создать запись |
| DELETE | `/api/v1/fitting/bookings/{id}` | Отменить запись |
| PATCH | `/api/v1/fitting/bookings/{id}` | Перенести запись |
| GET | `/api/v1/fitting/prices` | Прайс-лист на услуги |
| GET | `/api/v1/knowledge/search` | Поиск по базе знаний |

## База знаний (Knowledge Base)

### Структура

```
knowledge_base/
├── brands/           # Описание брендов, особенности
│   ├── michelin.md
│   ├── continental.md
│   └── ...
├── guides/           # Руководства по подбору
│   ├── winter_tires.md
│   ├── summer_tires.md
│   └── size_guide.md
├── faq/              # Часто задаваемые вопросы
│   ├── general.md
│   ├── delivery.md
│   └── fitting.md
└── comparisons/      # Сравнения
    ├── michelin_vs_continental.md
    └── ...
```

### Наполнение

- Первичное наполнение: экспорт из существующих материалов магазина
- Обновление: менеджеры магазина через веб-интерфейс (фаза 4)
- Автоматическое обогащение: на основе логов звонков (частые вопросы → новые статьи)

### Механизм поиска

- Векторный поиск (embeddings) по базе знаний
- При консультационном вопросе: LLM получает top-5 релевантных фрагментов как контекст
- Стек: PostgreSQL + pgvector (для хранения embeddings)

## Обновление системного промпта

```
Додаткові можливості (фаза 3):
- Запис на шиномонтаж (вибір точки, дати, часу)
- Експертна консультація з підбору шин
- Порівняння брендів та моделей
- Комплексне обслуговування: підбір + замовлення + запис на монтаж

Правила консультації:
- Використовуй базу знань для порівнянь та рекомендацій
- Не вигадуй характеристики — шукай в базі знань
- Якщо питання занадто складне — переключи на менеджера
- Пропонуй комплексне обслуговування: після замовлення шин — запис на монтаж

Правила запису на монтаж:
- Обов'язково уточни: місто, бажану дату, зручний час
- Запропонуй 2-3 найближчі слоти
- Після запису — нагадай адресу та час
```

## Критерии приёмки

- [ ] Бот записывает клиента на шиномонтаж (полный цикл)
- [ ] Бот показывает доступные даты и время
- [ ] Бот отменяет/переносит запись
- [ ] Бот озвучивает стоимость монтажа
- [ ] Бот проводит экспертную консультацию, используя базу знаний
- [ ] Бот связывает заказ шин с записью на монтаж
- [ ] Бот проводит комплексный сценарий: подбор → заказ → монтаж
- [ ] База знаний содержит минимум 20 статей (бренды, FAQ, гайды)
- [ ] Векторный поиск по базе знаний работает корректно
