# Фаза 4 — Аналитика и оптимизация

## Цель фазы

Построить систему аналитики, мониторинга качества и инструменты оптимизации. Превратить колл-центр из "работающего" в "эффективно работающий": понимать метрики, находить проблемы, улучшать промпты и снижать расходы.

## Пререквизиты

- Фазы 1–3 завершены и работают в продакшене
- Накоплена статистика минимум за 2–4 недели эксплуатации
- PostgreSQL содержит логи звонков с транскрипциями

## Компоненты

### 4.1 Дашборд реального времени

**Технология:** Grafana + Prometheus + PostgreSQL

**Метрики реального времени:**

| Метрика | Описание | Источник |
|---------|----------|----------|
| Активные звонки | Количество текущих сессий | Call Processor |
| Очередь на оператора | Звонки в ожидании оператора | Asterisk AMI |
| Средняя задержка ответа | Время от конца речи клиента до начала ответа бота | Call Processor |
| STT latency | Задержка распознавания речи | STT модуль |
| TTS latency | Задержка синтеза речи | TTS модуль |
| LLM latency | Задержка ответа LLM | Agent модуль |
| Ошибки STT/TTS/LLM | Количество ошибок по типам | Все модули |

**Агрегированные метрики (за день/неделю/месяц):**

| Метрика | Описание |
|---------|----------|
| Общее количество звонков | |
| Средняя длительность звонка | |
| % звонков, обработанных ботом полностью | Без переключения на оператора |
| % переключений на оператора | По причинам |
| % успешных заказов через бота | Заказ оформлен до конца |
| % записей на монтаж через бота | |
| Распределение по сценариям | Подбор / наличие / заказ / монтаж / консультация |
| Распределение по времени суток | Пиковые часы нагрузки |
| Средняя стоимость обработки звонка | STT + LLM + TTS |
| NPS / оценка клиентов | Если внедрена система оценки |

### 4.2 Логирование и транскрипции

**Структура лога звонка:**

```json
{
  "call_id": "uuid",
  "started_at": "2025-03-15T14:30:00Z",
  "ended_at": "2025-03-15T14:35:22Z",
  "duration_seconds": 322,
  "caller_id": "+380XXXXXXXXX",
  "scenario": "tire_search + order",
  "transferred_to_operator": false,
  "transfer_reason": null,
  "order_created": "ORD-12346",
  "fitting_booked": null,
  "turns": [
    {
      "speaker": "bot",
      "text": "Добрий день! Інтернет-магазин шин XYZ. Чим можу допомогти?",
      "timestamp": "2025-03-15T14:30:01Z",
      "tts_latency_ms": 340
    },
    {
      "speaker": "customer",
      "text": "Мені потрібні зимові шини на Тойоту Камрі",
      "timestamp": "2025-03-15T14:30:05Z",
      "stt_confidence": 0.94,
      "stt_latency_ms": 180
    },
    {
      "speaker": "bot",
      "text": "...",
      "tool_calls": [{"name": "search_tires", "args": {...}, "result": {...}}],
      "llm_latency_ms": 850,
      "tts_latency_ms": 420
    }
  ],
  "total_cost": {
    "stt": 0.024,
    "llm": 0.018,
    "tts": 0.012,
    "total_usd": 0.054
  }
}
```

**Хранение:**
- PostgreSQL — структурированные данные и метаданные
- Транскрипции — в PostgreSQL (JSONB) или S3-совместимое хранилище для аудио
- Retention: 90 дней полные логи, 1 год — агрегированная статистика

### 4.3 Анализ качества диалогов

**Автоматическая оценка качества:**

Запускается как фоновая задача (Celery) после каждого звонка:

```python
quality_checks = [
    "bot_greeted_properly",        # Бот поздоровался
    "bot_understood_intent",       # Бот правильно понял намерение
    "bot_used_correct_tool",       # Бот вызвал правильный инструмент
    "bot_provided_accurate_info",  # Информация корректна (сверка с API)
    "bot_confirmed_before_action", # Подтвердил перед оформлением
    "bot_was_concise",             # Ответы не слишком длинные
    "call_resolved_without_human", # Решено без оператора
    "customer_seemed_satisfied",   # Клиент не выражал недовольства
]
```

**Механизм:** отдельный LLM-вызов (можно Claude Haiku для экономии) анализирует транскрипцию звонка и выставляет оценки по каждому критерию.

**Выявление проблем:**
- Звонки с низкой оценкой → попадают в очередь на ручной просмотр
- Паттерны: если 30%+ звонков по определённому сценарию переключаются на оператора → алерт
- Частые переспрашивания STT → проблема с распознаванием определённых слов

### 4.4 Оптимизация промптов

**A/B тестирование промптов:**

```python
prompt_variants = {
    "greeting": {
        "A": "Добрий день! Інтернет-магазин шин XYZ. Чим можу допомогти?",
        "B": "Вітаю! Це магазин шин XYZ. Як я можу вам допомогти?",
    },
    "system_prompt_version": {
        "v1": "current_prompt.txt",
        "v2": "optimized_prompt.txt",
    },
}
```

- Каждый звонок случайно получает вариант A или B
- Метрики по вариантам: % решения без оператора, длительность, оценка качества
- Статистически значимая разница → переключение на лучший вариант

**Автоматическая доработка промптов:**
- Сбор проблемных диалогов
- Анализ причин неудач
- Генерация предложений по улучшению промпта (с примерами)
- Ручное одобрение менеджером → применение

### 4.5 Снижение расходов

**Self-hosted Whisper (замена Google STT):**

| Параметр | Google STT | Self-hosted Faster-Whisper |
|----------|------------|---------------------------|
| Стоимость | ~$900/мес (500 зв/день) | ~$150/мес (GPU сервер) |
| Качество UA | Отличное | Отличное (large-v3) |
| Задержка | ~200ms (streaming) | ~300-500ms (batch) |
| Зависимость | Облако Google | Свой сервер |

**Рекомендация:** мигрировать на Faster-Whisper после достижения стабильных 300+ звонков/день. Экономия ~$750/мес.

**Кэширование TTS:**
- Фразы-шаблоны (приветствие, прощание, "зачекайте") — кэшировать аудио
- Потенциальная экономия: 20–30% расходов на TTS

**Оптимизация LLM:**
- Простые запросы (статус заказа) → Claude Haiku (дешевле, быстрее)
- Сложные (консультация, оформление) → Claude Sonnet/Opus
- Routing: анализ первой фразы клиента определяет модель

### 4.6 Веб-интерфейс администратора

**Функции:**

- **Дашборд:** метрики в реальном времени (встроенный Grafana)
- **Журнал звонков:** список с фильтрами, поиск по транскрипции
- **Детали звонка:** полная транскрипция, аудио, оценка качества, стоимость
- **Управление промптами:** редактирование, версионирование, A/B тесты
- **База знаний:** CRUD для статей, управление контентом
- **Настройки:** рабочие часы бота, лимиты, список операторов

**Технология:** FastAPI backend (уже есть) + фронтенд (React или Vue).

## Store API — новые эндпоинты

| Метод | Endpoint | Описание |
|-------|----------|----------|
| GET | `/api/v1/analytics/calls` | Список звонков с фильтрами |
| GET | `/api/v1/analytics/calls/{id}` | Детали звонка (транскрипция, метрики) |
| GET | `/api/v1/analytics/summary` | Агрегированная статистика |
| GET | `/api/v1/analytics/quality` | Отчёт по качеству |
| GET | `/api/v1/prompts` | Список версий промптов |
| POST | `/api/v1/prompts` | Создать новую версию промпта |
| PATCH | `/api/v1/prompts/{id}/activate` | Активировать версию |
| GET | `/api/v1/prompts/ab-tests` | Текущие A/B тесты |

## Алерты

| Событие | Условие | Канал |
|---------|---------|-------|
| Высокий % переключений | >50% за последний час | Telegram / Slack |
| Ошибки STT/TTS/LLM | >5 за 10 минут | Telegram / Slack |
| Задержка ответа | p95 > 3 секунды | Prometheus alert |
| Нет активных операторов | Очередь > 5 и нет доступных операторов | Telegram / SMS |
| Аномальный расход API | >200% от среднедневного | Email |
| Prompt injection подозрение | Аномальные параметры tool calls (price=0, qty>50) | Telegram / Slack |
| Аномалия валидации | >3 отклонённых tool calls за 1 звонок | Telegram |

## Критерии приёмки

- [ ] Grafana-дашборд отображает все ключевые метрики в реальном времени
- [ ] Все звонки логируются с полной транскрипцией и метаданными
- [ ] Автоматическая оценка качества работает для каждого звонка
- [ ] A/B тестирование промптов запущено минимум для 1 варианта
- [ ] Алерты настроены и работают (хотя бы Telegram)
- [ ] Веб-интерфейс администратора: журнал звонков + детали + управление промптами
- [ ] Стоимость обработки одного звонка снижена на 20%+ по сравнению с фазой 1
- [ ] Документирована процедура анализа проблемных звонков
