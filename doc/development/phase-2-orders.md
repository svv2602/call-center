# Фаза 2 — Заказы: Статус и оформление

## Цель фазы

Добавить возможность проверки статуса существующих заказов и оформления новых заказов через голосового агента. Клиент сможет полностью завершить покупку без участия оператора.

## Пререквизиты

- Фаза 1 (MVP) завершена и стабильно работает
- Store API расширен эндпоинтами для работы с заказами

## Сценарии

### 2.1 Статус заказа

**Триггер:** "Де мій заказ?" / "Який статус замовлення?" / "Коли доставка?"

**Идентификация клиента:** по номеру телефона (CallerID из Asterisk) или по номеру заказа.

**Поток:**
```
Клиент: "Я хочу дізнатися статус мого замовлення"
Агент:  → определяет телефон из CallerID
        → tool call: get_order_status(phone="+380XXXXXXXXX")
        → API: найден заказ #12345, статус "в доставке", ожидается 15.03
Агент: "За вашим номером телефону знайдено замовлення номер 12345.
        Зараз воно в доставці, очікувана дата — 15 березня.
        Чи є ще якісь питання?"
```

**Альтернативные сценарии:**
- Несколько заказов → перечислить последние, спросить какой интересует
- Заказ не найден → предложить назвать номер заказа
- Номер заказа назван голосом → распознать и найти

### 2.2 Оформление заказа

**Триггер:** "Хочу замовити" / "Оформіть замовлення" / после подбора шин — "Так, хочу ці"

**Поток:**
```
[После подбора шин в Фазе 1]
Агент: "Бажаєте оформити замовлення?"
Клиент: "Так, візьму Michelin X-Ice, 4 штуки"
Агент:  → tool call: create_order_draft(items=[{product_id: "...", qty: 4}])
        → API: создан черновик, сумма 12800 грн

Агент: "Замовлення: 4 шини Michelin X-Ice North 4 215/55 R17,
        загальна сума — 12 800 гривень.
        Доставка чи самовивіз?"
Клиент: "Доставка, Київ, вулиця Хрещатик 1"
Агент:  → tool call: update_order_delivery(order_id, type="delivery",
                      city="Київ", address="вулиця Хрещатик 1")
        → API: доставка 200 грн, итого 13000 грн

Агент: "Доставка в Київ — 200 гривень. Разом — 13 000 гривень.
        Оплата при отриманні чи онлайн?"
Клиент: "При отриманні"
Агент:  → tool call: confirm_order(order_id, payment="cod")
        → API: заказ #12346 подтверждён

Агент: "Замовлення номер 12346 оформлено! Очікуйте доставку протягом
        2-3 робочих днів. На ваш номер прийде SMS з деталями.
        Чи є ще якісь питання?"
```

## Новые tools для LLM

```python
new_tools = [
    {
        "name": "get_order_status",
        "description": "Получить статус заказа по телефону клиента или номеру заказа",
        "input_schema": {
            "type": "object",
            "properties": {
                "phone": {"type": "string", "description": "+380XXXXXXXXX"},
                "order_id": {"type": "string", "description": "Номер заказа"},
            },
        },
    },
    {
        "name": "create_order_draft",
        "description": "Создать черновик заказа",
        "input_schema": {
            "type": "object",
            "properties": {
                "items": {
                    "type": "array",
                    "items": {
                        "type": "object",
                        "properties": {
                            "product_id": {"type": "string"},
                            "quantity": {"type": "integer"},
                        },
                        "required": ["product_id", "quantity"],
                    },
                },
                "customer_phone": {"type": "string"},
            },
            "required": ["items", "customer_phone"],
        },
    },
    {
        "name": "update_order_delivery",
        "description": "Указать способ и адрес доставки",
        "input_schema": {
            "type": "object",
            "properties": {
                "order_id": {"type": "string"},
                "delivery_type": {
                    "type": "string",
                    "enum": ["delivery", "pickup"],
                },
                "city": {"type": "string"},
                "address": {"type": "string"},
                "pickup_point_id": {"type": "string"},
            },
            "required": ["order_id", "delivery_type"],
        },
    },
    {
        "name": "confirm_order",
        "description": "Подтвердить и финализировать заказ",
        "input_schema": {
            "type": "object",
            "properties": {
                "order_id": {"type": "string"},
                "payment_method": {
                    "type": "string",
                    "enum": ["cod", "online", "card_on_delivery"],
                },
                "customer_name": {"type": "string"},
            },
            "required": ["order_id", "payment_method"],
        },
    },
]
```

## Обновление системного промпта

Дополнения к промпту для фазы 2:

```
Додаткові можливості:
- Перевірка статусу замовлення за номером телефону або номером замовлення
- Оформлення замовлення (створення, вибір доставки, підтвердження)

Правила оформлення замовлення:
- Завжди підтверджуй склад замовлення перед оформленням
- Обов'язково уточни: доставка чи самовивіз
- Обов'язково уточни: спосіб оплати
- Назви підсумкову суму перед підтвердженням
- Після оформлення — продиктуй номер замовлення повільно і чітко
```

## Store API — новые эндпоинты

| Метод | Endpoint | Описание |
|-------|----------|----------|
| GET | `/api/v1/orders/search` | Поиск заказов по телефону/номеру |
| GET | `/api/v1/orders/{id}` | Детали заказа |
| POST | `/api/v1/orders` | Создать черновик заказа |
| PATCH | `/api/v1/orders/{id}/delivery` | Указать доставку |
| POST | `/api/v1/orders/{id}/confirm` | Подтвердить заказ |
| GET | `/api/v1/delivery/calculate` | Рассчитать стоимость доставки |
| GET | `/api/v1/pickup-points` | Список пунктов самовывоза |

Подробное описание: [api-specification.md](./api-specification.md)

## Идентификация клиента

### Стратегия

1. **Первичная идентификация** — по CallerID (номер телефона звонящего)
2. **Если CallerID скрыт** — попросить назвать номер телефона или номер заказа
3. **Для оформления заказа** — телефон обязателен (из CallerID или устно)

### Передача CallerID в сессию

```python
# При установлении AudioSocket соединения Asterisk передаёт UUID канала.
# CallerID получаем через ARI по UUID канала.

async def get_caller_id(channel_uuid: str) -> str:
    """Получить CallerID через Asterisk ARI."""
    async with aiohttp.ClientSession() as session:
        resp = await session.get(
            f"http://localhost:8088/ari/channels/{channel_uuid}",
            auth=aiohttp.BasicAuth("ari_user", "ari_password"),
        )
        data = await resp.json()
        return data["caller"]["number"]
```

## Безопасность

- **Подтверждение заказа:** перед confirm_order агент ОБЯЗАН озвучить состав, сумму и получить явное "так" / "підтверджую"
- **Отмена:** на любом этапе клиент может сказать "скасуй" — черновик удаляется
- **Таймаут:** если клиент молчит > 30 сек во время оформления — спросить, продолжаем ли
- **Лимиты:** максимальная сумма заказа через бота — настраиваемый порог (выше — переключение на оператора)

## Критерии приёмки

- [ ] Бот определяет клиента по CallerID
- [ ] Бот находит и озвучивает статус заказа
- [ ] Бот работает с несколькими заказами одного клиента
- [ ] Бот проводит полный цикл оформления заказа
- [ ] Бот подтверждает детали перед финализацией
- [ ] Бот отправляет/инициирует SMS с подтверждением заказа
- [ ] Клиент может отменить оформление на любом этапе
- [ ] Логирование всех действий с заказами (аудит)
