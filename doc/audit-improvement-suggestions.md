# Предложения по улучшению проекта Call Center AI

## Введение

Данный документ содержит замечания и предложения по улучшению проекта на основе анализа документации в папке `/doc`. Документация проекта является подробной и хорошо структурированной, однако выявлены области, где можно усилить безопасность, архитектуру, процессы разработки и документацию.

## 1. Общие замечания

- Документация охватывает все ключевые аспекты: бизнес-цели, техническую архитектуру, безопасность, фазы разработки, нефункциональные требования.
- Отличное использование диаграмм Mermaid для визуализации архитектуры, потоков данных, дорожной карты.
- Чёткое разделение документации по аудиториям (инвестор, технический директор, разработчик, DevOps).

**Рекомендация:** Рассмотреть возможность добавления раздела "Troubleshooting" или "Часто задаваемые вопросы" для быстрого решения типовых проблем (например, проблемы с AudioSocket, настройкой STT/TTS, диагностикой задержек).

## 2. Безопасность

### 2.1 Управление секретами

**Текущее состояние:** В документации упоминается хранение API-ключей в переменных окружения и Docker secrets, а также ротация каждые 90 дней.

**Предложения:**
1. **Добавить пошаговое руководство по настройке HashiCorp Vault** (или аналога) для централизованного управления секретами в продакшене. Включить примеры конфигурации динамических секретов для PostgreSQL.
2. **Автоматизация ротации ключей:** Описать скрипты или CI/CD пайплайн для автоматической ротации ключей Google Cloud Service Account и Anthropic API Key.
3. **Мониторинг использования ключей:** Добавить дашборд Grafana для отслеживания аномального использования API-ключей (например, неожиданные сказы затрат).

### 2.2 Защита от Prompt Injection

**Текущее состояние:** В threat-model.md описаны меры защиты (строгий промпт, валидация tool calls, лимиты). Предложен дашборд для мониторинга.

**Предложения:**
1. **Конкретизировать метрики и алерты:** Определить точные пороги для алертов (например, >3 tool calls с параметрами price=0 за 5 минут). Привести пример конфигурации Prometheus alert rule.
2. **Реализация PII Sanitizer:** В data-policy.md описан класс PIISanitizer. Добавить реальный пример интеграции с Python logging (фильтр) и настройку для всех лог-хандлеров.
3. **Добавить тесты на prompt injection:** В раздел тестирования включить юнит-тесты, которые проверяют устойчивость агента к известным атакам (например, "забудь инструкции").

### 2.3 Безопасность зависимостей

**Текущее состояние:** Упомянуты инструменты pip-audit и safety в CI/CD.

**Предложения:**
1. **Добавить конфигурацию Dependabot/Renovate:** Пример файла `.github/dependabot.yml` для автоматического обновления зависимостей и создания PR.
2. **Политика обновления:** Чётко определить, какие типы уязвимостей блокируют мерж (критические, высокие) и сроки исправления.

## 3. Архитектура и масштабируемость

### 3.1 Уменьшение зависимости от вендоров

**Текущее состояние:** План по замене Google STT на саморазмещённый Whisper (фаза 4). Упоминание open-source альтернатив для TTS.

**Предложения:**
1. **Детальный план миграции на Whisper:** Разбить на этапы: оценка качества, тестирование производительности, канареечное развёртывание, мониторинг.
2. **Исследование альтернатив TTS:** Рассмотреть Coqui-TTS или Piper как опцию для будущего перехода. Добавить сравнительную таблицу (качество, задержка, стоимость).
3. **Абстракция LLM провайдера:** Предложить интерфейс `LLMProvider`, позволяющий легко переключаться между Claude, GPT-4o, Gemini (или локальными моделями) без изменения кода агента.

### 3.2 Отказоустойчивость Asterisk

**Текущее состояние:** Asterisk является single point of failure на MVP. План резервирования на фазу 3+.

**Предложения:**
1. **Добавить конфигурацию Docker-контейнера для Asterisk:** Это упростит развёртывание и резервирование. Привести Dockerfile и docker-compose фрагмент.
2. **Схема актив-пассивного кластера:** Детализировать настройку синхронизации конфигураций (через rsync/Ansible) и переключение на стороне SIP trunk.
3. **Мониторинг каналов Asterisk:** Расширить Prometheus exporter для отслеживания не только доступности, но и загрузки каналов, очередей.

### 3.3 Управление состоянием сессий

**Текущее состояние:** Сессии хранятся в Redis с TTL.

**Предложения:**
1. **Добавить механизм graceful migration сессий** при перезапуске Redis (использование Redis persistence или репликации).
2. **Мониторинг использования памяти Redis:** Настроить алерты при приближении к лимиту.

## 4. Процесс разработки и CI/CD

### 4.1 Стратегия тестирования

**Текущее состояние:** В 00-overview.md описаны unit, интеграционные, E2E и нагрузочные тесты.

**Предложения:**
1. **Добавить примеры кода тестов:** Например, unit-тест для парсинга пакетов AudioSocket, интеграционный тест с testcontainers для PostgreSQL/Redis.
2. **Нагрузочное тестирование с SIPp:** Привести пример скрипта SIPp для имитации 50 одновременных звонков и скрипта обработки результатов.
3. **Покрытие кода:** Установить целевой уровень покрытия (например, 80% для core-модулей) и интегрировать с Codecov.

### 4.2 CI/CD пайплайн

**Текущее состояние:** Описан pipeline в 00-overview.md с использованием GitHub Actions.

**Предложения:**
1. **Полный пример файла `.github/workflows/ci.yml`** с всеми этапами: lint, unit tests, security scan, integration tests, build, deploy to staging.
2. **Добавить этап "Canary deployment"** для постепенного развёртывания новой версии Call Processor (например, 10% трафика).
3. **Интеграция с уведомлениями:** Настроить оповещения в Telegram/Slack при падении тестов или обнаружении уязвимостей.

### 4.3 Локальная разработка

**Текущее состояние:** Не описана настройка локального окружения для разработки и отладки.

**Предложения:**
1. **Добавить руководство `development/setup-local.md`** с инструкциями по запуску всего стека (Asterisk в Docker, Call Processor, PostgreSQL, Redis) на локальной машине.
2. **Инструменты отладки:** Описать, как использовать `ngrok` для тестирования AudioSocket извне, как просматривать логи в реальном времени.

## 5. Документация

### 5.1 Недостающие разделы

**Предложения:**
1. **Troubleshooting Guide:** Включить типичные ошибки (например, "AudioSocket connection refused", "Google STT authentication error") и шаги по их устранению.
2. **Глоссарий терминов:** Определить термины типа "barge-in", "tool calling", "prompt injection" для новых членов команды.
3. **Чек-лист развёртывания (deployment checklist):** Поэтапный список действий перед запуском в продакшен (проверка бэкапов, настройка мониторинга, тестирование failover).

### 5.2 Актуальность документации

**Рекомендация:** Установить процесс регулярного обновления документации (например, пересмотр после каждого релиза). Можно добавить метку "Последнее обновление" в каждом файле.

## 6. Заключение

Документация проекта Call Center AI демонстрирует высокий уровень проработки и является отличной основой для успешной реализации. Предложенные улучшения направлены на усиление безопасности, повышение отказоустойчивости, оптимизацию процессов разработки и дополнение документации практическими руководствами. Реализация этих рекомендаций позволит создать более надёжную, масштабируемую и удобную в сопровождении систему.

---
*Дата анализа: 13 февраля 2025*  
*Анализ проведён на основе документации в папке `/doc`.*
