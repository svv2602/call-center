# Политика обработки персональных данных

## 1. Правовая основа

Обработка персональных данных осуществляется в соответствии с:
- Закон України "Про захист персональних даних" (№ 2297-VI)
- GDPR (в части обработки данных граждан ЕС, если применимо)
- Закон України "Про телекомунікації"

## 2. Какие данные собираются

### 2.1 Данные, получаемые автоматически

| Данные | Источник | Цель |
|--------|----------|------|
| Номер телефона (CallerID) | Asterisk PBX | Идентификация клиента, связь с заказом |
| Аудио-поток звонка | AudioSocket | Распознавание речи (STT) |
| Текст речи (транскрипция) | Google STT | Обработка запроса, логирование |

### 2.2 Данные, предоставленные клиентом устно

| Данные | Цель | Обязательность |
|--------|------|----------------|
| Имя | Оформление заказа | При оформлении |
| Адрес доставки | Доставка заказа | При заказе с доставкой |
| Предпочтения (авто, бюджет) | Подбор шин | Добровольно |

### 2.3 Данные, генерируемые системой

| Данные | Цель | Срок хранения |
|--------|------|---------------|
| Транскрипция диалога | Качество, аналитика | 90 дней |
| Метаданные звонка (длительность, сценарий) | Аналитика | 1 год |
| Оценка качества диалога | Улучшение сервиса | 1 год |

## 3. Что НЕ хранится

| Данные | Причина |
|--------|---------|
| **Аудиозапись звонка** | Не записывается и не сохраняется. Аудио обрабатывается в реальном времени (streaming STT) и не попадает на диск. |
| **Данные банковских карт** | Оплата — только наложенный платёж или переадресация на платёжный шлюз. Бот не запрашивает и не обрабатывает карточные данные. |
| **Паспортные данные** | Не запрашиваются, не обрабатываются. |

## 4. Передача данных третьим сторонам

### 4.1 Обработчики данных (processors)

| Сервис | Какие данные | Юрисдикция | Основание |
|--------|-------------|------------|-----------|
| Google Cloud (STT) | Аудио-поток (streaming, не сохраняется Google) | EU / US | Data Processing Agreement |
| Google Cloud (TTS) | Текст ответов (не содержит PII) | EU / US | Data Processing Agreement |
| Anthropic (Claude) | Текст диалога (может содержать имя, адрес) | US | Data Processing Agreement |

### 4.2 Гарантии обработчиков

- **Google Cloud:** [Data Processing Terms](https://cloud.google.com/terms/data-processing-terms) — данные STT не используются для обучения моделей, не хранятся после обработки.
- **Anthropic:** при использовании API данные не используются для обучения моделей (API Terms of Service).

### 4.3 Опции для минимизации передачи

| Мера | Фаза | Эффект |
|------|------|--------|
| Self-hosted Whisper (замена Google STT) | 4 | Аудио не покидает сервер |
| Self-hosted LLM (замена Claude) | Будущее | Текст не покидает сервер |
| Маскирование PII перед отправкой в LLM | 2 | Имена, адреса заменяются плейсхолдерами |

## 5. Хранение данных

### 5.1 Местоположение

| Компонент | Расположение |
|-----------|-------------|
| PostgreSQL (основная БД) | Украина или EU (VPS/dedicated) |
| Redis (кэш сессий) | Тот же сервер |
| Бэкапы | S3-совместимое хранилище (EU) |

**Данные НЕ хранятся в Российской Федерации.**

### 5.2 Сроки хранения

| Тип данных | Срок | Действие по истечении |
|------------|------|----------------------|
| Транскрипции звонков | 90 дней | Автоматическое удаление |
| Метаданные звонков | 1 год | Автоматическое удаление |
| Агрегированная статистика | Бессрочно | Не содержит PII |
| Данные заказов | По требованиям бухгалтерии (3 года) | Архивация |
| Данные клиентов | До запроса на удаление | Удаление по запросу |

### 5.3 Автоматическая очистка

```sql
-- Ежедневный cron-job
DELETE FROM call_turns WHERE created_at < NOW() - INTERVAL '90 days';
DELETE FROM call_tool_calls WHERE created_at < NOW() - INTERVAL '90 days';
UPDATE calls SET caller_id = 'DELETED'
    WHERE started_at < NOW() - INTERVAL '1 year';
```

## 6. Права субъектов данных

### 6.1 Уведомление о записи

В начале каждого звонка бот произносит:

> "Цей дзвінок може оброблятися автоматичною системою з метою покращення якості обслуговування."

### 6.2 Право на доступ

Клиент может запросить (через оператора или веб-форму):
- Историю своих звонков (метаданные)
- Транскрипции своих диалогов (если ещё хранятся)
- Данные своих заказов

### 6.3 Право на удаление

Клиент может запросить полное удаление своих данных:

```
API: DELETE /api/v1/customers/{phone}/data
Результат:
- Удаление записи из customers
- Анонимизация caller_id в calls
- Удаление call_turns и call_tool_calls
- Данные заказов — по требованиям бухгалтерии (могут быть анонимизированы)
```

Срок исполнения: **30 календарных дней** (требование Закона).

### 6.4 Право на отказ от автоматической обработки

Клиент может в любой момент сказать "З'єднайте з оператором" — и бот переключит на живого человека.

## 7. Безопасность данных

| Мера | Реализация |
|------|------------|
| Шифрование в покое | PostgreSQL — encrypted tablespace (при наличии); бэкапы — AES-256 |
| Шифрование в передаче | HTTPS для всех API; gRPC TLS для Google STT |
| Доступ к БД | Только из Docker network; уникальные учётные данные |
| Маскирование PII в логах | Автоматический sanitizer на уровне логгера (см. ниже) |
| Доступ к транскрипциям | Только авторизованные администраторы |
| Аудит доступа | Логирование всех запросов к данным клиентов |

### 7.1 Реестр PII и правила маскирования

| PII-поле | Где встречается | Правило маскирования | Пример |
|----------|----------------|---------------------|--------|
| Номер телефона | caller_id, транскрипции, логи | `+380XX***XXXX` (оставить код оператора) | +38067***1234 |
| ФИО клиента | транскрипции, заказы | `І*** П***` (первая буква + ***) | І*** П*** |
| Адрес доставки | транскрипции, заказы | Не логируется в application logs | — |
| Email | если назван устно | `i***@***.com` | i***@***.com |

### 7.2 Реализация PII Sanitizer

Автоматический sanitizer применяется на уровне логгера ко всем application logs. В БД данные хранятся полностью (для работы системы), но маскируются при экспорте в логи и мониторинг.

```python
import re

class PIISanitizer:
    """Автоматическое маскирование PII перед записью в логи."""

    PHONE_PATTERN = re.compile(r'\+?380\d{9}')
    # Дополнительные паттерны для email, адресов и т.д.

    @classmethod
    def sanitize(cls, text: str) -> str:
        text = cls.PHONE_PATTERN.sub(
            lambda m: m.group()[:6] + '***' + m.group()[-4:],
            text,
        )
        return text
```

- Sanitizer подключается как filter в Python logging
- Все handler-ы (stdout, file, Loki) получают уже маскированные данные
- В PostgreSQL (таблицы calls, call_turns) — данные хранятся без маскирования (нужны для работы)
- При экспорте данных из БД (API аналитики) — PII маскируется на уровне API

## 8. Ответственные лица

| Роль | Ответственность |
|------|-----------------|
| Владелец данных (Data Owner) | Руководство компании |
| Ответственный за защиту данных | Назначается компанией |
| Техническая поддержка | Команда разработки |

## 9. Процедура при утечке данных (Data Breach)

1. **Обнаружение** — мониторинг алертов, аудит доступа
2. **Сдерживание** — изоляция скомпрометированного компонента (< 1 час)
3. **Оценка** — масштаб утечки, затронутые данные и клиенты
4. **Уведомление** — субъекты данных и регулятор (< 72 часа по GDPR)
5. **Устранение** — исправление уязвимости, усиление мер
6. **Отчёт** — документирование инцидента и мер реагирования
