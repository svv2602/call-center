; Call Center AI — Asterisk Dialplan
; AudioSocket: 16kHz, 16-bit signed linear PCM

[incoming]
; All incoming calls — pass CALLED_EXTEN via Redis for DB-based tenant resolution.
; Tenant is resolved by matching extension against tenants.extensions[] in PostgreSQL.
exten => _X.,1,NoOp(AI Call Center: incoming from ${CALLERID(num)} to ${EXTEN})
 same => n,Answer()
 same => n,Set(CALL_UUID=${UUID()})
 same => n,Set(CALLED_EXTEN=${EXTEN})
 same => n,System(curl -s -X POST http://127.0.0.1:8080/internal/caller-id -H 'Content-Type: application/json' -d '{"uuid":"${CALL_UUID}","number":"${CALLERID(num)}","exten":"${CALLED_EXTEN}"}')
 same => n,AudioSocket(${CALL_UUID},127.0.0.1:9092)
 same => n,Hangup()

[ivr-menu]
; IVR menu — set IVR_INTENT before routing to AI agent.
; Configure your SIP trunk to point incoming calls here instead of [incoming]
; if you want callers to choose a scenario via DTMF.
exten => s,1,Answer()
 same => n,Background(ivr-welcome)
 same => n,WaitExten(5)

; 1 — Tire search
exten => 1,1,Set(IVR_INTENT=tire_search)
 same => n,Goto(incoming,${EXTEN},1)

; 2 — Order status
exten => 2,1,Set(IVR_INTENT=order_status)
 same => n,Goto(incoming,${EXTEN},1)

; 3 — Fitting appointment
exten => 3,1,Set(IVR_INTENT=fitting)
 same => n,Goto(incoming,${EXTEN},1)

; 4 — General consultation
exten => 4,1,Set(IVR_INTENT=consultation)
 same => n,Goto(incoming,${EXTEN},1)

; Timeout / invalid — go directly to AI without intent
exten => t,1,Goto(incoming,s,1)
exten => i,1,Goto(incoming,s,1)

[transfer-to-operator]
; Transfer to operator queue (called via ARI redirect)
exten => _X.,1,NoOp(Transfer to operator: ${CALLERID(num)})
 same => n,Queue(operators,t,,,120)
 same => n,VoiceMail(operator@default)
 same => n,Hangup()
