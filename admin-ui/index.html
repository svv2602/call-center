<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Call Center AI â€” Admin</title>
</head>
<body>
    <div class="toast-container" id="toastContainer"></div>

    <!-- Login -->
    <div class="login-container" id="loginContainer">
        <div class="login-form">
            <h1>Call Center AI</h1>
            <div class="error" id="loginError">Invalid credentials</div>
            <input type="text" id="loginUsername" placeholder="Username">
            <input type="password" id="loginPassword" placeholder="Password">
            <button onclick="window._app.login()">Login</button>
        </div>
    </div>

    <!-- App -->
    <div class="app" id="app">
        <button class="hamburger" id="hamburgerBtn" onclick="window._app.toggleSidebar()">&#9776;</button>
        <nav class="sidebar" id="sidebar">
            <h2>Call Center AI</h2>
            <a href="#" onclick="window._app.showPage('dashboard')" class="active" data-page="dashboard">Dashboard</a>
            <a href="#" onclick="window._app.showPage('calls')" data-page="calls">Call Journal</a>
            <a href="#" onclick="window._app.showPage('prompts')" data-page="prompts">Prompts</a>
            <a href="#" onclick="window._app.showPage('knowledge')" data-page="knowledge">Knowledge Base</a>
            <a href="#" onclick="window._app.showPage('operators')" data-page="operators">Operators</a>
            <a href="#" onclick="window._app.showPage('settings')" data-page="settings">System</a>
            <a href="#" onclick="window._app.showPage('users')" data-page="users" class="admin-only">Users</a>
            <a href="#" onclick="window._app.showPage('audit')" data-page="audit" class="admin-only">Audit Log</a>
            <div class="ws-status" id="wsStatus">
                <span class="ws-dot disconnected" id="wsDot"></span>
                <span id="wsLabel">Offline</span>
            </div>
            <span class="logout" onclick="window._app.logout()">Logout</span>
        </nav>

        <div class="main">
            <!-- Dashboard -->
            <div id="page-dashboard">
                <div class="breadcrumbs"><a href="#" onclick="window._app.showPage('dashboard')">Home</a> / Dashboard</div>
                <h1>Dashboard</h1>
                <div class="stats-grid" id="dashboardStats"><div class="loading-overlay"><div class="spinner"></div></div></div>
                <div style="margin-bottom:1rem">
                    <button class="btn" style="background:#059669;color:#fff" onclick="window._pages.dashboard.exportStatsCSV()">Export Stats CSV</button>
                    <button class="btn" style="background:#7c3aed;color:#fff;margin-left:.5rem" onclick="window._pages.dashboard.downloadPdfReport()">Download PDF</button>
                </div>
                <div class="card">
                    <h3>Grafana Real-time</h3>
                    <iframe class="grafana-frame" id="grafanaFrame" src=""></iframe>
                </div>
            </div>

            <!-- Calls -->
            <div id="page-calls" style="display:none">
                <div class="breadcrumbs"><a href="#" onclick="window._app.showPage('dashboard')">Home</a> / Call Journal</div>
                <h1>Call Journal</h1>
                <div class="filters">
                    <input type="date" id="filterDateFrom" placeholder="From">
                    <input type="date" id="filterDateTo" placeholder="To">
                    <select id="filterScenario">
                        <option value="">All scenarios</option>
                        <option value="tire_search">Tire search</option>
                        <option value="availability">Availability</option>
                        <option value="order">Order</option>
                        <option value="fitting">Fitting</option>
                        <option value="consultation">Consultation</option>
                    </select>
                    <select id="filterTransferred">
                        <option value="">All</option>
                        <option value="true">Transferred</option>
                        <option value="false">Resolved by bot</option>
                    </select>
                    <input type="text" id="filterSearch" placeholder="Search transcription...">
                    <input type="number" id="filterQualityBelow" placeholder="Quality below" step="0.1" min="0" max="1">
                    <button onclick="window._pages.calls.loadCalls()">Filter</button>
                    <button class="btn" style="background:#059669;color:#fff" onclick="window._pages.calls.exportCallsCSV()">Export CSV</button>
                </div>
                <div class="card">
                    <div id="callsLoading" class="loading-overlay" style="display:none"><div class="spinner"></div></div>
                    <table id="callsTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Caller</th>
                                <th>Scenario</th>
                                <th>Duration</th>
                                <th>Quality</th>
                                <th>Cost</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                    <div class="pagination" id="callsPagination"></div>
                </div>
            </div>

            <!-- Prompts -->
            <div id="page-prompts" style="display:none">
                <div class="breadcrumbs"><a href="#" onclick="window._app.showPage('dashboard')">Home</a> / Prompts</div>
                <h1>Prompt Management</h1>
                <div class="tab-bar">
                    <button class="active" onclick="window._pages.prompts.showPromptTab('versions', this)">Versions</button>
                    <button onclick="window._pages.prompts.showPromptTab('abtests', this)">A/B Tests</button>
                </div>
                <div id="promptVersions" class="card"></div>
                <div id="promptABTests" class="card" style="display:none"></div>
            </div>

            <!-- Knowledge -->
            <div id="page-knowledge" style="display:none">
                <div class="breadcrumbs"><a href="#" onclick="window._app.showPage('dashboard')">Home</a> / Knowledge Base</div>
                <h1>Knowledge Base</h1>
                <div class="filters">
                    <select id="kbCategory">
                        <option value="">All categories</option>
                        <option value="brands">Brands</option>
                        <option value="guides">Guides</option>
                        <option value="faq">FAQ</option>
                        <option value="comparisons">Comparisons</option>
                    </select>
                    <input type="text" id="kbSearch" placeholder="Search...">
                    <button onclick="window._pages.knowledge.loadArticles()">Filter</button>
                    <button class="btn btn-primary" onclick="window._pages.knowledge.showCreateArticle()">+ New Article</button>
                </div>
                <div class="card" id="articlesContainer"></div>
            </div>

            <!-- Operators -->
            <div id="page-operators" style="display:none">
                <div class="breadcrumbs"><a href="#" onclick="window._app.showPage('dashboard')">Home</a> / Operators</div>
                <h1>Operators</h1>
                <div class="stats-grid" id="operatorQueueStats"></div>
                <div class="filters">
                    <button class="btn btn-primary" onclick="window._pages.operators.showCreateOperator()">+ New Operator</button>
                </div>
                <div class="card">
                    <div id="operatorsLoading" class="loading-overlay" style="display:none"><div class="spinner"></div></div>
                    <table id="operatorsTable">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Extension</th>
                                <th>Status</th>
                                <th>Skills</th>
                                <th>Shift</th>
                                <th>Active</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- System -->
            <div id="page-settings" style="display:none">
                <div class="breadcrumbs"><a href="#" onclick="window._app.showPage('dashboard')">Home</a> / System</div>
                <h1>System Status</h1>
                <div class="card">
                    <h3>Health Check</h3>
                    <div id="systemInfo"><div class="loading-overlay"><div class="spinner"></div></div></div>
                    <button class="btn btn-primary" onclick="window._pages.settings.loadSettings()" style="margin-top:.8rem">Refresh</button>
                </div>
                <div class="card admin-only">
                    <h3>Extended Status</h3>
                    <div id="extendedStatus"><div class="empty-state">Click to load</div></div>
                    <button class="btn btn-primary" onclick="window._pages.settings.loadSystemStatus()" style="margin-top:.8rem">Load Status</button>
                </div>
                <div class="card admin-only">
                    <h3>Configuration</h3>
                    <p style="margin:.5rem 0; font-size:.85rem">Reload safe config parameters (quality, feature flags, logging) without restart.</p>
                    <button class="btn btn-primary" onclick="window._pages.settings.reloadConfig()">Reload Config</button>
                </div>
                <div class="card">
                    <h3>External Tools</h3>
                    <table>
                        <tr><td>Grafana</td><td><a href="http://localhost:3000" target="_blank">Open Grafana</a></td></tr>
                        <tr><td>Prometheus</td><td><a href="http://localhost:9090" target="_blank">Open Prometheus</a></td></tr>
                        <tr><td>Flower (Celery)</td><td><a href="http://localhost:5555" target="_blank">Open Flower</a></td></tr>
                    </table>
                </div>
                <div class="card">
                    <h3>Application Info</h3>
                    <table>
                        <tr><td>Version</td><td>v0.1.0</td></tr>
                    </table>
                </div>
            </div>

            <!-- Users -->
            <div id="page-users" style="display:none">
                <div class="breadcrumbs"><a href="#" onclick="window._app.showPage('dashboard')">Home</a> / Users</div>
                <h1>User Management</h1>
                <div class="filters">
                    <button class="btn btn-primary" onclick="window._pages.users.showCreateUser()">+ New User</button>
                </div>
                <div class="card" id="usersContainer"><div class="loading-overlay"><div class="spinner"></div></div></div>
            </div>

            <!-- Audit Log -->
            <div id="page-audit" style="display:none">
                <div class="breadcrumbs"><a href="#" onclick="window._app.showPage('dashboard')">Home</a> / Audit Log</div>
                <h1>Audit Log</h1>
                <div class="filters">
                    <input type="date" id="auditDateFrom" placeholder="From">
                    <input type="date" id="auditDateTo" placeholder="To">
                    <select id="auditAction">
                        <option value="">All actions</option>
                        <option value="POST">POST</option>
                        <option value="PATCH">PATCH</option>
                        <option value="DELETE">DELETE</option>
                    </select>
                    <button onclick="window._pages.audit.loadAuditLog()">Filter</button>
                </div>
                <div class="card" id="auditContainer"><div class="loading-overlay"><div class="spinner"></div></div></div>
                <div class="pagination" id="auditPagination"></div>
            </div>
        </div>
    </div>

    <!-- Create User Modal -->
    <div class="modal-overlay" id="createUserModal">
        <div class="modal">
            <span class="close" onclick="window._app.closeModal('createUserModal')">&times;</span>
            <h2>Create New User</h2>
            <div class="form-group">
                <label>Username</label>
                <input type="text" id="newUsername" placeholder="username">
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="newPassword" placeholder="password">
            </div>
            <div class="form-group">
                <label>Role</label>
                <select id="newRole">
                    <option value="operator">Operator</option>
                    <option value="analyst">Analyst</option>
                    <option value="admin">Admin</option>
                </select>
            </div>
            <button class="btn btn-primary" onclick="window._pages.users.createUser()">Create</button>
        </div>
    </div>

    <!-- Call Detail Modal -->
    <div class="modal-overlay" id="callModal">
        <div class="modal">
            <span class="close" onclick="window._pages.calls.closeCallModal()">&times;</span>
            <h2>Call Details</h2>
            <div id="callDetailContent"></div>
        </div>
    </div>

    <!-- Create Prompt Modal -->
    <div class="modal-overlay" id="createPromptModal">
        <div class="modal">
            <span class="close" onclick="window._app.closeModal('createPromptModal')">&times;</span>
            <h2>Create New Prompt Version</h2>
            <div class="form-group">
                <label>Name</label>
                <input type="text" id="promptName" placeholder="e.g. v2.0-improved-search">
            </div>
            <div class="form-group">
                <label>System Prompt</label>
                <textarea id="promptSystemPrompt" placeholder="Enter system prompt text..."></textarea>
            </div>
            <button class="btn btn-primary" onclick="window._pages.prompts.createPrompt()">Create</button>
        </div>
    </div>

    <!-- Create/Edit Article Modal -->
    <div class="modal-overlay" id="createArticleModal">
        <div class="modal">
            <span class="close" onclick="window._app.closeModal('createArticleModal')">&times;</span>
            <h2 id="articleModalTitle">New Article</h2>
            <input type="hidden" id="editArticleId">
            <div class="form-group">
                <label>Title</label>
                <input type="text" id="articleTitle" placeholder="Article title">
            </div>
            <div class="form-group">
                <label>Category</label>
                <select id="articleCategory">
                    <option value="brands">Brands</option>
                    <option value="guides">Guides</option>
                    <option value="faq">FAQ</option>
                    <option value="comparisons">Comparisons</option>
                </select>
            </div>
            <div class="form-group">
                <label>Content (Markdown)</label>
                <textarea id="articleContent" placeholder="Article content in Markdown..."></textarea>
            </div>
            <button class="btn btn-primary" onclick="window._pages.knowledge.saveArticle()">Save</button>
        </div>
    </div>

    <!-- Create/Edit Operator Modal -->
    <div class="modal-overlay" id="operatorModal">
        <div class="modal">
            <span class="close" onclick="window._app.closeModal('operatorModal')">&times;</span>
            <h2 id="operatorModalTitle">New Operator</h2>
            <input type="hidden" id="editOperatorId">
            <div class="form-group">
                <label>Name</label>
                <input type="text" id="operatorName" placeholder="Full name">
            </div>
            <div class="form-group">
                <label>Extension (SIP)</label>
                <input type="text" id="operatorExtension" placeholder="e.g. 101">
            </div>
            <div class="form-group">
                <label>Skills (comma-separated)</label>
                <input type="text" id="operatorSkills" placeholder="tires, orders, fitting">
            </div>
            <div class="form-group">
                <label>Shift Start</label>
                <input type="time" id="operatorShiftStart" value="09:00">
            </div>
            <div class="form-group">
                <label>Shift End</label>
                <input type="time" id="operatorShiftEnd" value="18:00">
            </div>
            <button class="btn btn-primary" onclick="window._pages.operators.saveOperator()">Save</button>
        </div>
    </div>

    <script type="module" src="/src/main.js"></script>
</body>
</html>
