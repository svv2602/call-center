(function(){const a=document.createElement("link").relList;if(a&&a.supports&&a.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))n(o);new MutationObserver(o=>{for(const i of o)if(i.type==="childList")for(const d of i.addedNodes)d.tagName==="LINK"&&d.rel==="modulepreload"&&n(d)}).observe(document,{childList:!0,subtree:!0});function s(o){const i={};return o.integrity&&(i.integrity=o.integrity),o.referrerPolicy&&(i.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?i.credentials="include":o.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function n(o){if(o.ep)return;o.ep=!0;const i=s(o);fetch(o.href,i)}})();function l(t,a="success"){const s=document.getElementById("toastContainer"),n=document.createElement("div"),o=a==="error"?"bg-red-600":"bg-emerald-600";n.className=`toast px-4 py-2.5 rounded-lg text-sm text-white shadow-lg ${o}`,n.textContent=t,s.appendChild(n),setTimeout(()=>n.remove(),4e3)}const Xe={"common.retry":"Повторить","common.save":"Сохранить","common.create":"Создать","common.edit":"Редактировать","common.delete":"Удалить","common.filter":"Фильтровать","common.yes":"Да","common.no":"Нет","common.loading":"Загрузка...","common.failedToLoad":"Ошибка загрузки: {error}","common.activate":"Активировать","common.deactivate":"Деактивировать","login.title":"Call Center AI","login.error":"Неверные учётные данные","login.username":"Имя пользователя","login.password":"Пароль","login.submit":"Войти","nav.dashboard":"Дашборд","nav.calls":"Журнал звонков","nav.training":"Обучение агента","nav.operators":"Операторы","nav.system":"Система","nav.users":"Пользователи","nav.audit":"Аудит","nav.logout":"Выход","theme.dark":"Тёмная","theme.light":"Светлая","ws.live":"Онлайн","ws.reconnecting":"Переподключение...","ws.offline":"Оффлайн","api.sessionExpired":"Сессия истекла. Пожалуйста, войдите снова.","api.unauthorized":"Не авторизован","dashboard.breadcrumb":"Дашборд","dashboard.title":"Дашборд","dashboard.callsToday":"Звонков сегодня","dashboard.resolvedByBot":"Решено ботом","dashboard.transferred":"Переведено","dashboard.avgQuality":"Средн. качество","dashboard.costToday":"Стоимость сегодня","dashboard.exportCSV":"Экспорт CSV","dashboard.downloadPDF":"Скачать PDF","dashboard.grafana":"Grafana в реальном времени","dashboard.csvExported":"CSV экспортирован","dashboard.exportFailed":"Ошибка экспорта: {error}","dashboard.pdfDownloaded":"PDF-отчёт скачан","dashboard.pdfFailed":"Ошибка скачивания PDF: {error}","dashboard.failedToLoad":"Не удалось загрузить дашборд: {error}","calls.breadcrumb":"Журнал звонков","calls.title":"Журнал звонков","calls.allScenarios":"Все сценарии","calls.tireSearch":"Поиск шин","calls.availability":"Наличие","calls.order":"Заказ","calls.fitting":"Шиномонтаж","calls.consultation":"Консультация","calls.all":"Все","calls.transferred":"Переведено","calls.resolvedByBot":"Решено ботом","calls.searchPlaceholder":"Поиск в транскрипции...","calls.qualityBelow":"Качество ниже","calls.exportCSV":"Экспорт CSV","calls.csvExported":"CSV экспортирован","calls.exportFailed":"Ошибка экспорта: {error}","calls.noCalls":"Звонки не найдены","calls.failedToLoad":"Не удалось загрузить звонки: {error}","calls.date":"Дата","calls.caller":"Звонящий","calls.scenario":"Сценарий","calls.duration":"Длительность","calls.quality":"Качество","calls.cost":"Стоимость","calls.status":"Статус","calls.statusTransferred":"Переведён","calls.statusResolved":"Решён","calls.detailTitle":"Детали звонка","calls.detailCaller":"Звонящий:","calls.detailScenario":"Сценарий:","calls.detailDuration":"Длительность:","calls.detailQuality":"Качество:","calls.detailCost":"Стоимость:","calls.detailPrompt":"Промпт:","calls.qualityBreakdown":"Разбивка качества","calls.transcription":"Транскрипция","calls.noTranscription":"Транскрипция недоступна","calls.customer":"Клиент","calls.bot":"Бот","calls.toolCalls":"Вызовы инструментов","calls.toolName":"Инструмент","calls.toolSuccess":"Успех","calls.toolDuration":"Длительность","calls.failedToLoadDetail":"Не удалось загрузить детали звонка: {error}","prompts.breadcrumb":"Промпты","prompts.title":"Управление промптами","prompts.versions":"Версии","prompts.abTests":"A/B-тесты","prompts.newVersion":"+ Новая версия","prompts.noVersions":"Версии промптов не найдены","prompts.name":"Название","prompts.active":"Активный","prompts.activeLabel":"Активен","prompts.created":"Создан","prompts.action":"Действие","prompts.activateBtn":"Активировать","prompts.failedToLoad":"Не удалось загрузить промпты: {error}","prompts.createTitle":"Создание новой версии промпта","prompts.nameLabel":"Название","prompts.namePlaceholder":"напр. v2.0-improved-search","prompts.systemPromptLabel":"Системный промпт","prompts.systemPromptPlaceholder":"Введите текст системного промпта...","prompts.nameRequired":"Название и системный промпт обязательны","prompts.created_toast":"Версия промпта создана","prompts.createFailed":"Не удалось создать промпт: {error}","prompts.activateConfirm":"Активировать эту версию промпта? Все звонки будут использовать её.","prompts.activated":"Версия промпта активирована","prompts.activateFailed":"Не удалось активировать промпт: {error}","prompts.noABTests":"A/B-тесты не найдены","prompts.testName":"Тест","prompts.variantA":"Вариант A","prompts.variantB":"Вариант B","prompts.callsAB":"Звонки A/B","prompts.qualityAB":"Качество A/B","prompts.abStatus":"Статус","prompts.abAction":"Действие","prompts.stopBtn":"Остановить","prompts.stopConfirm":"Остановить этот A/B-тест?","prompts.stopped":"A/B-тест остановлен","prompts.stopFailed":"Не удалось остановить тест: {error}","prompts.failedToLoadAB":"Не удалось загрузить A/B-тесты: {error}","knowledge.breadcrumb":"База знаний","knowledge.title":"База знаний","knowledge.allCategories":"Все категории","knowledge.searchPlaceholder":"Поиск...","knowledge.newArticle":"+ Новая статья","knowledge.reindexAll":"Переиндексировать всё","knowledge.importDocuments":"Импорт документов","knowledge.noArticles":"Статьи не найдены","knowledge.articleTitle":"Название","knowledge.category":"Категория","knowledge.embedding":"Эмбеддинг","knowledge.activeCol":"Активен","knowledge.updated":"Обновлён","knowledge.actions":"Действия","knowledge.editBtn":"Ред.","knowledge.reindexBtn":"Переиндекс.","knowledge.deleteBtn":"Удалить","knowledge.total":"Всего: {count} статей","knowledge.failedToLoad":"Не удалось загрузить статьи: {error}","knowledge.newArticleTitle":"Новая статья","knowledge.editArticleTitle":"Редактирование статьи","knowledge.titleLabel":"Название","knowledge.titlePlaceholder":"Название статьи","knowledge.categoryLabel":"Категория","knowledge.contentLabel":"Содержание (Markdown)","knowledge.contentPlaceholder":"Содержание статьи в формате Markdown...","knowledge.titleRequired":"Название и содержание обязательны","knowledge.articleUpdated":"Статья обновлена","knowledge.articleCreated":"Статья создана","knowledge.saveFailed":"Не удалось сохранить статью: {error}","knowledge.articleDeactivated":"Статья деактивирована","knowledge.articleActivated":"Статья активирована","knowledge.toggleFailed":"Не удалось обновить статью: {error}","knowledge.deleteConfirm":'Удалить статью "{title}"?',"knowledge.articleDeleted":"Статья удалена","knowledge.deleteFailed":"Не удалось удалить статью: {error}","knowledge.reindexQueued":"Переиндексация поставлена в очередь","knowledge.reindexFailed":"Ошибка переиндексации: {error}","knowledge.reindexAllConfirm":"Переиндексировать все статьи? Это может занять время.","knowledge.reindexAllDispatched":"Переиндексация всех статей запущена","knowledge.reindexAllFailed":"Ошибка переиндексации: {error}","knowledge.loadFailed":"Не удалось загрузить статью: {error}","knowledge.importTitle":"Импорт документов","knowledge.importFilesLabel":"Файлы (MD, PDF, DOCX)","knowledge.importCategoryLabel":"Категория (необязательно, авто-определение если пусто)","knowledge.importAutoDetect":"Авто-определение по имени файла","knowledge.importBtn":"Импортировать","knowledge.importNoFiles":"Пожалуйста, выберите файлы для импорта","knowledge.importResult":"Импортировано: {imported}","knowledge.importErrors":"Ошибки: {errors}","knowledge.importFailed":"Ошибка импорта: {error}","operators.breadcrumb":"Операторы","operators.title":"Операторы","operators.online":"Операторов онлайн","operators.transfers1h":"Переводов (1ч)","operators.queueUnavailable":"Статус очереди недоступен","operators.newOperator":"+ Новый оператор","operators.noOperators":"Операторы не найдены","operators.name":"Имя","operators.extension":"Внутр. номер","operators.status":"Статус","operators.skills":"Навыки","operators.shift":"Смена","operators.activeCol":"Активен","operators.actionsCol":"Действия","operators.statusSelect":"Статус...","operators.statusOnline":"Онлайн","operators.statusOffline":"Оффлайн","operators.statusBusy":"Занят","operators.statusBreak":"Перерыв","operators.editBtn":"Ред.","operators.deactivateBtn":"Деактив.","operators.failedToLoad":"Не удалось загрузить операторов: {error}","operators.newOperatorTitle":"Новый оператор","operators.editOperatorTitle":"Редактирование оператора","operators.nameLabel":"Имя","operators.namePlaceholder":"ФИО","operators.extensionLabel":"Внутр. номер (SIP)","operators.extensionPlaceholder":"напр. 101","operators.skillsLabel":"Навыки (через запятую)","operators.skillsPlaceholder":"шины, заказы, шиномонтаж","operators.shiftStartLabel":"Начало смены","operators.shiftEndLabel":"Конец смены","operators.nameRequired":"Имя и внутр. номер обязательны","operators.operatorUpdated":"Оператор обновлён","operators.operatorCreated":"Оператор создан","operators.saveFailed":"Не удалось сохранить оператора: {error}","operators.statusChanged":"Статус изменён на {status}","operators.statusFailed":"Не удалось изменить статус: {error}","operators.deactivateConfirm":'Деактивировать оператора "{name}"?',"operators.operatorDeactivated":"Оператор деактивирован","operators.deactivateFailed":"Не удалось деактивировать: {error}","operators.notFound":"Оператор не найден","operators.loadFailed":"Не удалось загрузить оператора: {error}","settings.breadcrumb":"Система","settings.title":"Статус системы","settings.healthCheck":"Проверка здоровья","settings.refresh":"Обновить","settings.extendedStatus":"Расширенный статус","settings.clickToLoad":"Нажмите для загрузки","settings.loadStatus":"Загрузить статус","settings.configuration":"Конфигурация","settings.configDescription":"Перезагрузить безопасные параметры конфигурации (качество, фича-флаги, логирование) без перезапуска.","settings.reloadConfig":"Перезагрузить конфиг","settings.externalTools":"Внешние инструменты","settings.openGrafana":"Открыть Grafana","settings.openPrometheus":"Открыть Prometheus","settings.openFlower":"Открыть Flower","settings.appInfo":"Информация о приложении","settings.version":"Версия","settings.status":"Статус","settings.activeCalls":"Активные звонки","settings.redis":"Redis","settings.storeAPI":"Store API","settings.claudeAPI":"Claude API","settings.googleSTT":"Google STT","settings.ttsEngine":"TTS Engine","settings.failedToLoad":"Не удалось загрузить системную информацию: {error}","settings.extVersion":"Версия","settings.uptime":"Аптайм","settings.uptimeValue":"{hours}ч {minutes}м","settings.pgDbSize":"Размер БД PostgreSQL","settings.pgConnections":"Подключения PostgreSQL","settings.redisMemory":"Память Redis","settings.celeryWorkers":"Celery workers","settings.lastBackup":"Последний бэкап","settings.extFailed":"Ошибка: {error}","settings.reloadConfirm":"Перезагрузить конфигурацию из окружения?","settings.configReloaded":`Конфигурация перезагружена:
`,"settings.reloadFailed":"Ошибка перезагрузки: {error}","users.breadcrumb":"Пользователи","users.title":"Управление пользователями","users.newUser":"+ Новый пользователь","users.noUsers":"Пользователи не найдены","users.username":"Имя пользователя","users.role":"Роль","users.activeCol":"Активен","users.lastLogin":"Последний вход","users.actionsCol":"Действия","users.changeRole":"Изменить роль...","users.roleAdmin":"Админ","users.roleAnalyst":"Аналитик","users.roleOperator":"Оператор","users.resetPwd":"Сброс пароля","users.failedToLoad":"Не удалось загрузить пользователей: {error}","users.createTitle":"Создание нового пользователя","users.usernameLabel":"Имя пользователя","users.usernamePlaceholder":"имя пользователя","users.passwordLabel":"Пароль","users.passwordPlaceholder":"пароль","users.roleLabel":"Роль","users.usernameRequired":"Имя пользователя и пароль обязательны","users.userCreated":"Пользователь создан","users.createFailed":"Не удалось создать пользователя: {error}","users.roleUpdated":"Роль обновлена","users.roleFailed":"Не удалось обновить роль: {error}","users.userDeactivated":"Пользователь деактивирован","users.userActivated":"Пользователь активирован","users.toggleFailed":"Не удалось обновить пользователя: {error}","users.newPasswordPrompt":"Новый пароль для {username}:","users.passwordReset":"Пароль сброшен","users.resetFailed":"Не удалось сбросить пароль: {error}","training.breadcrumb":"Обучение агента","training.title":"Обучение агента","training.tabPrompts":"Промпты","training.tabKnowledge":"База знаний","training.tabTemplates":"Шаблоны ответов","training.tabDialogues":"Сценарии диалогов","training.tabSafety":"Правила безопасности","training.tabTools":"Инструменты","training.activeCol":"Активен","training.actions":"Действия","training.loadFailed":"Не удалось загрузить: {error}","training.saveFailed":"Не удалось сохранить: {error}","training.deleteFailed":"Не удалось удалить: {error}","training.deleteConfirm":'Удалить "{title}"?',"training.titleRequired":"Название обязательно","training.titleContentRequired":"Название и содержание обязательны","training.fieldsRequired":"Все обязательные поля должны быть заполнены","training.keyRequired":"Ключ шаблона обязателен","training.newTemplate":"+ Новый шаблон","training.editTemplate":"Редактирование шаблона","training.addVariantTitle":"Добавить вариант ответа","training.noTemplates":"Шаблоны не найдены","training.templateKey":"Ключ","training.templateTitle":"Название","training.content":"Содержание","training.description":"Описание","training.templateSaved":"Шаблон сохранён","training.addVariant":"+ Вариант","training.variantCount":"вар.","training.variantsHint":"Несколько вариантов на ключ — агент выбирает случайный при каждом звонке","training.deleteVariantConfirm":'Удалить вариант "{title}"?',"training.variantDeleted":"Вариант удалён","training.newDialogue":"+ Новый сценарий","training.editDialogue":"Редактирование сценария","training.noDialogues":"Сценарии не найдены","training.dialogueTitle":"Название","training.dialogueTitlePlaceholder":"Название сценария","training.scenario":"Сценарий","training.phase":"Фаза","training.tools":"Инструменты","training.dialogueJSON":"Диалог (JSON)","training.invalidJSON":"Некорректный JSON","training.dialogueSaved":"Сценарий сохранён","training.dialogueDeleted":"Сценарий удалён","training.newSafetyRule":"+ Новое правило","training.editSafetyRule":"Редактирование правила","training.noSafetyRules":"Правила не найдены","training.ruleTitle":"Название","training.ruleType":"Тип правила","training.severity":"Серьёзность","training.triggerInput":"Триггер (ввод клиента)","training.expectedBehavior":"Ожидаемое поведение","training.safetyRuleSaved":"Правило сохранено","training.safetyRuleDeleted":"Правило удалено","training.toolName":"Инструмент","training.override":"Переопределение","training.overridden":"Переопределён","training.default":"По умолчанию","training.editTool":"Редактирование инструмента","training.originalDescription":"Описание по умолчанию","training.overrideDescription":"Переопределённое описание","training.descriptionRequired":"Описание обязательно","training.toolOverrideSaved":"Переопределение сохранено","training.toolOverrideReset":"Переопределение сброшено","training.reset":"Сбросить","training.resetConfirm":"Сбросить переопределение для {name}?","training.resetFailed":"Не удалось сбросить: {error}","training.toolNotFound":"Инструмент не найден","nav.vehicles":"База авто","vehicles.breadcrumb":"База авто","vehicles.title":"База автомобилей","vehicles.searchPlaceholder":"Поиск по названию...","vehicles.brands":"Марки","vehicles.models":"Модели","vehicles.kits":"Комплектации","vehicles.tireSizes":"Размеры шин","vehicles.lastImport":"Последний импорт","vehicles.brand":"Марка","vehicles.model":"Модель","vehicles.year":"Год","vehicles.trim":"Комплектация","vehicles.pcd":"PCD","vehicles.bolts":"Болты","vehicles.dia":"DIA","vehicles.size":"Размер","vehicles.type":"Тип","vehicles.axle":"Ось","vehicles.stock":"Заводской","vehicles.tuning":"Тюнинг","vehicles.front":"Перед","vehicles.rear":"Зад","vehicles.all":"Все","vehicles.back":"← Назад","vehicles.noData":"Нет данных","vehicles.failedToLoad":"Не удалось загрузить: {error}","vehicles.neverImported":"Импорт не выполнялся","vehicles.importButton":"Обновить БД","vehicles.importTitle":"Обновление базы автомобилей","vehicles.importInstructions":"Разместите 4 CSV-файла в директории на сервере:","vehicles.importWarning":"Импорт удалит текущие данные и загрузит новые. Операция занимает ~30-60 секунд.","vehicles.importPathLabel":"Путь к директории с CSV","vehicles.importPathRequired":"Укажите путь к директории","vehicles.importBtn":"Импортировать","vehicles.importSuccess":"Импорт завершён: {brands} марок, {models} моделей, {kits} комплектаций, {tireSizes} размеров шин","vehicles.importFailed":"Ошибка импорта: {error}","common.search":"Поиск","audit.breadcrumb":"Аудит","audit.title":"Журнал аудита","audit.allActions":"Все действия","audit.noEntries":"Записи аудита не найдены","audit.date":"Дата","audit.user":"Пользователь","audit.action":"Действие","audit.resource":"Ресурс","audit.ip":"IP","audit.failedToLoad":"Не удалось загрузить журнал аудита: {error}"},Ze={"common.retry":"Retry","common.save":"Save","common.create":"Create","common.edit":"Edit","common.delete":"Delete","common.filter":"Filter","common.yes":"Yes","common.no":"No","common.loading":"Loading...","common.failedToLoad":"Failed to load: {error}","common.activate":"Activate","common.deactivate":"Deactivate","login.title":"Call Center AI","login.error":"Invalid credentials","login.username":"Username","login.password":"Password","login.submit":"Login","nav.dashboard":"Dashboard","nav.calls":"Call Journal","nav.training":"Agent Training","nav.operators":"Operators","nav.system":"System","nav.users":"Users","nav.audit":"Audit Log","nav.logout":"Logout","theme.dark":"Dark","theme.light":"Light","ws.live":"Live","ws.reconnecting":"Reconnecting...","ws.offline":"Offline","api.sessionExpired":"Session expired. Please login again.","api.unauthorized":"Unauthorized","dashboard.breadcrumb":"Dashboard","dashboard.title":"Dashboard","dashboard.callsToday":"Calls today","dashboard.resolvedByBot":"Resolved by bot","dashboard.transferred":"Transferred","dashboard.avgQuality":"Avg quality","dashboard.costToday":"Cost today","dashboard.exportCSV":"Export Stats CSV","dashboard.downloadPDF":"Download PDF","dashboard.grafana":"Grafana Real-time","dashboard.csvExported":"CSV exported","dashboard.exportFailed":"Export failed: {error}","dashboard.pdfDownloaded":"PDF report downloaded","dashboard.pdfFailed":"PDF download failed: {error}","dashboard.failedToLoad":"Failed to load dashboard: {error}","calls.breadcrumb":"Call Journal","calls.title":"Call Journal","calls.allScenarios":"All scenarios","calls.tireSearch":"Tire search","calls.availability":"Availability","calls.order":"Order","calls.fitting":"Fitting","calls.consultation":"Consultation","calls.all":"All","calls.transferred":"Transferred","calls.resolvedByBot":"Resolved by bot","calls.searchPlaceholder":"Search transcription...","calls.qualityBelow":"Quality below","calls.exportCSV":"Export CSV","calls.csvExported":"CSV exported","calls.exportFailed":"Export failed: {error}","calls.noCalls":"No calls found","calls.failedToLoad":"Failed to load calls: {error}","calls.date":"Date","calls.caller":"Caller","calls.scenario":"Scenario","calls.duration":"Duration","calls.quality":"Quality","calls.cost":"Cost","calls.status":"Status","calls.statusTransferred":"Transferred","calls.statusResolved":"Resolved","calls.detailTitle":"Call Details","calls.detailCaller":"Caller:","calls.detailScenario":"Scenario:","calls.detailDuration":"Duration:","calls.detailQuality":"Quality:","calls.detailCost":"Cost:","calls.detailPrompt":"Prompt:","calls.qualityBreakdown":"Quality Breakdown","calls.transcription":"Transcription","calls.noTranscription":"No transcription available","calls.customer":"Customer","calls.bot":"Bot","calls.toolCalls":"Tool Calls","calls.toolName":"Tool","calls.toolSuccess":"Success","calls.toolDuration":"Duration","calls.failedToLoadDetail":"Failed to load call details: {error}","prompts.breadcrumb":"Prompts","prompts.title":"Prompt Management","prompts.versions":"Versions","prompts.abTests":"A/B Tests","prompts.newVersion":"+ New Version","prompts.noVersions":"No prompt versions found","prompts.name":"Name","prompts.active":"Active","prompts.activeLabel":"Active","prompts.created":"Created","prompts.action":"Action","prompts.activateBtn":"Activate","prompts.failedToLoad":"Failed to load prompts: {error}","prompts.createTitle":"Create New Prompt Version","prompts.nameLabel":"Name","prompts.namePlaceholder":"e.g. v2.0-improved-search","prompts.systemPromptLabel":"System Prompt","prompts.systemPromptPlaceholder":"Enter system prompt text...","prompts.nameRequired":"Name and system prompt are required","prompts.created_toast":"Prompt version created","prompts.createFailed":"Failed to create prompt: {error}","prompts.activateConfirm":"Activate this prompt version? All calls will use it.","prompts.activated":"Prompt version activated","prompts.activateFailed":"Failed to activate prompt: {error}","prompts.noABTests":"No A/B tests found","prompts.testName":"Test","prompts.variantA":"Variant A","prompts.variantB":"Variant B","prompts.callsAB":"Calls A/B","prompts.qualityAB":"Quality A/B","prompts.abStatus":"Status","prompts.abAction":"Action","prompts.stopBtn":"Stop","prompts.stopConfirm":"Stop this A/B test?","prompts.stopped":"A/B test stopped","prompts.stopFailed":"Failed to stop test: {error}","prompts.failedToLoadAB":"Failed to load A/B tests: {error}","knowledge.breadcrumb":"Knowledge Base","knowledge.title":"Knowledge Base","knowledge.allCategories":"All categories","knowledge.searchPlaceholder":"Search...","knowledge.newArticle":"+ New Article","knowledge.reindexAll":"Reindex All","knowledge.importDocuments":"Import Documents","knowledge.noArticles":"No articles found","knowledge.articleTitle":"Title","knowledge.category":"Category","knowledge.embedding":"Embedding","knowledge.activeCol":"Active","knowledge.updated":"Updated","knowledge.actions":"Actions","knowledge.editBtn":"Edit","knowledge.reindexBtn":"Reindex","knowledge.deleteBtn":"Delete","knowledge.total":"Total: {count} articles","knowledge.failedToLoad":"Failed to load articles: {error}","knowledge.newArticleTitle":"New Article","knowledge.editArticleTitle":"Edit Article","knowledge.titleLabel":"Title","knowledge.titlePlaceholder":"Article title","knowledge.categoryLabel":"Category","knowledge.contentLabel":"Content (Markdown)","knowledge.contentPlaceholder":"Article content in Markdown...","knowledge.titleRequired":"Title and content are required","knowledge.articleUpdated":"Article updated","knowledge.articleCreated":"Article created","knowledge.saveFailed":"Failed to save article: {error}","knowledge.articleDeactivated":"Article deactivated","knowledge.articleActivated":"Article activated","knowledge.toggleFailed":"Failed to update article: {error}","knowledge.deleteConfirm":'Delete article "{title}"?',"knowledge.articleDeleted":"Article deleted","knowledge.deleteFailed":"Failed to delete article: {error}","knowledge.reindexQueued":"Reindex queued","knowledge.reindexFailed":"Reindex failed: {error}","knowledge.reindexAllConfirm":"Reindex all articles? This may take a while.","knowledge.reindexAllDispatched":"Reindex-all dispatched","knowledge.reindexAllFailed":"Reindex-all failed: {error}","knowledge.loadFailed":"Failed to load article: {error}","knowledge.importTitle":"Import Documents","knowledge.importFilesLabel":"Files (MD, PDF, DOCX)","knowledge.importCategoryLabel":"Category (optional, auto-detect if empty)","knowledge.importAutoDetect":"Auto-detect from filename","knowledge.importBtn":"Import","knowledge.importNoFiles":"Please select files to import","knowledge.importResult":"Imported: {imported}","knowledge.importErrors":"Errors: {errors}","knowledge.importFailed":"Import failed: {error}","operators.breadcrumb":"Operators","operators.title":"Operators","operators.online":"Operators Online","operators.transfers1h":"Transfers (1h)","operators.queueUnavailable":"Queue status unavailable","operators.newOperator":"+ New Operator","operators.noOperators":"No operators found","operators.name":"Name","operators.extension":"Extension","operators.status":"Status","operators.skills":"Skills","operators.shift":"Shift","operators.activeCol":"Active","operators.actionsCol":"Actions","operators.statusSelect":"Status...","operators.statusOnline":"Online","operators.statusOffline":"Offline","operators.statusBusy":"Busy","operators.statusBreak":"Break","operators.editBtn":"Edit","operators.deactivateBtn":"Deactivate","operators.failedToLoad":"Failed to load operators: {error}","operators.newOperatorTitle":"New Operator","operators.editOperatorTitle":"Edit Operator","operators.nameLabel":"Name","operators.namePlaceholder":"Full name","operators.extensionLabel":"Extension (SIP)","operators.extensionPlaceholder":"e.g. 101","operators.skillsLabel":"Skills (comma-separated)","operators.skillsPlaceholder":"tires, orders, fitting","operators.shiftStartLabel":"Shift Start","operators.shiftEndLabel":"Shift End","operators.nameRequired":"Name and extension are required","operators.operatorUpdated":"Operator updated","operators.operatorCreated":"Operator created","operators.saveFailed":"Failed to save operator: {error}","operators.statusChanged":"Status changed to {status}","operators.statusFailed":"Failed to change status: {error}","operators.deactivateConfirm":'Deactivate operator "{name}"?',"operators.operatorDeactivated":"Operator deactivated","operators.deactivateFailed":"Failed to deactivate: {error}","operators.notFound":"Operator not found","operators.loadFailed":"Failed to load operator: {error}","settings.breadcrumb":"System","settings.title":"System Status","settings.healthCheck":"Health Check","settings.refresh":"Refresh","settings.extendedStatus":"Extended Status","settings.clickToLoad":"Click to load","settings.loadStatus":"Load Status","settings.configuration":"Configuration","settings.configDescription":"Reload safe config parameters (quality, feature flags, logging) without restart.","settings.reloadConfig":"Reload Config","settings.externalTools":"External Tools","settings.openGrafana":"Open Grafana","settings.openPrometheus":"Open Prometheus","settings.openFlower":"Open Flower","settings.appInfo":"Application Info","settings.version":"Version","settings.status":"Status","settings.activeCalls":"Active calls","settings.redis":"Redis","settings.storeAPI":"Store API","settings.claudeAPI":"Claude API","settings.googleSTT":"Google STT","settings.ttsEngine":"TTS Engine","settings.failedToLoad":"Failed to load system info: {error}","settings.extVersion":"Version","settings.uptime":"Uptime","settings.uptimeValue":"{hours}h {minutes}m","settings.pgDbSize":"PostgreSQL DB size","settings.pgConnections":"PostgreSQL connections","settings.redisMemory":"Redis memory","settings.celeryWorkers":"Celery workers","settings.lastBackup":"Last backup","settings.extFailed":"Failed: {error}","settings.reloadConfirm":"Reload configuration from environment?","settings.configReloaded":`Config reloaded:
`,"settings.reloadFailed":"Reload failed: {error}","users.breadcrumb":"Users","users.title":"User Management","users.newUser":"+ New User","users.noUsers":"No users found","users.username":"Username","users.role":"Role","users.activeCol":"Active","users.lastLogin":"Last Login","users.actionsCol":"Actions","users.changeRole":"Change role...","users.roleAdmin":"Admin","users.roleAnalyst":"Analyst","users.roleOperator":"Operator","users.resetPwd":"Reset pwd","users.failedToLoad":"Failed to load users: {error}","users.createTitle":"Create New User","users.usernameLabel":"Username","users.usernamePlaceholder":"username","users.passwordLabel":"Password","users.passwordPlaceholder":"password","users.roleLabel":"Role","users.usernameRequired":"Username and password are required","users.userCreated":"User created","users.createFailed":"Failed to create user: {error}","users.roleUpdated":"Role updated","users.roleFailed":"Failed to update role: {error}","users.userDeactivated":"User deactivated","users.userActivated":"User activated","users.toggleFailed":"Failed to update user: {error}","users.newPasswordPrompt":"New password for {username}:","users.passwordReset":"Password reset","users.resetFailed":"Failed to reset password: {error}","training.breadcrumb":"Agent Training","training.title":"Agent Training","training.tabPrompts":"Prompts","training.tabKnowledge":"Knowledge Base","training.tabTemplates":"Response Templates","training.tabDialogues":"Dialogue Scenarios","training.tabSafety":"Safety Rules","training.tabTools":"Tools","training.activeCol":"Active","training.actions":"Actions","training.loadFailed":"Failed to load: {error}","training.saveFailed":"Failed to save: {error}","training.deleteFailed":"Failed to delete: {error}","training.deleteConfirm":'Delete "{title}"?',"training.titleRequired":"Title is required","training.titleContentRequired":"Title and content are required","training.fieldsRequired":"All required fields must be filled","training.keyRequired":"Template key is required","training.newTemplate":"+ New Template","training.editTemplate":"Edit Template","training.addVariantTitle":"Add Response Variant","training.noTemplates":"No templates found","training.templateKey":"Key","training.templateTitle":"Title","training.content":"Content","training.description":"Description","training.templateSaved":"Template saved","training.addVariant":"+ Variant","training.variantCount":"var.","training.variantsHint":"Multiple variants per key — agent randomly picks one for each call","training.deleteVariantConfirm":'Delete variant "{title}"?',"training.variantDeleted":"Variant deleted","training.newDialogue":"+ New Scenario","training.editDialogue":"Edit Scenario","training.noDialogues":"No scenarios found","training.dialogueTitle":"Title","training.dialogueTitlePlaceholder":"Scenario title","training.scenario":"Scenario","training.phase":"Phase","training.tools":"Tools","training.dialogueJSON":"Dialogue (JSON)","training.invalidJSON":"Invalid JSON","training.dialogueSaved":"Scenario saved","training.dialogueDeleted":"Scenario deleted","training.newSafetyRule":"+ New Rule","training.editSafetyRule":"Edit Safety Rule","training.noSafetyRules":"No safety rules found","training.ruleTitle":"Title","training.ruleType":"Rule Type","training.severity":"Severity","training.triggerInput":"Trigger (customer input)","training.expectedBehavior":"Expected Behavior","training.safetyRuleSaved":"Safety rule saved","training.safetyRuleDeleted":"Safety rule deleted","training.toolName":"Tool","training.override":"Override","training.overridden":"Overridden","training.default":"Default","training.editTool":"Edit Tool","training.originalDescription":"Default Description","training.overrideDescription":"Override Description","training.descriptionRequired":"Description is required","training.toolOverrideSaved":"Tool override saved","training.toolOverrideReset":"Tool override reset","training.reset":"Reset","training.resetConfirm":"Reset override for {name}?","training.resetFailed":"Failed to reset: {error}","training.toolNotFound":"Tool not found","nav.vehicles":"Vehicles","vehicles.breadcrumb":"Vehicles","vehicles.title":"Vehicle Database","vehicles.searchPlaceholder":"Search by name...","vehicles.brands":"Brands","vehicles.models":"Models","vehicles.kits":"Kits","vehicles.tireSizes":"Tire Sizes","vehicles.lastImport":"Last Import","vehicles.brand":"Brand","vehicles.model":"Model","vehicles.year":"Year","vehicles.trim":"Trim","vehicles.pcd":"PCD","vehicles.bolts":"Bolts","vehicles.dia":"DIA","vehicles.size":"Size","vehicles.type":"Type","vehicles.axle":"Axle","vehicles.stock":"Stock","vehicles.tuning":"Tuning","vehicles.front":"Front","vehicles.rear":"Rear","vehicles.all":"All","vehicles.back":"← Back","vehicles.noData":"No data","vehicles.failedToLoad":"Failed to load: {error}","vehicles.neverImported":"Never imported","vehicles.importButton":"Update DB","vehicles.importTitle":"Update Vehicle Database","vehicles.importInstructions":"Place 4 CSV files in a directory on the server:","vehicles.importWarning":"Import will delete current data and load new. Operation takes ~30-60 seconds.","vehicles.importPathLabel":"Path to CSV directory","vehicles.importPathRequired":"Please enter the directory path","vehicles.importBtn":"Import","vehicles.importSuccess":"Import complete: {brands} brands, {models} models, {kits} kits, {tireSizes} tire sizes","vehicles.importFailed":"Import failed: {error}","common.search":"Search","audit.breadcrumb":"Audit Log","audit.title":"Audit Log","audit.allActions":"All actions","audit.noEntries":"No audit entries found","audit.date":"Date","audit.user":"User","audit.action":"Action","audit.resource":"Resource","audit.ip":"IP","audit.failedToLoad":"Failed to load audit log: {error}"},De="admin_lang",Pe={ru:Xe,en:Ze};let L="ru";function et(){L=localStorage.getItem(De)||"ru",document.documentElement.lang=L;const t=document.getElementById("langLabel");t&&(t.textContent=L==="ru"?"EN":"RU")}function e(t,a){var n,o;let s=((n=Pe[L])==null?void 0:n[t])??((o=Pe.ru)==null?void 0:o[t])??t;if(a)for(const[i,d]of Object.entries(a))s=s.replace(`{${i}}`,d);return s}function tt(){L=L==="ru"?"en":"ru",localStorage.setItem(De,L),document.documentElement.lang=L,Me();const t=document.getElementById("langLabel");t&&(t.textContent=L==="ru"?"EN":"RU"),window.dispatchEvent(new CustomEvent("langchange"))}function Me(){document.querySelectorAll("[data-i18n]").forEach(t=>{t.textContent=e(t.dataset.i18n)}),document.querySelectorAll("[data-i18n-placeholder]").forEach(t=>{t.placeholder=e(t.dataset.i18nPlaceholder)})}function at(){return L==="ru"?"ru-RU":"en-US"}const Te="";let M=localStorage.getItem("admin_token"),Y=null;function O(){return M}function st(t){M=t,localStorage.setItem("admin_token",t)}function nt(){M=null,localStorage.removeItem("admin_token")}function ot(t){Y=t}async function m(t,a={}){const s={"Content-Type":"application/json"};M&&(s.Authorization=`Bearer ${M}`);const n=await fetch(`${Te}${t}`,{...a,headers:s});if(n.status===401)throw l(e("api.sessionExpired"),"error"),Y&&Y(),new Error(e("api.unauthorized"));if(!n.ok){const o=await n.json().catch(()=>({}));throw new Error(o.detail||`HTTP ${n.status}`)}return n.json()}async function rt(t,a){const s={};M&&(s.Authorization=`Bearer ${M}`);const n=await fetch(`${Te}${t}`,{method:"POST",headers:s,body:a});if(n.status===401)throw l(e("api.sessionExpired"),"error"),Y&&Y(),new Error(e("api.unauthorized"));if(!n.ok){const o=await n.json().catch(()=>({}));throw new Error(o.detail||`HTTP ${n.status}`)}return n.json()}async function ke(t){const a={};return M&&(a.Authorization=`Bearer ${M}`),fetch(`${Te}${t}`,{headers:a})}let k=null,ae=1e3;const it=3e4;let ye=null;function lt(t){ye=t}function Be(){const t=O();if(!t)return;const s=`${location.protocol==="https:"?"wss:":"ws:"}//${location.host}/ws?token=${t}`;try{k=new WebSocket(s)}catch{return}k.onopen=()=>{ae=1e3,G("connected")},k.onclose=()=>{G("disconnected"),ct()},k.onerror=()=>{G("disconnected")},k.onmessage=n=>{try{const o=JSON.parse(n.data);if(o.type==="ping"){k&&k.readyState===WebSocket.OPEN&&k.send("pong");return}if(o.type==="pong")return;ye&&ye(o)}catch{}}}function dt(){k&&(k.close(),k=null)}function ct(){O()&&(G("reconnecting"),setTimeout(()=>{O()&&Be()},ae),ae=Math.min(ae*2,it))}let Fe="disconnected";function G(t){Fe=t;const a=document.getElementById("wsDot"),s=document.getElementById("wsLabel");if(!a||!s)return;const n={connected:"bg-green-500",reconnecting:"bg-yellow-500",disconnected:"bg-red-500"};a.className=`w-2 h-2 rounded-full ${n[t]||"bg-red-500"}`;const o={connected:e("ws.live"),reconnecting:e("ws.reconnecting"),disconnected:e("ws.offline")};s.textContent=o[t]||e("ws.offline")}function ut(){G(Fe)}setInterval(()=>{k&&k.readyState===WebSocket.OPEN&&k.send("ping")},25e3);let se=null,Re={};function P(t,a){Re[t]=a}function Ee(){se&&(clearInterval(se),se=null)}function le(t){document.querySelectorAll('[id^="page-"]').forEach(o=>o.style.display="none");const a=document.getElementById(`page-${t}`);a&&(a.style.display="block"),document.querySelectorAll(".sidebar a").forEach(o=>o.classList.remove("active"));const s=document.querySelector(`[data-page="${t}"]`);s&&s.classList.add("active"),localStorage.setItem("admin_active_page",t),Ee();const n=Re[t];n&&n()}function Oe(t,a){Ee(),se=setInterval(t,a)}function mt(){const t=O();if(!t)return"";try{return JSON.parse(atob(t.split(".")[1])).role||""}catch{return""}}function Ne(){const t=mt();document.querySelectorAll(".admin-only").forEach(a=>{a.style.display=t==="admin"?"":"none"}),t==="analyst"&&document.querySelectorAll('[data-page="prompts"]').forEach(a=>a.style.display="none")}async function He(){const t=document.getElementById("loginUsername").value,a=document.getElementById("loginPassword").value;if(!t||!a){document.getElementById("loginError").textContent=e("login.error"),document.getElementById("loginError").style.display="block";return}try{const s=await m("/auth/login",{method:"POST",body:JSON.stringify({username:t,password:a})});st(s.token),document.getElementById("loginContainer").style.display="none",document.getElementById("app").style.display="block",document.getElementById("loginError").style.display="none",Ne(),Be();const n=localStorage.getItem("admin_active_page")||"dashboard";le(n)}catch{document.getElementById("loginError").textContent=e("login.error"),document.getElementById("loginError").style.display="block"}}function Se(){nt(),Ee(),dt(),document.getElementById("app").style.display="none",document.getElementById("loginContainer").style.display="flex"}function qe(){const t=O();if(t)try{const a=JSON.parse(atob(t.split(".")[1]));a.exp&&a.exp<Date.now()/1e3&&(l(e("api.sessionExpired"),"error"),Se())}catch{}}ot(Se);const z="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium",J=`${z} bg-neutral-100 text-neutral-600 dark:bg-neutral-800 dark:text-neutral-400`,b=`${z} bg-emerald-50 text-emerald-700 dark:bg-emerald-950 dark:text-emerald-400`,F=`${z} bg-amber-50 text-amber-700 dark:bg-amber-950 dark:text-amber-400`,B=`${z} bg-red-50 text-red-700 dark:bg-red-950 dark:text-red-400`,_=`${z} bg-blue-50 text-blue-700 dark:bg-blue-950 dark:text-blue-400`,ne=`${z} bg-neutral-100 text-neutral-600 dark:bg-neutral-800 dark:text-neutral-400`,X="inline-flex items-center justify-center px-3 py-1.5 text-sm font-medium rounded-md transition-colors cursor-pointer",f=`${X} bg-blue-600 text-white hover:bg-blue-700`,j=`${X} bg-red-600 text-white hover:bg-red-700`,q=`${X} bg-neutral-500 text-white hover:bg-neutral-600 dark:bg-neutral-600 dark:hover:bg-neutral-500`,gt=`${X} bg-emerald-600 text-white hover:bg-emerald-700`,pt=`${X} bg-violet-600 text-white hover:bg-violet-700`,y="text-xs px-2 py-1",S="bg-white dark:bg-neutral-900 border border-neutral-200 dark:border-neutral-800 rounded-lg p-5 mb-4",I="text-2xl font-bold text-blue-600 dark:text-blue-400",x="text-xs text-neutral-500 dark:text-neutral-400 mt-1",T="w-full text-sm",u="px-3 py-2.5 text-left text-xs font-semibold text-neutral-500 dark:text-neutral-400 uppercase tracking-wider border-b border-neutral-200 dark:border-neutral-700",r="px-3 py-2.5 border-b border-neutral-100 dark:border-neutral-800 text-neutral-700 dark:text-neutral-300",$="hover:bg-neutral-50 dark:hover:bg-neutral-800/50 transition-colors",Ie="px-3 py-1.5 text-sm border border-neutral-300 dark:border-neutral-700 rounded-md bg-white dark:bg-neutral-800 text-neutral-700 dark:text-neutral-300 hover:bg-neutral-50 dark:hover:bg-neutral-700 cursor-pointer transition-colors max-md:min-h-11 max-md:min-w-11",v="text-center py-8 text-neutral-400 dark:text-neutral-500 text-sm",E="flex justify-center py-8",Ue="text-xs px-1.5 py-1 border border-neutral-300 dark:border-neutral-700 rounded bg-white dark:bg-neutral-800 text-neutral-700 dark:text-neutral-300",vt="py-2 border-b border-neutral-100 dark:border-neutral-800",$t="font-semibold text-xs text-blue-600 dark:text-blue-400",ht="font-semibold text-xs text-emerald-600 dark:text-emerald-400",yt="text-sm text-neutral-700 dark:text-neutral-300 mt-0.5",Ae="text-blue-600 dark:text-blue-400 hover:underline",$e="text-sm font-semibold text-neutral-900 dark:text-neutral-50 mb-3",N="text-xs text-neutral-500 dark:text-neutral-400";function fe(t){if(t==null)return`<span class="${J}">N/A</span>`;const a=parseFloat(t).toFixed(2);return t>=.8?`<span class="${b}">${a}</span>`:t>=.5?`<span class="${F}">${a}</span>`:`<span class="${B}">${a}</span>`}function Q(t){return t?new Date(t).toLocaleString(at(),{dateStyle:"short",timeStyle:"short"}):"-"}function C(t){document.getElementById(t).classList.remove("show")}function c(t){if(!t)return"";const a=document.createElement("div");return a.textContent=t,a.innerHTML}function ft(t){return t?`<span class="${{online:b,offline:ne,busy:F,break:_}[t]||ne}">${c(t)}</span>`:`<span class="${ne}">unknown</span>`}function xe(t,a){const s=URL.createObjectURL(t),n=document.createElement("a");n.href=s,n.download=a,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(s)}const Ve="admin_theme",wt='<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>',bt='<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>';function Tt(){re(),window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",t=>{localStorage.getItem(Ve)||(document.documentElement.classList.toggle("dark",t.matches),re())})}function kt(){const t=document.documentElement.classList.toggle("dark");localStorage.setItem(Ve,t?"dark":"light"),re()}function re(){const t=document.documentElement.classList.contains("dark"),a=document.getElementById("themeIcon"),s=document.getElementById("themeLabel");a&&(a.innerHTML=t?wt:bt),s&&(s.textContent=e(t?"theme.light":"theme.dark"))}function Bt(){re()}async function we(){try{const s=((await m("/analytics/summary")).daily_stats||[])[0]||{},n=s.total_calls||0,o=s.resolved_by_bot||0,i=n>0?(o/n*100).toFixed(1):"0.0";document.getElementById("dashboardStats").innerHTML=`
            <div class="${S} text-center"><div class="${I}">${n}</div><div class="${x}">${e("dashboard.callsToday")}</div></div>
            <div class="${S} text-center"><div class="${I}">${o}<small class="text-xs text-neutral-500 dark:text-neutral-400"> (${i}%)</small></div><div class="${x}">${e("dashboard.resolvedByBot")}</div></div>
            <div class="${S} text-center"><div class="${I}">${s.transferred||0}</div><div class="${x}">${e("dashboard.transferred")}</div></div>
            <div class="${S} text-center"><div class="${I}">${(s.avg_quality_score||0).toFixed(2)}</div><div class="${x}">${e("dashboard.avgQuality")}</div></div>
            <div class="${S} text-center"><div class="${I}">$${(s.total_cost_usd||0).toFixed(2)}</div><div class="${x}">${e("dashboard.costToday")}</div></div>
        `}catch(t){document.getElementById("dashboardStats").innerHTML=`
            <div class="${v}">${e("dashboard.failedToLoad",{error:c(t.message)})}
            <br><button class="${f} ${y} mt-2" onclick="window._pages.dashboard.loadDashboard()">${e("common.retry")}</button></div>
        `}}async function Et(){try{const t=await ke("/analytics/summary/export");if(!t.ok)throw new Error(`HTTP ${t.status}`);const a=await t.blob(),n=(t.headers.get("Content-Disposition")||"").match(/filename="(.+)"/),o=n?n[1]:"daily_stats_export.csv";xe(a,o),l(e("dashboard.csvExported"))}catch(t){l(e("dashboard.exportFailed",{error:t.message}),"error")}}async function St(){const t=new Date,a=new Date(t);a.setDate(a.getDate()-7);const s=a.toISOString().split("T")[0],n=t.toISOString().split("T")[0];try{const o=await ke(`/analytics/report/pdf?date_from=${s}&date_to=${n}`);if(!o.ok)throw new Error(`HTTP ${o.status}`);const i=await o.blob(),g=(o.headers.get("Content-Disposition")||"").match(/filename="(.+)"/),p=g?g[1]:`report_${s}_${n}.pdf`;xe(i,p),l(e("dashboard.pdfDownloaded"))}catch(o){l(e("dashboard.pdfFailed",{error:o.message}),"error")}}function It(){P("dashboard",()=>{we(),Oe(we,3e4)})}window._pages=window._pages||{};window._pages.dashboard={loadDashboard:we,exportStatsCSV:Et,downloadPdfReport:St};let ze=0;async function Je(t=0){ze=t;const a=document.getElementById("callsLoading"),s=document.querySelector("#callsTable tbody");a.style.display="flex";const n=new URLSearchParams({limit:20,offset:t}),o=document.getElementById("filterDateFrom").value,i=document.getElementById("filterDateTo").value,d=document.getElementById("filterScenario").value,g=document.getElementById("filterTransferred").value,p=document.getElementById("filterQualityBelow").value,h=document.getElementById("filterSearch").value;o&&n.set("date_from",o),i&&n.set("date_to",i),d&&n.set("scenario",d),g&&n.set("transferred",g),p&&n.set("quality_below",p),h&&n.set("search",h);try{const w=await m(`/analytics/calls?${n}`);if(a.style.display="none",!w.calls||w.calls.length===0){s.innerHTML=`<tr><td colspan="7" class="${v}">${e("calls.noCalls")}</td></tr>`,document.getElementById("callsPagination").innerHTML="";return}s.innerHTML=w.calls.map(A=>`
            <tr class="${$} cursor-pointer" onclick="window._pages.calls.showCallDetail('${A.id}')">
                <td class="${r}">${Q(A.started_at)}</td>
                <td class="${r}">${c(A.caller_id)||"-"}</td>
                <td class="${r}">${c(A.scenario)||"-"}</td>
                <td class="${r}">${A.duration_seconds||0}s</td>
                <td class="${r}">${fe(A.quality_score)}</td>
                <td class="${r}">$${(A.total_cost_usd||0).toFixed(3)}</td>
                <td class="${r}">${A.transferred_to_operator?`<span class="${F}">${e("calls.statusTransferred")}</span>`:`<span class="${b}">${e("calls.statusResolved")}</span>`}</td>
            </tr>
        `).join("");const K=Math.ceil(w.total/20),Ye=Math.floor(t/20);document.getElementById("callsPagination").innerHTML=Array.from({length:Math.min(K,10)},(A,ve)=>`<button class="${Ie}${ve===Ye?" active":""}" onclick="window._pages.calls.loadCalls(${ve*20})">${ve+1}</button>`).join("")}catch(w){a.style.display="none",s.innerHTML=`<tr><td colspan="7" class="${v}">${e("calls.failedToLoad",{error:c(w.message)})}
            <br><button class="${f} ${y} mt-2" onclick="window._pages.calls.loadCalls(${t})">${e("common.retry")}</button></td></tr>`}}async function xt(){const t=new URLSearchParams,a=document.getElementById("filterDateFrom").value,s=document.getElementById("filterDateTo").value,n=document.getElementById("filterScenario").value,o=document.getElementById("filterTransferred").value,i=document.getElementById("filterQualityBelow").value;a&&t.set("date_from",a),s&&t.set("date_to",s),n&&t.set("scenario",n),o&&t.set("transferred",o),i&&t.set("min_quality",i);try{const d=await ke(`/analytics/calls/export?${t}`);if(!d.ok)throw new Error(`HTTP ${d.status}`);const g=await d.blob(),h=(d.headers.get("Content-Disposition")||"").match(/filename="(.+)"/),w=h?h[1]:"calls_export.csv";xe(g,w),l(e("calls.csvExported"))}catch(d){l(e("calls.exportFailed",{error:d.message}),"error")}}async function _t(t){try{const a=await m(`/analytics/calls/${t}`),s=a.call,n=a.turns||[],o=a.tool_calls||[];let i=`
            <div class="grid grid-cols-2 gap-3 mb-4 text-sm">
                <div><span class="font-medium text-neutral-500 dark:text-neutral-400">${e("calls.detailCaller")}</span> <span class="text-neutral-900 dark:text-neutral-100">${c(s.caller_id)||"-"}</span></div>
                <div><span class="font-medium text-neutral-500 dark:text-neutral-400">${e("calls.detailScenario")}</span> <span class="text-neutral-900 dark:text-neutral-100">${c(s.scenario)||"-"}</span></div>
                <div><span class="font-medium text-neutral-500 dark:text-neutral-400">${e("calls.detailDuration")}</span> <span class="text-neutral-900 dark:text-neutral-100">${s.duration_seconds||0}s</span></div>
                <div><span class="font-medium text-neutral-500 dark:text-neutral-400">${e("calls.detailQuality")}</span> ${fe(s.quality_score)}</div>
                <div><span class="font-medium text-neutral-500 dark:text-neutral-400">${e("calls.detailCost")}</span> <span class="text-neutral-900 dark:text-neutral-100">$${(s.total_cost_usd||0).toFixed(3)}</span></div>
                <div><span class="font-medium text-neutral-500 dark:text-neutral-400">${e("calls.detailPrompt")}</span> <span class="text-neutral-900 dark:text-neutral-100">${c(s.prompt_version)||"-"}</span></div>
            </div>
        `;if(s.quality_details){i+=`<h3 class="${$e} mt-4">${e("calls.qualityBreakdown")}</h3><div class="overflow-x-auto"><table class="${T}">`;for(const[d,g]of Object.entries(s.quality_details))d!=="comment"&&(i+=`<tr class="${$}"><td class="${r}">${c(d)}</td><td class="${r}">${fe(g)}</td></tr>`);s.quality_details.comment&&(i+=`<tr><td colspan="2" class="${r} italic">${c(s.quality_details.comment)}</td></tr>`),i+="</table></div>"}i+=`<h3 class="${$e} mt-4">${e("calls.transcription")}</h3>`,n.length===0?i+=`<div class="${v}">${e("calls.noTranscription")}</div>`:n.forEach(d=>{i+=`<div class="${vt}"><span class="${d.speaker==="customer"?$t:ht}">${d.speaker==="customer"?e("calls.customer"):e("calls.bot")}</span>`,i+=`<div class="${yt}">${c(d.text)}</div></div>`}),o.length&&(i+=`<h3 class="${$e} mt-4">${e("calls.toolCalls")}</h3><div class="overflow-x-auto"><table class="${T}"><tr><th class="${u}">${e("calls.toolName")}</th><th class="${u}">${e("calls.toolSuccess")}</th><th class="${u}">${e("calls.toolDuration")}</th></tr>`,o.forEach(d=>{i+=`<tr class="${$}"><td class="${r}">${c(d.tool_name)}</td><td class="${r}">${d.success?`<span class="${b}">${e("common.yes")}</span>`:`<span class="${B}">${e("common.no")}</span>`}</td><td class="${r}">${d.duration_ms||0}ms</td></tr>`}),i+="</table></div>"),document.getElementById("callDetailContent").innerHTML=i,document.getElementById("callModal").classList.add("show")}catch(a){l(e("calls.failedToLoadDetail",{error:a.message}),"error")}}function Ct(){document.getElementById("callModal").classList.remove("show")}function Lt(){return ze}function Pt(){P("calls",()=>Je())}window._pages=window._pages||{};window._pages.calls={loadCalls:Je,exportCallsCSV:xt,showCallDetail:_t,closeCallModal:Ct};let W=[],oe="prompts";function je(t){oe=t,["prompts","knowledge","templates","dialogues","safety","tools"].forEach(o=>{const i=document.getElementById(`trainingContent-${o}`);i&&(i.style.display=o===t?"block":"none")}),document.querySelectorAll("#page-training .tab-bar button").forEach(o=>o.classList.remove("active"));const s=document.querySelector(`#page-training .tab-bar button[data-tab="${t}"]`);s&&s.classList.add("active");const n={prompts:de,knowledge:Ot,templates:ce,dialogues:ue,safety:me,tools:ge};n[t]&&n[t]()}async function de(){const t=document.getElementById("trainingContent-prompts");try{const s=(await m("/prompts")).versions||[];if(s.length===0){t.innerHTML=`
                <div class="mb-4"><button class="${f}" onclick="window._pages.training.showCreatePrompt()">${e("prompts.newVersion")}</button></div>
                <div class="${v}">${e("prompts.noVersions")}</div>`;return}t.innerHTML=`
            <div class="mb-4"><button class="${f}" onclick="window._pages.training.showCreatePrompt()">${e("prompts.newVersion")}</button></div>
            <div class="overflow-x-auto"><table class="${T}"><thead><tr><th class="${u}">${e("prompts.name")}</th><th class="${u}">${e("prompts.active")}</th><th class="${u}">${e("prompts.created")}</th><th class="${u}">${e("prompts.action")}</th></tr></thead><tbody>
            ${s.map(n=>`
                <tr class="${$}">
                    <td class="${r}">${c(n.name)}</td>
                    <td class="${r}">${n.is_active?`<span class="${b}">${e("prompts.activeLabel")}</span>`:""}</td>
                    <td class="${r}">${Q(n.created_at)}</td>
                    <td class="${r}">${n.is_active?"":`<button class="${f} ${y}" onclick="window._pages.training.activatePrompt('${n.id}')">${e("prompts.activateBtn")}</button>`}</td>
                </tr>
            `).join("")}
            </tbody></table></div>`}catch(a){t.innerHTML=`<div class="${v}">${e("prompts.failedToLoad",{error:c(a.message)})}
            <br><button class="${f} ${y} mt-2" onclick="window._pages.training.loadPromptVersions()">${e("common.retry")}</button></div>`}}function At(){document.getElementById("promptName").value="",document.getElementById("promptSystemPrompt").value="",document.getElementById("createPromptModal").classList.add("show")}async function Dt(){const t=document.getElementById("promptName").value.trim(),a=document.getElementById("promptSystemPrompt").value.trim();if(!t||!a){l(e("prompts.nameRequired"),"error");return}try{await m("/prompts",{method:"POST",body:JSON.stringify({name:t,system_prompt:a})}),C("createPromptModal"),l(e("prompts.created_toast")),de()}catch(s){l(e("prompts.createFailed",{error:s.message}),"error")}}async function Mt(t){if(confirm(e("prompts.activateConfirm")))try{await m(`/prompts/${t}/activate`,{method:"PATCH"}),l(e("prompts.activated")),de()}catch(a){l(e("prompts.activateFailed",{error:a.message}),"error")}}function Ft(t){switch(t){case"indexed":return`<span class="${b}">indexed</span>`;case"pending":return`<span class="${F}">pending</span>`;case"processing":return`<span class="${_}">processing</span>`;case"error":return`<span class="${B}">error</span>`;default:return`<span class="${J}">${c(t||"unknown")}</span>`}}function he(t,a,s){if(t.innerHTML="",s){const n=document.createElement("option");n.value="",n.textContent=e("knowledge.allCategories"),t.appendChild(n)}for(const n of a){const o=document.createElement("option");o.value=n.value,o.textContent=n.label,t.appendChild(o)}}async function Rt(){try{W=(await m("/knowledge/article-categories")).categories||[]}catch{W=[{value:"brands",label:"Brands"},{value:"guides",label:"Guides"},{value:"faq",label:"FAQ"},{value:"comparisons",label:"Comparisons"},{value:"general",label:"General"}]}const t=document.getElementById("kbCategory");t&&he(t,W,!0);const a=document.getElementById("articleCategory");a&&he(a,W,!1);const s=document.getElementById("importCategory");s&&he(s,W,!0)}async function Ot(){await Rt(),await R()}async function R(){var o,i;const t=document.getElementById("articlesContainer");t.innerHTML=`<div class="${E}"><div class="spinner"></div></div>`;const a=new URLSearchParams,s=(o=document.getElementById("kbCategory"))==null?void 0:o.value,n=(i=document.getElementById("kbSearch"))==null?void 0:i.value;s&&a.set("category",s),n&&a.set("search",n);try{const d=await m(`/knowledge/articles?${a}`),g=d.articles||[];if(g.length===0){t.innerHTML=`<div class="${v}">${e("knowledge.noArticles")}</div>`;return}t.innerHTML=`
            <div class="overflow-x-auto"><table class="${T}"><thead><tr><th class="${u}">${e("knowledge.articleTitle")}</th><th class="${u}">${e("knowledge.category")}</th><th class="${u}">${e("knowledge.embedding")}</th><th class="${u}">${e("knowledge.activeCol")}</th><th class="${u}">${e("knowledge.updated")}</th><th class="${u}">${e("knowledge.actions")}</th></tr></thead><tbody>
            ${g.map(p=>`
                <tr class="${$}">
                    <td class="${r}">${c(p.title)}</td>
                    <td class="${r}"><span class="${_}">${c(p.category)}</span></td>
                    <td class="${r}">${Ft(p.embedding_status)}</td>
                    <td class="${r}">${p.active!==!1?`<span class="${b}">${e("common.yes")}</span>`:`<span class="${B}">${e("common.no")}</span>`}</td>
                    <td class="${r}">${Q(p.updated_at||p.created_at)}</td>
                    <td class="${r}">
                        <div class="flex flex-wrap gap-1">
                            <button class="${f} ${y}" onclick="window._pages.training.editArticle('${p.id}')">${e("knowledge.editBtn")}</button>
                            <button class="${gt} ${y}" onclick="window._pages.training.reindexArticle('${p.id}')">${e("knowledge.reindexBtn")}</button>
                            <button class="${q} ${y}" onclick="window._pages.training.toggleArticle('${p.id}', ${p.active!==!1})">${p.active!==!1?e("common.deactivate"):e("common.activate")}</button>
                            <button class="${j} ${y}" onclick="window._pages.training.deleteArticle('${p.id}', '${c(p.title).replace(/'/g,"\\'")}')">×</button>
                        </div>
                    </td>
                </tr>
            `).join("")}
            </tbody></table></div>
            <p class="${N} mt-2">${e("knowledge.total",{count:d.total})}</p>`}catch(d){t.innerHTML=`<div class="${v}">${e("knowledge.failedToLoad",{error:c(d.message)})}
            <br><button class="${f} ${y} mt-2" onclick="window._pages.training.loadArticles()">${e("common.retry")}</button></div>`}}function Nt(){document.getElementById("articleModalTitle").textContent=e("knowledge.newArticleTitle"),document.getElementById("editArticleId").value="",document.getElementById("articleTitle").value="",document.getElementById("articleCategory").value="faq",document.getElementById("articleContent").value="",document.getElementById("createArticleModal").classList.add("show")}async function Ht(t){try{const s=(await m(`/knowledge/articles/${t}`)).article;document.getElementById("articleModalTitle").textContent=e("knowledge.editArticleTitle"),document.getElementById("editArticleId").value=t,document.getElementById("articleTitle").value=s.title||"",document.getElementById("articleCategory").value=s.category||"faq",document.getElementById("articleContent").value=s.content||"",document.getElementById("createArticleModal").classList.add("show")}catch(a){l(e("knowledge.loadFailed",{error:a.message}),"error")}}async function qt(){const t=document.getElementById("editArticleId").value,a=document.getElementById("articleTitle").value.trim(),s=document.getElementById("articleCategory").value,n=document.getElementById("articleContent").value.trim();if(!a||!n){l(e("knowledge.titleRequired"),"error");return}try{t?(await m(`/knowledge/articles/${t}`,{method:"PATCH",body:JSON.stringify({title:a,category:s,content:n})}),l(e("knowledge.articleUpdated"))):(await m("/knowledge/articles",{method:"POST",body:JSON.stringify({title:a,category:s,content:n})}),l(e("knowledge.articleCreated"))),C("createArticleModal"),R()}catch(o){l(e("knowledge.saveFailed",{error:o.message}),"error")}}async function Ut(t,a){try{await m(`/knowledge/articles/${t}`,{method:"PATCH",body:JSON.stringify({active:!a})}),l(e(a?"knowledge.articleDeactivated":"knowledge.articleActivated")),R()}catch(s){l(e("knowledge.toggleFailed",{error:s.message}),"error")}}async function Vt(t,a){if(confirm(e("knowledge.deleteConfirm",{title:a})))try{await m(`/knowledge/articles/${t}`,{method:"DELETE"}),l(e("knowledge.articleDeleted")),R()}catch(s){l(e("knowledge.deleteFailed",{error:s.message}),"error")}}async function zt(t){try{const a=await m(`/knowledge/articles/${t}/reindex`,{method:"POST"});l(a.message||e("knowledge.reindexQueued")),R()}catch(a){l(e("knowledge.reindexFailed",{error:a.message}),"error")}}async function Jt(){if(confirm(e("knowledge.reindexAllConfirm")))try{const t=await m("/knowledge/reindex-all",{method:"POST"});l(t.message||e("knowledge.reindexAllDispatched")),R()}catch(t){l(e("knowledge.reindexAllFailed",{error:t.message}),"error")}}function jt(){document.getElementById("importFiles").value="";const t=document.getElementById("importCategory");t&&(t.value=""),document.getElementById("importDocumentsModal").classList.add("show")}async function Qt(){const t=document.getElementById("importFiles"),a=document.getElementById("importCategory"),s=t.files;if(!s||s.length===0){l(e("knowledge.importNoFiles"),"error");return}const n=new FormData;for(const d of s)n.append("files",d);let o="/knowledge/articles/import";const i=a?a.value:"";i&&(o+=`?category=${encodeURIComponent(i)}`);try{const d=await rt(o,n),g=[e("knowledge.importResult",{imported:d.imported})];if(d.errors>0&&g.push(e("knowledge.importErrors",{errors:d.errors})),l(g.join(", "),d.errors>0?"warning":"success"),d.error_details&&d.error_details.length>0)for(const p of d.error_details)l(`${p.filename}: ${p.error}`,"error");C("importDocumentsModal"),R()}catch(d){l(e("knowledge.importFailed",{error:d.message}),"error")}}async function ce(){const t=document.getElementById("trainingContent-templates");t.innerHTML=`<div class="${E}"><div class="spinner"></div></div>`;try{const s=(await m("/training/templates/")).items||[];if(s.length===0){t.innerHTML=`
                <div class="mb-4"><button class="${f}" onclick="window._pages.training.showCreateTemplate()">${e("training.newTemplate")}</button></div>
                <div class="${v}">${e("training.noTemplates")}</div>`;return}const n={};for(const i of s)n[i.template_key]||(n[i.template_key]=[]),n[i.template_key].push(i);let o="";for(const[i,d]of Object.entries(n))for(let g=0;g<d.length;g++){const p=d[g],h=g===0,w=d.length;o+=`
                <tr class="${$}">
                    ${h?`<td class="${r}" rowspan="${w}"><span class="${_}">${c(i)}</span><br><span class="${N} text-xs">${w} ${e("training.variantCount",{count:w})}</span><br><button class="${f} ${y} mt-1" onclick="window._pages.training.addVariant('${c(i)}')">${e("training.addVariant")}</button></td>`:""}
                    <td class="${r}"><span class="${J}">#${p.variant_number}</span></td>
                    <td class="${r}">${c(p.title)}</td>
                    <td class="${r}"><span class="${N}">${c((p.content||"").substring(0,80))}${(p.content||"").length>80?"...":""}</span></td>
                    <td class="${r}">${p.is_active!==!1?`<span class="${b}">${e("common.yes")}</span>`:`<span class="${B}">${e("common.no")}</span>`}</td>
                    <td class="${r}">
                        <div class="flex flex-wrap gap-1">
                            <button class="${f} ${y}" onclick="window._pages.training.editTemplate('${p.id}')">${e("common.edit")}</button>
                            ${w>1?`<button class="${j} ${y}" onclick="window._pages.training.deleteTemplate('${p.id}', '${c(p.title).replace(/'/g,"\\'")}')">${e("common.delete")}</button>`:""}
                        </div>
                    </td>
                </tr>`}t.innerHTML=`
            <div class="mb-4">
                <button class="${f}" onclick="window._pages.training.showCreateTemplate()">${e("training.newTemplate")}</button>
                <span class="${N} ml-3 text-sm">${e("training.variantsHint")}</span>
            </div>
            <div class="overflow-x-auto"><table class="${T}"><thead><tr><th class="${u}">${e("training.templateKey")}</th><th class="${u}">#</th><th class="${u}">${e("training.templateTitle")}</th><th class="${u}">${e("training.content")}</th><th class="${u}">${e("training.activeCol")}</th><th class="${u}">${e("training.actions")}</th></tr></thead><tbody>
            ${o}
            </tbody></table></div>`}catch(a){t.innerHTML=`<div class="${v}">${e("training.loadFailed",{error:c(a.message)})}</div>`}}function Kt(){document.getElementById("templateModalTitle").textContent=e("training.newTemplate"),document.getElementById("editTemplateId").value="",document.getElementById("templateKey").value="",document.getElementById("templateKey").disabled=!1,document.getElementById("templateTitle").value="",document.getElementById("templateContent").value="",document.getElementById("templateDescription").value="",document.getElementById("responseTemplateModal").classList.add("show")}function Wt(t){document.getElementById("templateModalTitle").textContent=e("training.addVariantTitle"),document.getElementById("editTemplateId").value="",document.getElementById("templateKey").value=t,document.getElementById("templateKey").disabled=!0,document.getElementById("templateTitle").value="",document.getElementById("templateContent").value="",document.getElementById("templateDescription").value="",document.getElementById("responseTemplateModal").classList.add("show")}async function Gt(t){try{const s=(await m(`/training/templates/${t}`)).item;document.getElementById("templateModalTitle").textContent=e("training.editTemplate"),document.getElementById("editTemplateId").value=t,document.getElementById("templateKey").value=s.template_key||"",document.getElementById("templateKey").disabled=!0,document.getElementById("templateTitle").value=s.title||"",document.getElementById("templateContent").value=s.content||"",document.getElementById("templateDescription").value=s.description||"",document.getElementById("responseTemplateModal").classList.add("show")}catch(a){l(e("training.loadFailed",{error:a.message}),"error")}}async function Yt(){const t=document.getElementById("editTemplateId").value,a=document.getElementById("templateKey").value.trim(),s=document.getElementById("templateTitle").value.trim(),n=document.getElementById("templateContent").value.trim(),o=document.getElementById("templateDescription").value.trim();if(!s||!n){l(e("training.titleContentRequired"),"error");return}try{if(t)await m(`/training/templates/${t}`,{method:"PATCH",body:JSON.stringify({title:s,content:n,description:o||null})});else{if(!a){l(e("training.keyRequired"),"error");return}await m("/training/templates/",{method:"POST",body:JSON.stringify({template_key:a,title:s,content:n,description:o||null})})}C("responseTemplateModal"),l(e("training.templateSaved")),ce()}catch(i){l(e("training.saveFailed",{error:i.message}),"error")}}async function Xt(t,a){if(confirm(e("training.deleteVariantConfirm",{title:a})))try{await m(`/training/templates/${t}`,{method:"DELETE"}),l(e("training.variantDeleted")),ce()}catch(s){l(e("training.deleteFailed",{error:s.message}),"error")}}async function ue(){const t=document.getElementById("trainingContent-dialogues");t.innerHTML=`<div class="${E}"><div class="spinner"></div></div>`;try{const s=(await m("/training/dialogues/")).items||[];if(s.length===0){t.innerHTML=`
                <div class="mb-4"><button class="${f}" onclick="window._pages.training.showCreateDialogue()">${e("training.newDialogue")}</button></div>
                <div class="${v}">${e("training.noDialogues")}</div>`;return}t.innerHTML=`
            <div class="mb-4"><button class="${f}" onclick="window._pages.training.showCreateDialogue()">${e("training.newDialogue")}</button></div>
            <div class="overflow-x-auto"><table class="${T}"><thead><tr><th class="${u}">${e("training.dialogueTitle")}</th><th class="${u}">${e("training.scenario")}</th><th class="${u}">${e("training.phase")}</th><th class="${u}">${e("training.tools")}</th><th class="${u}">${e("training.activeCol")}</th><th class="${u}">${e("training.actions")}</th></tr></thead><tbody>
            ${s.map(n=>`
                <tr class="${$}">
                    <td class="${r}">${c(n.title)}</td>
                    <td class="${r}"><span class="${_}">${c(n.scenario_type)}</span></td>
                    <td class="${r}"><span class="${J}">${c(n.phase)}</span></td>
                    <td class="${r}">${(n.tools_used||[]).map(o=>`<span class="${ne}">${c(o)}</span>`).join(" ")}</td>
                    <td class="${r}">${n.is_active!==!1?`<span class="${b}">${e("common.yes")}</span>`:`<span class="${B}">${e("common.no")}</span>`}</td>
                    <td class="${r}">
                        <div class="flex flex-wrap gap-1">
                            <button class="${f} ${y}" onclick="window._pages.training.editDialogue('${n.id}')">${e("common.edit")}</button>
                            <button class="${j} ${y}" onclick="window._pages.training.deleteDialogue('${n.id}', '${c(n.title).replace(/'/g,"\\'")}')">${e("common.delete")}</button>
                        </div>
                    </td>
                </tr>
            `).join("")}
            </tbody></table></div>`}catch(a){t.innerHTML=`<div class="${v}">${e("training.loadFailed",{error:c(a.message)})}</div>`}}function Zt(){document.getElementById("dialogueModalTitle").textContent=e("training.newDialogue"),document.getElementById("editDialogueId").value="",document.getElementById("dialogueTitle").value="",document.getElementById("dialogueScenarioType").value="tire_search",document.getElementById("dialoguePhase").value="mvp",document.getElementById("dialogueJSON").value=`[
  {"role": "customer", "text": ""},
  {"role": "agent", "text": ""}
]`,document.getElementById("dialogueDescription").value="",document.getElementById("dialogueModal").classList.add("show")}async function ea(t){try{const s=(await m(`/training/dialogues/${t}`)).item;document.getElementById("dialogueModalTitle").textContent=e("training.editDialogue"),document.getElementById("editDialogueId").value=t,document.getElementById("dialogueTitle").value=s.title||"",document.getElementById("dialogueScenarioType").value=s.scenario_type||"tire_search",document.getElementById("dialoguePhase").value=s.phase||"mvp",document.getElementById("dialogueJSON").value=JSON.stringify(s.dialogue||[],null,2),document.getElementById("dialogueDescription").value=s.description||"",document.getElementById("dialogueModal").classList.add("show")}catch(a){l(e("training.loadFailed",{error:a.message}),"error")}}async function ta(){const t=document.getElementById("editDialogueId").value,a=document.getElementById("dialogueTitle").value.trim(),s=document.getElementById("dialogueScenarioType").value,n=document.getElementById("dialoguePhase").value,o=document.getElementById("dialogueDescription").value.trim();let i;try{i=JSON.parse(document.getElementById("dialogueJSON").value)}catch{l(e("training.invalidJSON"),"error");return}if(!a){l(e("training.titleRequired"),"error");return}const d=[...new Set(i.filter(p=>p.tool_calls).flatMap(p=>p.tool_calls.map(h=>h.name)))],g={title:a,scenario_type:s,phase:n,dialogue:i,tools_used:d,description:o||null};try{t?await m(`/training/dialogues/${t}`,{method:"PATCH",body:JSON.stringify(g)}):await m("/training/dialogues/",{method:"POST",body:JSON.stringify(g)}),C("dialogueModal"),l(e("training.dialogueSaved")),ue()}catch(p){l(e("training.saveFailed",{error:p.message}),"error")}}async function aa(t,a){if(confirm(e("training.deleteConfirm",{title:a})))try{await m(`/training/dialogues/${t}`,{method:"DELETE"}),l(e("training.dialogueDeleted")),ue()}catch(s){l(e("training.deleteFailed",{error:s.message}),"error")}}function sa(t){switch(t){case"critical":return`<span class="${B}">${c(t)}</span>`;case"high":return`<span class="${F}">${c(t)}</span>`;case"medium":return`<span class="${_}">${c(t)}</span>`;default:return`<span class="${J}">${c(t)}</span>`}}async function me(){const t=document.getElementById("trainingContent-safety");t.innerHTML=`<div class="${E}"><div class="spinner"></div></div>`;try{const s=(await m("/training/safety-rules/")).items||[];if(s.length===0){t.innerHTML=`
                <div class="mb-4"><button class="${f}" onclick="window._pages.training.showCreateSafetyRule()">${e("training.newSafetyRule")}</button></div>
                <div class="${v}">${e("training.noSafetyRules")}</div>`;return}t.innerHTML=`
            <div class="mb-4"><button class="${f}" onclick="window._pages.training.showCreateSafetyRule()">${e("training.newSafetyRule")}</button></div>
            <div class="overflow-x-auto"><table class="${T}"><thead><tr><th class="${u}">${e("training.ruleTitle")}</th><th class="${u}">${e("training.ruleType")}</th><th class="${u}">${e("training.severity")}</th><th class="${u}">${e("training.triggerInput")}</th><th class="${u}">${e("training.activeCol")}</th><th class="${u}">${e("training.actions")}</th></tr></thead><tbody>
            ${s.map(n=>`
                <tr class="${$}">
                    <td class="${r}">${c(n.title)}</td>
                    <td class="${r}"><span class="${_}">${c(n.rule_type)}</span></td>
                    <td class="${r}">${sa(n.severity)}</td>
                    <td class="${r}"><span class="${N}">${c((n.trigger_input||"").substring(0,60))}${(n.trigger_input||"").length>60?"...":""}</span></td>
                    <td class="${r}">${n.is_active!==!1?`<span class="${b}">${e("common.yes")}</span>`:`<span class="${B}">${e("common.no")}</span>`}</td>
                    <td class="${r}">
                        <div class="flex flex-wrap gap-1">
                            <button class="${f} ${y}" onclick="window._pages.training.editSafetyRule('${n.id}')">${e("common.edit")}</button>
                            <button class="${j} ${y}" onclick="window._pages.training.deleteSafetyRule('${n.id}', '${c(n.title).replace(/'/g,"\\'")}')">${e("common.delete")}</button>
                        </div>
                    </td>
                </tr>
            `).join("")}
            </tbody></table></div>`}catch(a){t.innerHTML=`<div class="${v}">${e("training.loadFailed",{error:c(a.message)})}</div>`}}function na(){document.getElementById("safetyRuleModalTitle").textContent=e("training.newSafetyRule"),document.getElementById("editSafetyRuleId").value="",document.getElementById("safetyRuleTitle").value="",document.getElementById("safetyRuleType").value="behavioral",document.getElementById("safetyRuleSeverity").value="medium",document.getElementById("safetyTriggerInput").value="",document.getElementById("safetyExpectedBehavior").value="",document.getElementById("safetyRuleModal").classList.add("show")}async function oa(t){try{const s=(await m(`/training/safety-rules/${t}`)).item;document.getElementById("safetyRuleModalTitle").textContent=e("training.editSafetyRule"),document.getElementById("editSafetyRuleId").value=t,document.getElementById("safetyRuleTitle").value=s.title||"",document.getElementById("safetyRuleType").value=s.rule_type||"behavioral",document.getElementById("safetyRuleSeverity").value=s.severity||"medium",document.getElementById("safetyTriggerInput").value=s.trigger_input||"",document.getElementById("safetyExpectedBehavior").value=s.expected_behavior||"",document.getElementById("safetyRuleModal").classList.add("show")}catch(a){l(e("training.loadFailed",{error:a.message}),"error")}}async function ra(){const t=document.getElementById("editSafetyRuleId").value,a=document.getElementById("safetyRuleTitle").value.trim(),s=document.getElementById("safetyRuleType").value,n=document.getElementById("safetyRuleSeverity").value,o=document.getElementById("safetyTriggerInput").value.trim(),i=document.getElementById("safetyExpectedBehavior").value.trim();if(!a||!o||!i){l(e("training.fieldsRequired"),"error");return}const d={title:a,rule_type:s,severity:n,trigger_input:o,expected_behavior:i};try{t?await m(`/training/safety-rules/${t}`,{method:"PATCH",body:JSON.stringify(d)}):await m("/training/safety-rules/",{method:"POST",body:JSON.stringify(d)}),C("safetyRuleModal"),l(e("training.safetyRuleSaved")),me()}catch(g){l(e("training.saveFailed",{error:g.message}),"error")}}async function ia(t,a){if(confirm(e("training.deleteConfirm",{title:a})))try{await m(`/training/safety-rules/${t}`,{method:"DELETE"}),l(e("training.safetyRuleDeleted")),me()}catch(s){l(e("training.deleteFailed",{error:s.message}),"error")}}async function ge(){const t=document.getElementById("trainingContent-tools");t.innerHTML=`<div class="${E}"><div class="spinner"></div></div>`;try{const s=(await m("/training/tools/")).items||[];t.innerHTML=`
            <div class="overflow-x-auto"><table class="${T}"><thead><tr><th class="${u}">${e("training.toolName")}</th><th class="${u}">${e("training.description")}</th><th class="${u}">${e("training.override")}</th><th class="${u}">${e("training.actions")}</th></tr></thead><tbody>
            ${s.map(n=>`
                <tr class="${$}">
                    <td class="${r}"><span class="${_}">${c(n.name)}</span></td>
                    <td class="${r}"><span class="${N}">${c((n.effective_description||"").substring(0,100))}${(n.effective_description||"").length>100?"...":""}</span></td>
                    <td class="${r}">${n.has_override?`<span class="${F}">${e("training.overridden")}</span>`:`<span class="${J}">${e("training.default")}</span>`}</td>
                    <td class="${r}">
                        <div class="flex flex-wrap gap-1">
                            <button class="${f} ${y}" onclick="window._pages.training.editToolOverride('${c(n.name)}')">${e("common.edit")}</button>
                            ${n.has_override?`<button class="${j} ${y}" onclick="window._pages.training.resetToolOverride('${c(n.name)}')">${e("training.reset")}</button>`:""}
                        </div>
                    </td>
                </tr>
            `).join("")}
            </tbody></table></div>`}catch(a){t.innerHTML=`<div class="${v}">${e("training.loadFailed",{error:c(a.message)})}</div>`}}async function la(t){try{const s=((await m("/training/tools/")).items||[]).find(n=>n.name===t);if(!s){l(e("training.toolNotFound"),"error");return}document.getElementById("toolOverrideModalTitle").textContent=`${e("training.editTool")}: ${t}`,document.getElementById("editToolName").value=t,document.getElementById("toolOriginalDescription").textContent=s.description,document.getElementById("toolOverrideDescription").value=s.override&&s.override.description||s.description,document.getElementById("toolOverrideModal").classList.add("show")}catch(a){l(e("training.loadFailed",{error:a.message}),"error")}}async function da(){const t=document.getElementById("editToolName").value,a=document.getElementById("toolOverrideDescription").value.trim();if(!a){l(e("training.descriptionRequired"),"error");return}try{await m(`/training/tools/${t}`,{method:"PATCH",body:JSON.stringify({description:a})}),C("toolOverrideModal"),l(e("training.toolOverrideSaved")),ge()}catch(s){l(e("training.saveFailed",{error:s.message}),"error")}}async function ca(t){if(confirm(e("training.resetConfirm",{name:t})))try{await m(`/training/tools/${t}`,{method:"DELETE"}),l(e("training.toolOverrideReset")),ge()}catch(a){l(e("training.resetFailed",{error:a.message}),"error")}}function ua(){P("training",()=>je(oe)),P("prompts",()=>{oe="prompts",window._app.showPage("training")}),P("knowledge",()=>{oe="knowledge",window._app.showPage("training")})}window._pages=window._pages||{};window._pages.training={showTab:je,loadPromptVersions:de,showCreatePrompt:At,createPrompt:Dt,activatePrompt:Mt,loadArticles:R,showCreateArticle:Nt,editArticle:Ht,saveArticle:qt,toggleArticle:Ut,deleteArticle:Vt,reindexArticle:zt,reindexAll:Jt,showImportModal:jt,importDocuments:Qt,loadTemplates:ce,showCreateTemplate:Kt,addVariant:Wt,editTemplate:Gt,saveTemplate:Yt,deleteTemplate:Xt,loadDialogues:ue,showCreateDialogue:Zt,editDialogue:ea,saveDialogue:ta,deleteDialogue:aa,loadSafetyRules:me,showCreateSafetyRule:na,editSafetyRule:oa,saveSafetyRule:ra,deleteSafetyRule:ia,loadTools:ge,editToolOverride:la,saveToolOverride:da,resetToolOverride:ca};async function U(){const t=document.getElementById("operatorsLoading"),a=document.querySelector("#operatorsTable tbody");t.style.display="flex";try{const s=await m("/operators");t.style.display="none";const n=s.operators||[];if(n.length===0){a.innerHTML=`<tr><td colspan="7" class="${v}">${e("operators.noOperators")}</td></tr>`;return}a.innerHTML=n.map(o=>`
            <tr class="${$}">
                <td class="${r}">${c(o.name)}</td>
                <td class="${r}">${c(o.extension)}</td>
                <td class="${r}">${ft(o.current_status)}</td>
                <td class="${r}">${(o.skills||[]).map(i=>`<span class="${_}">${c(i)}</span>`).join(" ")}</td>
                <td class="${r}">${o.shift_start||"09:00"} - ${o.shift_end||"18:00"}</td>
                <td class="${r}">${o.is_active?`<span class="${b}">${e("common.yes")}</span>`:`<span class="${B}">${e("common.no")}</span>`}</td>
                <td class="${r}">
                    <div class="flex flex-wrap items-center gap-1">
                        <select onchange="window._pages.operators.changeOperatorStatus('${o.id}', this.value); this.selectedIndex=0" class="${Ue}">
                            <option value="">${e("operators.statusSelect")}</option>
                            <option value="online">${e("operators.statusOnline")}</option>
                            <option value="offline">${e("operators.statusOffline")}</option>
                            <option value="busy">${e("operators.statusBusy")}</option>
                            <option value="break">${e("operators.statusBreak")}</option>
                        </select>
                        <button class="${f} ${y}" onclick="window._pages.operators.editOperator('${o.id}')">${e("operators.editBtn")}</button>
                        ${o.is_active?`<button class="${j} ${y}" onclick="window._pages.operators.deactivateOperator('${o.id}', '${c(o.name).replace(/'/g,"\\'")}')">×</button>`:""}
                    </div>
                </td>
            </tr>
        `).join("")}catch(s){t.style.display="none",a.innerHTML=`<tr><td colspan="7" class="${v}">${e("operators.failedToLoad",{error:c(s.message)})}
            <br><button class="${f} ${y} mt-2" onclick="window._pages.operators.loadOperators()">${e("common.retry")}</button></td></tr>`}}async function be(){try{const t=await m("/operators/queue");document.getElementById("operatorQueueStats").innerHTML=`
            <div class="${S} text-center"><div class="${I}">${t.operators_online||0}</div><div class="${x}">${e("operators.online")}</div></div>
            <div class="${S} text-center"><div class="${I}">${t.transfers_last_hour||0}</div><div class="${x}">${e("operators.transfers1h")}</div></div>
        `}catch{document.getElementById("operatorQueueStats").innerHTML=`<div class="${v}">${e("operators.queueUnavailable")}</div>`}}function ma(){document.getElementById("operatorModalTitle").textContent=e("operators.newOperatorTitle"),document.getElementById("editOperatorId").value="",document.getElementById("operatorName").value="",document.getElementById("operatorExtension").value="",document.getElementById("operatorSkills").value="",document.getElementById("operatorShiftStart").value="09:00",document.getElementById("operatorShiftEnd").value="18:00",document.getElementById("operatorModal").classList.add("show")}async function ga(t){try{const s=((await m("/operators")).operators||[]).find(n=>n.id===t);if(!s){l(e("operators.notFound"),"error");return}document.getElementById("operatorModalTitle").textContent=e("operators.editOperatorTitle"),document.getElementById("editOperatorId").value=t,document.getElementById("operatorName").value=s.name||"",document.getElementById("operatorExtension").value=s.extension||"",document.getElementById("operatorSkills").value=(s.skills||[]).join(", "),document.getElementById("operatorShiftStart").value=s.shift_start||"09:00",document.getElementById("operatorShiftEnd").value=s.shift_end||"18:00",document.getElementById("operatorModal").classList.add("show")}catch(a){l(e("operators.loadFailed",{error:a.message}),"error")}}async function pa(){const t=document.getElementById("editOperatorId").value,a=document.getElementById("operatorName").value.trim(),s=document.getElementById("operatorExtension").value.trim(),n=document.getElementById("operatorSkills").value.trim(),o=n?n.split(",").map(g=>g.trim()).filter(Boolean):[],i=document.getElementById("operatorShiftStart").value,d=document.getElementById("operatorShiftEnd").value;if(!a||!s){l(e("operators.nameRequired"),"error");return}try{t?(await m(`/operators/${t}`,{method:"PATCH",body:JSON.stringify({name:a,extension:s,skills:o,shift_start:i,shift_end:d})}),l(e("operators.operatorUpdated"))):(await m("/operators",{method:"POST",body:JSON.stringify({name:a,extension:s,skills:o,shift_start:i,shift_end:d})}),l(e("operators.operatorCreated"))),C("operatorModal"),U()}catch(g){l(e("operators.saveFailed",{error:g.message}),"error")}}async function va(t,a){if(a)try{await m(`/operators/${t}/status`,{method:"PATCH",body:JSON.stringify({status:a})}),l(e("operators.statusChanged",{status:a})),U()}catch(s){l(e("operators.statusFailed",{error:s.message}),"error")}}async function $a(t,a){if(confirm(e("operators.deactivateConfirm",{name:a})))try{await m(`/operators/${t}`,{method:"DELETE"}),l(e("operators.operatorDeactivated")),U()}catch(s){l(e("operators.deactivateFailed",{error:s.message}),"error")}}function ha(){P("operators",()=>{U(),be(),Oe(()=>{U(),be()},1e4)})}window._pages=window._pages||{};window._pages.operators={loadOperators:U,loadQueueStatus:be,showCreateOperator:ma,editOperator:ga,saveOperator:pa,changeOperatorStatus:va,deactivateOperator:$a};async function Qe(){const t=document.getElementById("systemInfo");t.innerHTML=`<div class="${E}"><div class="spinner"></div></div>`;try{const[a,s]=await Promise.all([fetch("/health").then(o=>o.json()),fetch("/health/ready").then(o=>o.json()).catch(()=>null)]);let n=`<div class="overflow-x-auto"><table class="${T}">
            <tr class="${$}"><td class="${r}">${e("settings.status")}</td><td class="${r}"><span class="${b}">${a.status}</span></td></tr>
            <tr class="${$}"><td class="${r}">${e("settings.activeCalls")}</td><td class="${r}">${a.active_calls}</td></tr>
            <tr class="${$}"><td class="${r}">${e("settings.redis")}</td><td class="${r}"><span class="${a.redis==="connected"?b:B}">${a.redis}</span></td></tr>
        `;s&&(s.store_api&&(n+=`<tr class="${$}"><td class="${r}">${e("settings.storeAPI")}</td><td class="${r}"><span class="${s.store_api==="reachable"?b:B}">${s.store_api}</span></td></tr>`),s.claude_api&&(n+=`<tr class="${$}"><td class="${r}">${e("settings.claudeAPI")}</td><td class="${r}"><span class="${s.claude_api==="reachable"?b:B}">${s.claude_api}</span></td></tr>`),s.google_stt&&(n+=`<tr class="${$}"><td class="${r}">${e("settings.googleSTT")}</td><td class="${r}"><span class="${s.google_stt==="credentials_present"?b:F}">${s.google_stt}</span></td></tr>`),s.tts_engine&&(n+=`<tr class="${$}"><td class="${r}">${e("settings.ttsEngine")}</td><td class="${r}"><span class="${s.tts_engine==="initialized"?b:F}">${s.tts_engine}</span></td></tr>`)),n+="</table></div>",t.innerHTML=n}catch(a){t.innerHTML=`<div class="${v}">${e("settings.failedToLoad",{error:c(a.message)})}
            <br><button class="${f} ${y} mt-2" onclick="window._pages.settings.loadSettings()">${e("common.retry")}</button></div>`}}async function ya(){const t=document.getElementById("extendedStatus");t.innerHTML=`<div class="${E}"><div class="spinner"></div></div>`;try{const a=await m("/admin/system-status"),s=Math.floor(a.uptime_seconds/3600),n=Math.floor(a.uptime_seconds%3600/60);let o=`<div class="overflow-x-auto"><table class="${T}">`;if(o+=`<tr class="${$}"><td class="${r}">${e("settings.extVersion")}</td><td class="${r}">${c(a.version||"unknown")}</td></tr>`,o+=`<tr class="${$}"><td class="${r}">${e("settings.uptime")}</td><td class="${r}">${e("settings.uptimeValue",{hours:s,minutes:n})}</td></tr>`,a.postgres_db_size_bytes){const i=(a.postgres_db_size_bytes/1048576).toFixed(1);o+=`<tr class="${$}"><td class="${r}">${e("settings.pgDbSize")}</td><td class="${r}">${i} MB</td></tr>`}if(a.postgres_connections!==void 0&&(o+=`<tr class="${$}"><td class="${r}">${e("settings.pgConnections")}</td><td class="${r}">${a.postgres_connections}</td></tr>`),a.redis_used_memory&&(o+=`<tr class="${$}"><td class="${r}">${e("settings.redisMemory")}</td><td class="${r}">${c(a.redis_used_memory)}</td></tr>`),o+=`<tr class="${$}"><td class="${r}">${e("settings.celeryWorkers")}</td><td class="${r}"><span class="${a.celery_workers_online>0?b:B}">${a.celery_workers_online}</span></td></tr>`,a.last_backup){const i=(a.last_backup.size_bytes/1048576).toFixed(1);o+=`<tr class="${$}"><td class="${r}">${e("settings.lastBackup")}</td><td class="${r}">${c(a.last_backup.file)} (${i} MB, ${c(a.last_backup.modified)})</td></tr>`}o+="</table></div>",t.innerHTML=o}catch(a){t.innerHTML=`<div class="${v}">${e("settings.extFailed",{error:c(a.message)})}</div>`}}async function fa(){if(confirm(e("settings.reloadConfirm")))try{const t=await m("/admin/config/reload",{method:"POST"});let a=e("settings.configReloaded");if(t.changes)for(const[s,n]of Object.entries(t.changes))a+=`${s}: ${n}
`;l(a,"success")}catch(t){l(e("settings.reloadFailed",{error:t.message}),"error")}}function wa(){P("settings",()=>Qe())}window._pages=window._pages||{};window._pages.settings={loadSettings:Qe,loadSystemStatus:ya,reloadConfig:fa};async function Z(){const t=document.getElementById("usersContainer");t.innerHTML=`<div class="${E}"><div class="spinner"></div></div>`;try{const s=(await m("/admin/users")).users||[];if(s.length===0){t.innerHTML=`<div class="${v}">${e("users.noUsers")}</div>`;return}t.innerHTML=`
            <div class="overflow-x-auto"><table class="${T}"><thead><tr><th class="${u}">${e("users.username")}</th><th class="${u}">${e("users.role")}</th><th class="${u}">${e("users.activeCol")}</th><th class="${u}">${e("users.lastLogin")}</th><th class="${u}">${e("users.actionsCol")}</th></tr></thead><tbody>
            ${s.map(n=>`
                <tr class="${$}">
                    <td class="${r}">${c(n.username)}</td>
                    <td class="${r}"><span class="${_}">${c(n.role)}</span></td>
                    <td class="${r}">${n.is_active?`<span class="${b}">${e("common.yes")}</span>`:`<span class="${B}">${e("common.no")}</span>`}</td>
                    <td class="${r}">${Q(n.last_login_at)}</td>
                    <td class="${r}">
                        <div class="flex flex-wrap items-center gap-1">
                            <select onchange="window._pages.users.changeRole('${n.id}', this.value)" class="${Ue}">
                                <option value="">${e("users.changeRole")}</option>
                                <option value="admin">${e("users.roleAdmin")}</option>
                                <option value="analyst">${e("users.roleAnalyst")}</option>
                                <option value="operator">${e("users.roleOperator")}</option>
                            </select>
                            <button class="${q} ${y}" onclick="window._pages.users.toggleUser('${n.id}', ${n.is_active})">${n.is_active?e("common.deactivate"):e("common.activate")}</button>
                            <button class="${pt} ${y}" onclick="window._pages.users.resetUserPassword('${n.id}', '${c(n.username)}')">${e("users.resetPwd")}</button>
                        </div>
                    </td>
                </tr>
            `).join("")}
            </tbody></table></div>
        `}catch(a){t.innerHTML=`<div class="${v}">${e("users.failedToLoad",{error:c(a.message)})}</div>`}}function ba(){document.getElementById("newUsername").value="",document.getElementById("newPassword").value="",document.getElementById("newRole").value="operator",document.getElementById("createUserModal").classList.add("show")}async function Ta(){const t=document.getElementById("newUsername").value.trim(),a=document.getElementById("newPassword").value,s=document.getElementById("newRole").value;if(!t||!a){l(e("users.usernameRequired"),"error");return}try{await m("/admin/users",{method:"POST",body:JSON.stringify({username:t,password:a,role:s})}),C("createUserModal"),l(e("users.userCreated")),Z()}catch(n){l(e("users.createFailed",{error:n.message}),"error")}}async function ka(t,a){if(a)try{await m(`/admin/users/${t}`,{method:"PATCH",body:JSON.stringify({role:a})}),l(e("users.roleUpdated")),Z()}catch(s){l(e("users.roleFailed",{error:s.message}),"error")}}async function Ba(t,a){try{await m(`/admin/users/${t}`,{method:"PATCH",body:JSON.stringify({is_active:!a})}),l(e(a?"users.userDeactivated":"users.userActivated")),Z()}catch(s){l(e("users.toggleFailed",{error:s.message}),"error")}}async function Ea(t,a){const s=prompt(e("users.newPasswordPrompt",{username:a}));if(s)try{await m(`/admin/users/${t}/reset-password`,{method:"POST",body:JSON.stringify({new_password:s})}),l(e("users.passwordReset"))}catch(n){l(e("users.resetFailed",{error:n.message}),"error")}}function Sa(){P("users",()=>Z())}window._pages=window._pages||{};window._pages.users={loadUsers:Z,showCreateUser:ba,createUser:Ta,changeRole:ka,toggleUser:Ba,resetUserPassword:Ea};async function Ke(t=0){const a=document.getElementById("auditContainer");a.innerHTML=`<div class="${E}"><div class="spinner"></div></div>`;const s=new URLSearchParams({limit:50,offset:t}),n=document.getElementById("auditDateFrom").value,o=document.getElementById("auditDateTo").value,i=document.getElementById("auditAction").value;n&&s.set("date_from",n),o&&s.set("date_to",o),i&&s.set("action",i);try{const d=await m(`/admin/audit-log?${s}`),g=d.entries||[];if(g.length===0){a.innerHTML=`<div class="${v}">${e("audit.noEntries")}</div>`,document.getElementById("auditPagination").innerHTML="";return}a.innerHTML=`
            <div class="overflow-x-auto"><table class="${T}"><thead><tr><th class="${u}">${e("audit.date")}</th><th class="${u}">${e("audit.user")}</th><th class="${u}">${e("audit.action")}</th><th class="${u}">${e("audit.resource")}</th><th class="${u}">${e("audit.ip")}</th></tr></thead><tbody>
            ${g.map(w=>`
                <tr class="${$}">
                    <td class="${r}">${Q(w.created_at)}</td>
                    <td class="${r}">${c(w.username)||"-"}</td>
                    <td class="${r}"><span class="${_}">${c(w.action)}</span></td>
                    <td class="${r}">${c(w.resource_type||"")}${w.resource_id?"/"+c(w.resource_id):""}</td>
                    <td class="${r}">${c(w.ip_address)||"-"}</td>
                </tr>
            `).join("")}
            </tbody></table></div>
        `;const p=Math.ceil(d.total/50),h=Math.floor(t/50);document.getElementById("auditPagination").innerHTML=Array.from({length:Math.min(p,10)},(w,K)=>`<button class="${Ie}${K===h?" active":""}" onclick="window._pages.audit.loadAuditLog(${K*50})">${K+1}</button>`).join("")}catch(d){a.innerHTML=`<div class="${v}">${e("audit.failedToLoad",{error:c(d.message)})}</div>`}}function Ia(){P("audit",()=>Ke())}window._pages=window._pages||{};window._pages.audit={loadAuditLog:Ke};let D="brands",pe=null,V="",We=null,ie="";const H=50;async function Ge(){const t=document.getElementById("vehiclesStats");t.innerHTML=`<div class="${E}"><div class="spinner"></div></div>`;try{const a=await m("/admin/vehicles/stats");a.source_path&&(t.dataset.lastSourcePath=a.source_path),t.innerHTML=`
            <div class="${S}"><div class="${I}">${a.brand_count??0}</div><div class="${x}">${e("vehicles.brands")}</div></div>
            <div class="${S}"><div class="${I}">${a.model_count??0}</div><div class="${x}">${e("vehicles.models")}</div></div>
            <div class="${S}"><div class="${I}">${a.kit_count??0}</div><div class="${x}">${e("vehicles.kits")}</div></div>
            <div class="${S}"><div class="${I}">${a.tire_size_count??0}</div><div class="${x}">${e("vehicles.tireSizes")}</div></div>
            <div class="${S}"><div class="${I}">${a.imported_at?Q(a.imported_at):e("vehicles.neverImported")}</div><div class="${x}">${e("vehicles.lastImport")}</div></div>
        `}catch(a){t.innerHTML=`<div class="${v}">${e("vehicles.failedToLoad",{error:c(a.message)})}</div>`}}function _e(){const t=document.getElementById("vehiclesBreadcrumb");if(D==="brands"){t.style.display="none";return}t.style.display="";let a=`<a href="#" class="${Ae}" onclick="window._pages.vehicles.goToBrands()">${e("vehicles.brands")}</a>`;(D==="models"||D==="kits")&&(a+=` / <span>${c(V)}</span>`),D==="kits"&&(a+=` / <a href="#" class="${Ae}" onclick="window._pages.vehicles.goToModels()">${e("vehicles.models")}</a>`,a+=` / <span>${c(ie)}</span>`),t.innerHTML=a}async function ee(t=0){D="brands",_e();const a=document.getElementById("vehiclesContainer");a.innerHTML=`<div class="${E}"><div class="spinner"></div></div>`;const s=new URLSearchParams({limit:H,offset:t}),n=document.getElementById("vehiclesSearch").value.trim();n&&s.set("search",n);try{const o=await m(`/admin/vehicles/brands?${s}`),i=o.items||[];if(i.length===0){a.innerHTML=`<div class="${v}">${e("vehicles.noData")}</div>`,document.getElementById("vehiclesPagination").innerHTML="";return}a.innerHTML=`
            <div class="overflow-x-auto"><table class="${T}">
            <thead><tr>
                <th class="${u}">${e("vehicles.brand")}</th>
                <th class="${u}">${e("vehicles.models")}</th>
            </tr></thead>
            <tbody>
            ${i.map(d=>`
                <tr class="${$} cursor-pointer" onclick="window._pages.vehicles.selectBrand(${d.id}, '${c(d.name).replace(/'/g,"\\'")}')">
                    <td class="${r}">${c(d.name)}</td>
                    <td class="${r}">${d.model_count}</td>
                </tr>
            `).join("")}
            </tbody></table></div>
        `,Le(o.total,t,"loadBrands")}catch(o){a.innerHTML=`<div class="${v}">${e("vehicles.failedToLoad",{error:c(o.message)})}</div>`}}async function te(t,a,s=0){pe=t,V=a||V,D="models",_e();const n=document.getElementById("vehiclesContainer");n.innerHTML=`<div class="${E}"><div class="spinner"></div></div>`;const o=new URLSearchParams({limit:H,offset:s}),i=document.getElementById("vehiclesSearch").value.trim();i&&o.set("search",i);try{const d=await m(`/admin/vehicles/brands/${t}/models?${o}`),g=d.items||[];if(g.length===0){n.innerHTML=`
                <button class="${q} mb-3" onclick="window._pages.vehicles.goToBrands()">${e("vehicles.back")}</button>
                <div class="${v}">${e("vehicles.noData")}</div>
            `,document.getElementById("vehiclesPagination").innerHTML="";return}n.innerHTML=`
            <button class="${q} mb-3" onclick="window._pages.vehicles.goToBrands()">${e("vehicles.back")}</button>
            <div class="overflow-x-auto"><table class="${T}">
            <thead><tr>
                <th class="${u}">${e("vehicles.model")}</th>
                <th class="${u}">${e("vehicles.kits")}</th>
            </tr></thead>
            <tbody>
            ${g.map(p=>`
                <tr class="${$} cursor-pointer" onclick="window._pages.vehicles.selectModel(${p.id}, '${c(p.name).replace(/'/g,"\\'")}')">
                    <td class="${r}">${c(p.name)}</td>
                    <td class="${r}">${p.kit_count}</td>
                </tr>
            `).join("")}
            </tbody></table></div>
        `,Le(d.total,s,"loadModelsPage")}catch(d){n.innerHTML=`<div class="${v}">${e("vehicles.failedToLoad",{error:c(d.message)})}</div>`}}async function Ce(t,a,s=0){We=t,ie=a||ie,D="kits",_e();const n=document.getElementById("vehiclesContainer");n.innerHTML=`<div class="${E}"><div class="spinner"></div></div>`;const o=new URLSearchParams({limit:H,offset:s});try{const i=await m(`/admin/vehicles/models/${t}/kits?${o}`),d=i.items||[];if(d.length===0){n.innerHTML=`
                <button class="${q} mb-3" onclick="window._pages.vehicles.goToModels()">${e("vehicles.back")}</button>
                <div class="${v}">${e("vehicles.noData")}</div>
            `,document.getElementById("vehiclesPagination").innerHTML="";return}n.innerHTML=`
            <button class="${q} mb-3" onclick="window._pages.vehicles.goToModels()">${e("vehicles.back")}</button>
            <div class="overflow-x-auto"><table class="${T}">
            <thead><tr>
                <th class="${u}">${e("vehicles.year")}</th>
                <th class="${u}">${e("vehicles.trim")}</th>
                <th class="${u}">${e("vehicles.pcd")}</th>
                <th class="${u}">${e("vehicles.bolts")}</th>
                <th class="${u}">${e("vehicles.dia")}</th>
                <th class="${u}">${e("vehicles.tireSizes")}</th>
                <th class="${u}"></th>
            </tr></thead>
            <tbody>
            ${d.map(g=>`
                <tr class="${$}">
                    <td class="${r}">${g.year}</td>
                    <td class="${r}">${c(g.name||"-")}</td>
                    <td class="${r}">${g.pcd??"-"}</td>
                    <td class="${r}">${g.bolt_count??"-"}${g.bolt_size?" / "+c(g.bolt_size):""}</td>
                    <td class="${r}">${g.dia??"-"}</td>
                    <td class="${r}">${g.tire_size_count}</td>
                    <td class="${r}">
                        <button class="${f} ${y}" onclick="window._pages.vehicles.toggleTireSizes(this, ${g.id})">${e("vehicles.tireSizes")}</button>
                    </td>
                </tr>
                <tr class="tire-sizes-row" id="tire-sizes-${g.id}" style="display:none">
                    <td colspan="7" class="${r} bg-neutral-50 dark:bg-neutral-800/50"></td>
                </tr>
            `).join("")}
            </tbody></table></div>
        `,Le(i.total,s,"loadKitsPage")}catch(i){n.innerHTML=`<div class="${v}">${e("vehicles.failedToLoad",{error:c(i.message)})}</div>`}}async function xa(t,a){const s=document.getElementById(`tire-sizes-${a}`);if(!s)return;if(s.style.display!=="none"){s.style.display="none";return}s.style.display="";const n=s.querySelector("td");n.innerHTML=`<div class="${E}"><div class="spinner"></div></div>`;try{const i=(await m(`/admin/vehicles/kits/${a}/tire-sizes`)).items||[];if(i.length===0){n.innerHTML=`<div class="${v}">${e("vehicles.noData")}</div>`;return}const d=h=>e(h===1?"vehicles.stock":"vehicles.tuning"),g=h=>h===1?b:_,p=h=>e(h===1?"vehicles.front":h===2?"vehicles.rear":"vehicles.all");n.innerHTML=`
            <table class="${T}">
            <thead><tr>
                <th class="${u}">${e("vehicles.size")}</th>
                <th class="${u}">${e("vehicles.type")}</th>
                <th class="${u}">${e("vehicles.axle")}</th>
            </tr></thead>
            <tbody>
            ${i.map(h=>`
                <tr class="${$}">
                    <td class="${r}">${h.width}/${h.height} R${h.diameter}</td>
                    <td class="${r}"><span class="${g(h.type)}">${d(h.type)}</span></td>
                    <td class="${r}">${p(h.axle)}</td>
                </tr>
            `).join("")}
            </tbody></table>
        `}catch(o){n.innerHTML=`<div class="${v}">${e("vehicles.failedToLoad",{error:c(o.message)})}</div>`}}function Le(t,a,s){const n=Math.ceil(t/H),o=Math.floor(a/H);document.getElementById("vehiclesPagination").innerHTML=Array.from({length:Math.min(n,10)},(i,d)=>`<button class="${Ie}${d===o?" active":""}" onclick="window._pages.vehicles.${s}(${d*H})">${d+1}</button>`).join("")}function _a(t,a){document.getElementById("vehiclesSearch").value="",te(t,a)}function Ca(t,a){document.getElementById("vehiclesSearch").value="",Ce(t,a)}function La(){document.getElementById("vehiclesSearch").value="",ee()}function Pa(){document.getElementById("vehiclesSearch").value="",te(pe,V)}function Aa(t){te(pe,V,t)}function Da(t){Ce(We,ie,t)}function Ma(){D==="brands"?ee():D==="models"&&te(pe,V)}function Fa(){var n;const t=document.getElementById("vehiclesStats"),a=(n=t==null?void 0:t.dataset)==null?void 0:n.lastSourcePath,s=document.getElementById("vehicleImportPath");s&&a&&(s.value=a),document.getElementById("vehicleImportModal").classList.add("show")}async function Ra(){const t=document.getElementById("vehicleImportPath").value.trim();if(!t){l(e("vehicles.importPathRequired"),"error");return}const a=document.getElementById("vehicleImportBtn"),s=a.textContent;a.disabled=!0,a.textContent=e("common.loading");try{const n=await m("/admin/vehicles/import",{method:"POST",body:JSON.stringify({csv_dir:t})});C("vehicleImportModal"),l(e("vehicles.importSuccess",{brands:n.brand_count??0,models:n.model_count??0,kits:n.kit_count??0,tireSizes:n.tire_size_count??0})),Ge(),ee()}catch(n){l(e("vehicles.importFailed",{error:c(n.message)}),"error")}finally{a.disabled=!1,a.textContent=s}}function Oa(){P("vehicles",()=>{Ge(),ee()})}window._pages=window._pages||{};window._pages.vehicles={loadBrands:ee,loadModels:te,loadKits:Ce,loadModelsPage:Aa,loadKitsPage:Da,selectBrand:_a,selectModel:Ca,goToBrands:La,goToModels:Pa,toggleTireSizes:xa,search:Ma,openImportModal:Fa,runImport:Ra};et();Tt();Me();It();Pt();ua();ha();wa();Sa();Ia();Oa();lt(t=>{const a=localStorage.getItem("admin_active_page")||"dashboard";(t.type==="call:started"||t.type==="call:ended"||t.type==="call:transferred")&&(a==="dashboard"&&window._pages.dashboard.loadDashboard(),a==="calls"&&window._pages.calls.loadCalls(Lt())),t.type==="operator:status_changed"&&a==="operators"&&(window._pages.operators.loadOperators(),window._pages.operators.loadQueueStatus()),t.type==="dashboard:metrics_updated"&&a==="dashboard"&&window._pages.dashboard.loadDashboard()});setInterval(qe,6e4);if(O()&&(qe(),O())){document.getElementById("loginContainer").style.display="none",document.getElementById("app").style.display="block",Ne(),Be();const t=localStorage.getItem("admin_active_page")||"dashboard";le(t)}document.getElementById("loginPassword").addEventListener("keypress",t=>{t.key==="Enter"&&He()});document.addEventListener("keydown",t=>{t.key==="Escape"&&document.querySelectorAll(".modal-overlay.show").forEach(a=>a.classList.remove("show"))});function Na(){document.getElementById("sidebar").classList.toggle("open")}document.querySelectorAll(".sidebar a").forEach(t=>{t.addEventListener("click",()=>{window.innerWidth<=768&&document.getElementById("sidebar").classList.remove("open")})});window.addEventListener("langchange",()=>{Bt(),ut();const t=localStorage.getItem("admin_active_page")||"dashboard";le(t)});window._app={login:He,logout:Se,showPage:le,closeModal:C,toggleSidebar:Na,toggleTheme:kt,toggleLang:tt};
