# Аудит документации проекта (doc/) — замечания и предложения

Дата: 2026-02-13

## Что уже хорошо

- Документация структурирована по аудиториям (`doc/README.md`) и покрывает бизнес, технику, безопасность и планирование.
- Архитектура и NFR описаны достаточно конкретно: есть протокол AudioSocket, состояния сессии, деградация, требования по latency.
- В security-блоке есть STRIDE, матрица рисков и понятные митигации (лимиты, подтверждения, ротация секретов).

## Замечания по документации (несостыковки/ошибки)

1) `doc/audit-report.md` выглядит устаревшим и противоречит текущим документам.
- Там сказано, что нет ротации, CI/CD, стратегии тестирования и т.п., но это уже описано в `doc/security/threat-model.md` и `doc/development/00-overview.md`.
- Предложение: обновить этот файл под актуальное состояние или явно пометить как «исторический черновик/пример».

2) `doc/development/setup-local.md` содержит явные артефакты текста ("Oración ...") в разделе про SIP-клиенты.
- Это похоже на повреждение вставки/кодировки и снижает доверие к инструкции.
- Предложение: заменить на конкретный список (например: Linphone / Zoiper / MicroSIP) и короткий пример конфигурации.

3) Несогласованность формулировок про «запись звонка».
- `doc/security/data-policy.md` утверждает, что аудио НЕ хранится, но в `doc/technical/nfr.md` есть формулировка про «звонок может записываться», а в чек-листе — «уведомление о записи».
- Предложение: унифицировать текст на «может обрабатываться автоматизированной системой; аудио не сохраняется; сохраняется транскрипция на срок N».

4) Несогласованность названий tools/функций между документами.
- В `doc/development/00-overview.md` встречается `create_order()`, в `doc/development/phase-2-orders.md` — `create_order_draft`, в `doc/technical/sequence-diagrams.md` — `create_order_draft/update_order_delivery/confirm_order`, в `doc/technical/architecture.md` — `create_order`.
- Предложение: завести «канонический» список tools и ссылаться на него во всех фазах (один источник правды).

5) Инструкции по экспорту env переменных в `doc/development/setup-local.md` небезопасны для shell.
- `export $(cat .env.local | ... | xargs)` ломается на пробелах и может выполнять неожиданные значения.
- Предложение: заменить на `set -a; . ./.env.local; set +a` или использовать `direnv`.

## Предложения по улучшению проекта (по мотивам doc/)

### Документация как продукт

- Добавить "Док-статус" в каждый ключевой документ: владелец, дата актуализации, версия, ссылка на реализацию/issue.
- Ввести глоссарий терминов и единый словарь (Call Processor/Session Manager/Store API, call_id/uuid, scenario).
- Сделать таблицу соответствия "Документ → артефакт": например, `doc/development/00-overview.md` ↔ реальные файлы конфигурации CI, docker-compose, health endpoints.

### API и интеграции (Store API)

- Идемпотентность для создания черновиков/подтверждений заказа: поддержать `Idempotency-Key` и описать поведение при ретраях (иначе легко получить дубликаты заказов).
- Стандартизировать ошибки: добавить `429` (rate limit), `503` (temporary), `request_id` в ответах; описать ретраи и таймауты клиента.
- Описать контракты PII: какие поля агент имеет право отправлять в Store API/LLM, и какие должны редактироваться/маскироваться.

### Безопасность и эксплуатация

- Для межсерверного AudioSocket (Asterisk ↔ Call Processor) добавить рекомендацию по защищенному каналу: WireGuard/VPN или TLS-туннель (если не localhost).
- Описать минимальный hardening для Asterisk (SIP TLS/SRTP, fail2ban профили, лимиты на звонки/гео) в одном месте и ссылаться из чек-листа.
- Добавить требование корреляции логов: единый `call_id`/`request_id` проходит через STT/LLM/TTS/tool calls/Store API, плюс структурированный формат событий.

### Производительность и надежность

- В документации есть SLO по latency, но не описан «бюджет» по компонентам как обязательный контракт (в troubleshooting он есть) — стоит поднять это в `doc/technical/nfr.md`.
- Для PostgreSQL логов: рекомендовать партиционирование `calls/call_turns/call_tool_calls` по дате и стратегии индексации, иначе аналитика быстро станет дорогой.

### Тестирование

- E2E через SIPp описан концептуально; полезно зафиксировать минимальный “smoke pack”: 3–5 сценариев + критерии (p95 latency, отсутствие tool-call аномалий).
- Для prompt-injection добавить «красную команду» чек-лист фраз и ожидаемое поведение (это уже частично есть в `deployment-checklist.md`, можно расширить).

## Быстрые правки (high impact / low effort)

- Починить раздел про SIP-клиент в `doc/development/setup-local.md` (убрать артефакты) и поправить загрузку env.
- Обновить/переписать `doc/audit-report.md`, чтобы он не противоречил текущей документации.
- Унифицировать названия tools (один список + ссылки) и формулировки про «запись/обработку» звонков.
