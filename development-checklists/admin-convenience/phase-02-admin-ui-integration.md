# Фаза 2: Интеграция Admin UI с API

## Статус
- [ ] Не начата
- [ ] В процессе
- [ ] Завершена

**Начата:** -
**Завершена:** -

## Цель фазы
Подключить существующий веб-интерфейс `admin-ui/index.html` к реальным API-эндпоинтам.
Администратор должен видеть живые данные: звонки, статистику, промпты, базу знаний.

## Задачи

### 2.0 ОБЯЗАТЕЛЬНО: Анализ и планирование

#### A. Анализ существующего кода
- [ ] Изучить `admin-ui/index.html` — текущий UI (vanilla JS, ~471 строк)
- [ ] Изучить `src/api/auth.py` — механизм авторизации (JWT)
- [ ] Изучить `src/api/analytics.py` — API аналитики (формат ответов, фильтры, пагинация)
- [ ] Изучить `src/api/prompts.py` — API промптов (формат ответов)
- [ ] Изучить `src/api/knowledge.py` — API базы знаний
- [ ] Изучить `src/main.py` — как подключён `/admin` маршрут

**Команды для поиска:**
```bash
# Структура admin-ui
wc -l admin-ui/index.html
# API роутеры
grep -rn "router\." src/api/analytics.py
# Формат ответов API
grep -rn "class.*Response\|class.*Schema" src/api/
# Как подключён admin UI
grep -rn "admin" src/main.py
```

#### B. Анализ зависимостей
- [ ] Нужны ли новые API-эндпоинты для UI? (проверить соответствие JS-запросов и существующих API)
- [ ] Нужны ли CORS-заголовки для локальной разработки?
- [ ] Нужна ли библиотека для графиков? (Chart.js или встроенный Grafana iframe)

**Новые абстракции:** нет
**Новые env variables:** нет (используются существующие ADMIN_USERNAME, ADMIN_PASSWORD)
**Новые tools:** нет
**Миграции БД:** нет

#### C. Проверка архитектуры
- [ ] Vanilla JS или переход на фреймворк? (на этой фазе — оставить vanilla JS, минимальные изменения)
- [ ] API prefix: `/api/v1/` или текущий формат?
- [ ] Нужен ли CSRF-токен для мутирующих запросов?

**Референс-модуль:** `admin-ui/index.html` (текущая реализация UI)

**Цель:** Понять текущий UI и сопоставить JS-вызовы с реальными API-эндпоинтами.

**Заметки для переиспользования:** -

---

### 2.1 Исправить авторизацию в Admin UI
- [ ] Убрать захардкоженные credentials из JavaScript
- [ ] Подключить форму логина к `POST /auth/login`
- [ ] Сохранять JWT-токен в `localStorage` (уже есть, проверить корректность)
- [ ] Добавить перехватчик: при 401 ответе — редирект на логин
- [ ] Добавить кнопку «Выход» — очистка токена и редирект
- [ ] Добавить автоматический logout при истечении JWT (24h)

**Файлы:** `admin-ui/index.html`
**Заметки:** JWT токен передаётся в заголовке `Authorization: Bearer <token>`. Проверить формат ответа `POST /auth/login`.

---

### 2.2 Подключить Dashboard к реальным данным
- [ ] Вызывать `GET /analytics/summary` при загрузке дашборда
- [ ] Отобразить в карточках: звонки сегодня, resolved by bot %, transferred %, avg quality, cost
- [ ] Подключить Grafana iframe с реальным URL (из конфигурации или env)
- [ ] Добавить автообновление данных каждые 30 секунд
- [ ] Обработать состояние загрузки (спиннер) и ошибки (сообщение)

**Файлы:** `admin-ui/index.html`
**Заметки:** `GET /analytics/summary` возвращает `daily_stats` за последние 90 дней. Для дашборда нужна запись за сегодня.

---

### 2.3 Подключить журнал звонков
- [ ] Вызывать `GET /analytics/calls` с фильтрами (дата, сценарий, transferred, quality, search)
- [ ] Отобразить таблицу звонков с пагинацией (20 записей на страницу)
- [ ] При клике на звонок — вызвать `GET /analytics/calls/{id}`
- [ ] Отобразить в модальном окне: транскрипцию, tool calls, quality breakdown, стоимость
- [ ] Подключить фильтры к реальным параметрам API (query params)
- [ ] Обработать пустой результат: «Звонков не найдено»

**Файлы:** `admin-ui/index.html`
**Заметки:** API поддерживает фильтры: `date_from`, `date_to`, `scenario`, `transferred`, `min_quality`, `search`, `page`, `per_page`, `sort_by`, `sort_order`.

---

### 2.4 Подключить управление промптами
- [ ] Загрузить список версий: `GET /prompts`
- [ ] Отобразить таблицу: версия, дата создания, автор, статус (active/inactive)
- [ ] Кнопка «Активировать» → `PATCH /prompts/{id}/activate` с подтверждением
- [ ] Форма создания новой версии → `POST /prompts` (текстовое поле для system prompt)
- [ ] Загрузить A/B тесты: `GET /prompts/ab-tests`
- [ ] Отобразить активные тесты с метриками по вариантам
- [ ] Кнопка «Остановить тест» → `PATCH /prompts/ab-tests/{id}/stop`

**Файлы:** `admin-ui/index.html`
**Заметки:** Промпт — длинный текст. Использовать `<textarea>` с достаточной высотой. Показывать diff между версиями — nice to have, не обязательно.

---

### 2.5 Подключить базу знаний
- [ ] Загрузить статьи: `GET /knowledge/articles`
- [ ] Отобразить список с фильтром по категории и поиском
- [ ] Форма создания/редактирования статьи → `POST /knowledge/articles`, `PATCH /knowledge/articles/{id}`
- [ ] Кнопка удаления → `DELETE /knowledge/articles/{id}` с подтверждением
- [ ] Переключение статуса active/inactive

**Файлы:** `admin-ui/index.html`
**Заметки:** Категории: brands, guides, faq, comparisons. Статьи в формате markdown.

---

### 2.6 Подключить страницу Settings
- [ ] Вызвать `GET /health` и `GET /health/ready` — показать статус всех компонентов
- [ ] Отобразить: статус Redis, Store API, Google STT, Claude API, Google TTS
- [ ] Показать количество активных звонков
- [ ] Показать текущую версию приложения
- [ ] Добавить кнопку «Проверить подключение» — повторный вызов health check

**Файлы:** `admin-ui/index.html`
**Заметки:** `GET /health/ready` возвращает статус каждого компонента. Формат ответа надо уточнить по коду.

---

### 2.7 Улучшения UX
- [ ] Добавить индикатор загрузки (спиннер) для всех API-запросов
- [ ] Добавить toast-уведомления при успешных операциях (активация промпта, создание статьи)
- [ ] Добавить обработку сетевых ошибок с retry-кнопкой
- [ ] Добавить хлебные крошки (breadcrumbs) для навигации
- [ ] Сохранять последнюю активную вкладку в `localStorage`

**Файлы:** `admin-ui/index.html`
**Заметки:** Минимальный UX-минимум. Не усложнять — проект на vanilla JS.

---

### 2.8 Тестирование интеграции UI
- [ ] Проверить работу UI с реальным API (ручное тестирование)
- [ ] Проверить авторизацию: логин, logout, expired token
- [ ] Проверить все CRUD-операции: промпты, база знаний
- [ ] Проверить фильтры и пагинацию в журнале звонков
- [ ] Проверить обработку ошибок: сервер недоступен, 500, невалидные данные

**Файлы:** -
**Заметки:** Интеграционное тестирование UI. Написать чеклист ручных проверок если автотесты невозможны.

---

## При завершении фазы

Выполни следующие действия:

1. Убедись, что все задачи отмечены [x]
2. Измени статус фазы:
   - [x] Завершена
3. Заполни дату "Завершена: YYYY-MM-DD"
4. Выполни коммит:
   ```bash
   git add .
   git commit -m "checklist(admin-convenience): phase-2 admin UI integration completed"
   ```
5. Обнови PROGRESS.md:
   - Текущая фаза: 3
   - Добавь запись в историю
6. Открой следующую фазу и продолжи работу
