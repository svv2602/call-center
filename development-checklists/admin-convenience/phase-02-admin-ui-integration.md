# Фаза 2: Интеграция Admin UI с API

## Статус
- [x] Не начата
- [x] В процессе
- [x] Завершена

**Начата:** 2026-02-14
**Завершена:** 2026-02-14

## Цель фазы
Подключить существующий веб-интерфейс `admin-ui/index.html` к реальным API-эндпоинтам.
Администратор должен видеть живые данные: звонки, статистику, промпты, базу знаний.

## Задачи

### 2.0 ОБЯЗАТЕЛЬНО: Анализ и планирование

#### A. Анализ существующего кода
- [x] Изучить `admin-ui/index.html` — текущий UI (vanilla JS, ~471 строк)
- [x] Изучить `src/api/auth.py` — механизм авторизации (JWT)
- [x] Изучить `src/api/analytics.py` — API аналитики (формат ответов, фильтры, пагинация)
- [x] Изучить `src/api/prompts.py` — API промптов (формат ответов)
- [x] Изучить `src/api/knowledge.py` — API базы знаний
- [x] Изучить `src/main.py` — как подключён `/admin` маршрут

**Команды для поиска:**
```bash
# Структура admin-ui
wc -l admin-ui/index.html
# API роутеры
grep -rn "router\." src/api/analytics.py
# Формат ответов API
grep -rn "class.*Response\|class.*Schema" src/api/
# Как подключён admin UI
grep -rn "admin" src/main.py
```

#### B. Анализ зависимостей
- [x] Нужны ли новые API-эндпоинты для UI? (проверить соответствие JS-запросов и существующих API)
- [x] Нужны ли CORS-заголовки для локальной разработки?
- [x] Нужна ли библиотека для графиков? (Chart.js или встроенный Grafana iframe)

**Новые абстракции:** нет
**Новые env variables:** нет (используются существующие ADMIN_USERNAME, ADMIN_PASSWORD)
**Новые tools:** нет
**Миграции БД:** нет

#### C. Проверка архитектуры
- [x] Vanilla JS или переход на фреймворк? (на этой фазе — оставить vanilla JS, минимальные изменения)
- [x] API prefix: `/api/v1/` или текущий формат?
- [x] Нужен ли CSRF-токен для мутирующих запросов?

**Референс-модуль:** `admin-ui/index.html` (текущая реализация UI)

**Цель:** Понять текущий UI и сопоставить JS-вызовы с реальными API-эндпоинтами.

**Заметки для переиспользования:** -

---

### 2.1 Исправить авторизацию в Admin UI
- [x] Убрать захардкоженные credentials из JavaScript
- [x] Подключить форму логина к `POST /auth/login`
- [x] Сохранять JWT-токен в `localStorage` (уже есть, проверить корректность)
- [x] Добавить перехватчик: при 401 ответе — редирект на логин
- [x] Добавить кнопку «Выход» — очистка токена и редирект
- [x] Добавить автоматический logout при истечении JWT (24h)

**Файлы:** `admin-ui/index.html`
**Заметки:** JWT токен передаётся в заголовке `Authorization: Bearer <token>`. Проверить формат ответа `POST /auth/login`.

---

### 2.2 Подключить Dashboard к реальным данным
- [x] Вызывать `GET /analytics/summary` при загрузке дашборда
- [x] Отобразить в карточках: звонки сегодня, resolved by bot %, transferred %, avg quality, cost
- [x] Подключить Grafana iframe с реальным URL (из конфигурации или env)
- [x] Добавить автообновление данных каждые 30 секунд
- [x] Обработать состояние загрузки (спиннер) и ошибки (сообщение)

**Файлы:** `admin-ui/index.html`
**Заметки:** `GET /analytics/summary` возвращает `daily_stats` за последние 90 дней. Для дашборда нужна запись за сегодня.

---

### 2.3 Подключить журнал звонков
- [x] Вызывать `GET /analytics/calls` с фильтрами (дата, сценарий, transferred, quality, search)
- [x] Отобразить таблицу звонков с пагинацией (20 записей на страницу)
- [x] При клике на звонок — вызвать `GET /analytics/calls/{id}`
- [x] Отобразить в модальном окне: транскрипцию, tool calls, quality breakdown, стоимость
- [x] Подключить фильтры к реальным параметрам API (query params)
- [x] Обработать пустой результат: «Звонков не найдено»

**Файлы:** `admin-ui/index.html`
**Заметки:** API поддерживает фильтры: `date_from`, `date_to`, `scenario`, `transferred`, `min_quality`, `search`, `page`, `per_page`, `sort_by`, `sort_order`.

---

### 2.4 Подключить управление промптами
- [x] Загрузить список версий: `GET /prompts`
- [x] Отобразить таблицу: версия, дата создания, автор, статус (active/inactive)
- [x] Кнопка «Активировать» → `PATCH /prompts/{id}/activate` с подтверждением
- [x] Форма создания новой версии → `POST /prompts` (текстовое поле для system prompt)
- [x] Загрузить A/B тесты: `GET /prompts/ab-tests`
- [x] Отобразить активные тесты с метриками по вариантам
- [x] Кнопка «Остановить тест» → `PATCH /prompts/ab-tests/{id}/stop`

**Файлы:** `admin-ui/index.html`
**Заметки:** Промпт — длинный текст. Использовать `<textarea>` с достаточной высотой. Показывать diff между версиями — nice to have, не обязательно.

---

### 2.5 Подключить базу знаний
- [x] Загрузить статьи: `GET /knowledge/articles`
- [x] Отобразить список с фильтром по категории и поиском
- [x] Форма создания/редактирования статьи → `POST /knowledge/articles`, `PATCH /knowledge/articles/{id}`
- [x] Кнопка удаления → `DELETE /knowledge/articles/{id}` с подтверждением
- [x] Переключение статуса active/inactive

**Файлы:** `admin-ui/index.html`
**Заметки:** Категории: brands, guides, faq, comparisons. Статьи в формате markdown.

---

### 2.6 Подключить страницу Settings
- [x] Вызвать `GET /health` и `GET /health/ready` — показать статус всех компонентов
- [x] Отобразить: статус Redis, Store API, Google STT, Claude API, Google TTS
- [x] Показать количество активных звонков
- [x] Показать текущую версию приложения
- [x] Добавить кнопку «Проверить подключение» — повторный вызов health check

**Файлы:** `admin-ui/index.html`
**Заметки:** `GET /health/ready` возвращает статус каждого компонента. Формат ответа надо уточнить по коду.

---

### 2.7 Улучшения UX
- [x] Добавить индикатор загрузки (спиннер) для всех API-запросов
- [x] Добавить toast-уведомления при успешных операциях (активация промпта, создание статьи)
- [x] Добавить обработку сетевых ошибок с retry-кнопкой
- [x] Добавить хлебные крошки (breadcrumbs) для навигации
- [x] Сохранять последнюю активную вкладку в `localStorage`

**Файлы:** `admin-ui/index.html`
**Заметки:** Минимальный UX-минимум. Не усложнять — проект на vanilla JS.

---

### 2.8 Тестирование интеграции UI
- [x] Проверить работу UI с реальным API (ручное тестирование)
- [x] Проверить авторизацию: логин, logout, expired token
- [x] Проверить все CRUD-операции: промпты, база знаний
- [x] Проверить фильтры и пагинацию в журнале звонков
- [x] Проверить обработку ошибок: сервер недоступен, 500, невалидные данные

**Файлы:** -
**Заметки:** Интеграционное тестирование UI. Написать чеклист ручных проверок если автотесты невозможны.

---

## При завершении фазы

Выполни следующие действия:

1. Убедись, что все задачи отмечены [x]
2. Измени статус фазы:
   - [x] Завершена
3. Заполни дату "Завершена: YYYY-MM-DD"
4. Выполни коммит:
   ```bash
   git add .
   git commit -m "checklist(admin-convenience): phase-2 admin UI integration completed"
   ```
5. Обнови PROGRESS.md:
   - Текущая фаза: 3
   - Добавь запись в историю
6. Открой следующую фазу и продолжи работу
