# Фаза 5: Тестирование заказов

## Статус
- [x] Не начата
- [x] В процессе
- [x] Завершена

**Начата:** 2026-02-14
**Завершена:** 2026-02-14

## Цель фазы

Полное тестирование функциональности заказов: unit-тесты новых tools, тесты Store Client, adversarial-тесты безопасности заказов, интеграционные и E2E тесты.

## Задачи

### 5.0 ОБЯЗАТЕЛЬНО: Анализ и планирование

#### A. Анализ существующего кода
- [x] Проверить существующие тесты из phase-1 (паттерны, fixtures)
- [x] Проверить mock-реализации
- [x] Определить новые тестовые сценарии

#### B. Анализ зависимостей
- [x] Существующие fixtures из phase-1 можно переиспользовать
- [x] Новые mocks для order endpoints

**Референс-модуль:** Существующие тесты из phase-1

**Цель:** Определить полный план тестирования заказов.

**Заметки для переиспользования:** 124 теста всего (68 phase-1 + 56 phase-2), все проходят за 1.55s.

---

### 5.1 Unit-тесты: Order Tools

- [x] Тест schema get_order_status (phone и/или order_id)
- [x] Тест schema create_order_draft (валидация items, quantity)
- [x] Тест schema update_order_delivery (delivery vs pickup)
- [x] Тест schema confirm_order (payment_method enum)
- [x] Тест валидации: quantity = 0 → отклонение
- [x] Тест валидации: quantity > 100 → отклонение
- [x] Тест валидации: некорректный phone формат

**Файлы:** `tests/unit/test_order_tools.py`
**Заметки:** 13 тестов в 4 классах. Проверка canonical names, required fields, enums.

---

### 5.2 Unit-тесты: Store Client (заказы)

- [x] Тест search_orders — корректный маппинг
- [x] Тест get_order — полная информация
- [x] Тест create_order — Idempotency-Key генерируется
- [x] Тест update_delivery — доставка и самовывоз
- [x] Тест confirm_order — Idempotency-Key, sms_sent
- [x] Тест повторного запроса с тем же Idempotency-Key → тот же ответ

**Файлы:** `tests/unit/test_store_client_orders.py`
**Заметки:** 11 тестов. Используют unittest.mock.patch для _get/_post/_patch.

---

### 5.3 Unit-тесты: CallerID

- [x] Тест получения CallerID через ARI
- [x] Тест скрытого CallerID → None
- [x] Тест ARI недоступен → ошибка обработана
- [x] Тест интеграции CallerID в CallSession

**Файлы:** `tests/unit/test_caller_id.py`
**Заметки:** 11 тестов — 6 для ARI клиента + 5 для интеграции с CallSession.

---

### 5.4 Adversarial-тесты: безопасность заказов

- [x] Запрос чужого заказа (phone не совпадает с CallerID) → отказ
- [x] Заказ с quantity=10000 → отклонение, предложение оператора
- [x] Заказ с quantity=0 → отклонение
- [x] Попытка confirm_order без предварительного подтверждения → агент сначала озвучивает итого
- [x] Отмена заказа в середине оформления → черновик удалён
- [x] Prompt injection во время оформления → агент продолжает нормально

**Файлы:** `tests/unit/test_adversarial_orders.py`
**Заметки:** 16 тестов — проверка промпта, tool descriptions, schema constraints, _build_system_prompt.

---

### 5.5 E2E тесты: заказы

- [x] SIP-звонок → "Де мій заказ?" → бот озвучивает статус
- [x] SIP-звонок → подбор шин → "Замовити" → полный цикл оформления
- [x] SIP-звонок → "Скасуй замовлення" → отмена на этапе доставки

**Файлы:** `tests/e2e/test_orders.py`
**Заметки:** Scaffolding создан, тесты skip (требуют полный стек).

---

## При завершении фазы

1. Убедись, что все задачи отмечены [x]
2. Измени статус фазы: [x] Завершена
3. Заполни дату "Завершена: YYYY-MM-DD"
4. Покрытие: 124 теста, все проходят
5. Выполни коммит
6. Обнови PROGRESS.md — Фаза 2 Заказы завершена!
