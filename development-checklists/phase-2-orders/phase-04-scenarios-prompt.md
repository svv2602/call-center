# Фаза 4: Сценарии и промпт

## Статус
- [x] Не начата
- [x] В процессе
- [x] Завершена

**Начата:** 2026-02-14
**Завершена:** 2026-02-14

## Цель фазы

Обновить системный промпт для поддержки заказов. Реализовать сценарии: проверка статуса заказа, полный цикл оформления (draft → delivery → confirm), отмена на любом этапе.

## Задачи

### 4.0 ОБЯЗАТЕЛЬНО: Анализ и планирование

#### A. Анализ существующего кода
- [x] Изучить текущий системный промпт в `src/agent/prompts.py`
- [x] Изучить сценарии из `doc/development/phase-2-orders.md`
- [x] Проверить как CallerID передаётся в агент (из phase-01)

#### B. Анализ зависимостей
- [x] CallerID доступен через CallSession (из phase-01)
- [x] Все 4 новых tools реализованы (из phase-02)
- [x] Store API endpoints работают (из phase-03)

**Новые абстракции:** Нет
**Новые env variables:** Нет
**Новые tools:** Нет (уже реализованы)
**Миграции БД:** Нет

#### C. Проверка архитектуры
- [x] Промпт включает правила оформления заказа (подтверждение суммы, доставка, оплата)
- [x] Безопасность: подтверждение перед финализацией
- [x] Отмена возможна на любом этапе

**Референс-модуль:** `src/agent/prompts.py`, `doc/development/phase-2-orders.md`

**Цель:** Определить обновлённый промпт и правила поведения агента для заказов.

**Заметки для переиспользования:** `PROMPT_VERSION = "v2.0-orders"`. `_build_system_prompt()` добавляет контекст CallerID и order_id.

---

### 4.1 Обновление системного промпта

- [x] Добавить в промпт возможности фазы 2:
  - Перевірка статусу замовлення за номером телефону або номером замовлення
  - Оформлення замовлення (створення, вибір доставки, підтвердження)
- [x] Правила оформления заказа:
  - Завжди підтверджуй склад замовлення перед оформленням
  - Обов'язково уточни: доставка чи самовивіз
  - Обов'язково уточни: спосіб оплати
  - Назви підсумкову суму перед підтвердженням
  - Після оформлення — продиктуй номер замовлення повільно і чітко

**Файлы:** `src/agent/prompts.py`
**Заметки:** Промпт включает все 10 шагов оформления заказа, правила безопасности, и идентификацию клиента.

---

### 4.2 Сценарий: Статус заказа

- [x] Агент получает CallerID автоматически
- [x] Вызывает `get_order_status(phone=CallerID)`
- [x] Если несколько заказов — перечисляет, спрашивает какой интересует
- [x] Если заказ не найден — предлагает назвать номер заказа
- [x] Озвучивает: номер, статус, дату доставки

**Файлы:** `src/agent/agent.py`, `src/agent/prompts.py`
**Заметки:** CallerID передаётся в `_build_system_prompt()`. Промпт содержит раздел "Перевірка статусу замовлення".

---

### 4.3 Сценарий: Оформление заказа (полный цикл)

- [x] Шаг 1: create_order_draft — создание черновика (после подбора шин)
- [x] Шаг 2: озвучить состав и сумму, спросить подтверждение
- [x] Шаг 3: уточнить доставка/самовывоз → update_order_delivery
- [x] Шаг 4: озвучить итого с доставкой, уточнить оплату
- [x] Шаг 5: confirm_order → озвучить номер заказа медленно и чётко
- [x] Обработка отмены на любом этапе ("скасуй" → удалить черновик)

**Файлы:** `src/agent/agent.py`, `src/agent/prompts.py`
**Заметки:** Полный цикл описан в промпте раздел "Порядок оформлення замовлення" (10 шагов). `ORDER_CANCELLED_TEXT` добавлен.

---

### 4.4 Безопасность заказов

- [x] Перед confirm_order — обязательное подтверждение (состав + сумма + "так")
- [x] Отмена на любом этапе: "скасуй" → черновик удаляется
- [x] Таймаут 30 сек при молчании во время оформления → спросить, продолжаем ли
- [x] Лимит суммы заказа через бота (настраиваемый порог → выше → оператор)
- [x] CallerID проверка: не выдавать чужие заказы (phone из запроса == CallerID)

**Файлы:** `src/agent/agent.py`
**Заметки:** Правила безопасности вынесены в отдельный раздел промпта "Правила безпеки замовлень". Лимит 20 шин → оператор.

---

## При завершении фазы

1. Убедись, что все задачи отмечены [x]
2. Измени статус фазы: [x] Завершена
3. Заполни дату "Завершена: YYYY-MM-DD"
4. Выполни коммит
5. Обнови PROGRESS.md
6. Открой следующую фазу: `phase-05-testing.md`
