# Фаза 4: Сценарии и промпт

## Статус
- [ ] Не начата
- [ ] В процессе
- [ ] Завершена

**Начата:** -
**Завершена:** -

## Цель фазы

Обновить системный промпт для поддержки заказов. Реализовать сценарии: проверка статуса заказа, полный цикл оформления (draft → delivery → confirm), отмена на любом этапе.

## Задачи

### 4.0 ОБЯЗАТЕЛЬНО: Анализ и планирование

#### A. Анализ существующего кода
- [ ] Изучить текущий системный промпт в `src/agent/prompts.py`
- [ ] Изучить сценарии из `doc/development/phase-2-orders.md`
- [ ] Проверить как CallerID передаётся в агент (из phase-01)

**Команды для поиска:**
```bash
cat src/agent/prompts.py
grep -rn "system_prompt\|SYSTEM_PROMPT" src/
```

#### B. Анализ зависимостей
- [ ] CallerID доступен через CallSession (из phase-01)
- [ ] Все 4 новых tools реализованы (из phase-02)
- [ ] Store API endpoints работают (из phase-03)

**Новые абстракции:** Нет
**Новые env variables:** Нет
**Новые tools:** Нет (уже реализованы)
**Миграции БД:** Нет

#### C. Проверка архитектуры
- [ ] Промпт включает правила оформления заказа (подтверждение суммы, доставка, оплата)
- [ ] Безопасность: подтверждение перед финализацией
- [ ] Отмена возможна на любом этапе

**Референс-модуль:** `src/agent/prompts.py`, `doc/development/phase-2-orders.md`

**Цель:** Определить обновлённый промпт и правила поведения агента для заказов.

**Заметки для переиспользования:** -

---

### 4.1 Обновление системного промпта

- [ ] Добавить в промпт возможности фазы 2:
  - Перевірка статусу замовлення за номером телефону або номером замовлення
  - Оформлення замовлення (створення, вибір доставки, підтвердження)
- [ ] Правила оформления заказа:
  - Завжди підтверджуй склад замовлення перед оформленням
  - Обов'язково уточни: доставка чи самовивіз
  - Обов'язково уточни: спосіб оплати
  - Назви підсумкову суму перед підтвердженням
  - Після оформлення — продиктуй номер замовлення повільно і чітко

**Файлы:** `src/agent/prompts.py`
**Заметки:** -

---

### 4.2 Сценарий: Статус заказа

- [ ] Агент получает CallerID автоматически
- [ ] Вызывает `get_order_status(phone=CallerID)`
- [ ] Если несколько заказов — перечисляет, спрашивает какой интересует
- [ ] Если заказ не найден — предлагает назвать номер заказа
- [ ] Озвучивает: номер, статус, дату доставки

**Файлы:** `src/agent/agent.py`, `src/agent/prompts.py`
**Заметки:** -

---

### 4.3 Сценарий: Оформление заказа (полный цикл)

- [ ] Шаг 1: create_order_draft — создание черновика (после подбора шин)
- [ ] Шаг 2: озвучить состав и сумму, спросить подтверждение
- [ ] Шаг 3: уточнить доставка/самовывоз → update_order_delivery
- [ ] Шаг 4: озвучить итого с доставкой, уточнить оплату
- [ ] Шаг 5: confirm_order → озвучить номер заказа медленно и чётко
- [ ] Обработка отмены на любом этапе ("скасуй" → удалить черновик)

**Файлы:** `src/agent/agent.py`, `src/agent/prompts.py`
**Заметки:** -

---

### 4.4 Безопасность заказов

- [ ] Перед confirm_order — обязательное подтверждение (состав + сумма + "так")
- [ ] Отмена на любом этапе: "скасуй" → черновик удаляется
- [ ] Таймаут 30 сек при молчании во время оформления → спросить, продолжаем ли
- [ ] Лимит суммы заказа через бота (настраиваемый порог → выше → оператор)
- [ ] CallerID проверка: не выдавать чужие заказы (phone из запроса == CallerID)

**Файлы:** `src/agent/agent.py`
**Заметки:** -

---

## При завершении фазы

1. Убедись, что все задачи отмечены [x]
2. Измени статус фазы: [x] Завершена
3. Заполни дату "Завершена: YYYY-MM-DD"
4. Выполни коммит:
   ```bash
   git add .
   git commit -m "checklist(phase-2-orders): phase-4 scenarios and prompt completed"
   ```
5. Обнови PROGRESS.md
6. Открой следующую фазу: `phase-05-testing.md`
