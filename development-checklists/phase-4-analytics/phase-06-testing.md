# Фаза 6: Тестирование аналитики

## Статус
- [ ] Не начата
- [ ] В процессе
- [ ] Завершена

**Начата:** -
**Завершена:** -

## Цель фазы

Тестирование всех компонентов фазы 4: метрики, качество, A/B тесты, алерты, админ-интерфейс, оптимизация.

## Задачи

### 6.0 ОБЯЗАТЕЛЬНО: Анализ и планирование

#### A. Анализ существующего кода
- [ ] Проверить существующие тесты из фаз 1-3
- [ ] Определить новые тестовые сценарии для фазы 4

**Команды для поиска:**
```bash
ls tests/unit/ tests/integration/
grep -rn "def test_.*metric\|def test_.*quality\|def test_.*prompt\|def test_.*ab" tests/
```

**Референс-модуль:** Существующие тесты

**Цель:** Определить полный план тестирования фазы 4.

**Заметки для переиспользования:** -

---

### 6.1 Unit-тесты: Quality Evaluator

- [ ] Тест: оценка качества по каждому критерию
- [ ] Тест: общий quality_score расчёт
- [ ] Тест: обнаружение проблемных звонков (score < 0.5)
- [ ] Тест: Celery задача запускается после звонка
- [ ] Тест: обработка ошибок LLM при оценке

**Файлы:** `tests/unit/test_quality_evaluator.py`
**Заметки:** -

---

### 6.2 Unit-тесты: A/B тестирование

- [ ] Тест: создание новой версии промпта
- [ ] Тест: рандомизация варианта при звонке
- [ ] Тест: агрегация метрик по вариантам
- [ ] Тест: статистическая значимость
- [ ] Тест: fallback при недоступности БД промптов

**Файлы:** `tests/unit/test_ab_testing.py`
**Заметки:** -

---

### 6.3 Unit-тесты: Cost Optimization

- [ ] Тест: Whisper STT реализация (mock model)
- [ ] Тест: кэширование TTS (cache hit/miss)
- [ ] Тест: model routing (простой запрос → Haiku, сложный → Sonnet)
- [ ] Тест: расчёт стоимости звонка (cost_breakdown)
- [ ] Тест: feature flags для переключения провайдеров

**Файлы:** `tests/unit/test_cost_optimization.py`
**Заметки:** -

---

### 6.4 Integration-тесты: Metrics + Grafana

- [ ] Тест: Prometheus метрики экспортируются корректно
- [ ] Тест: daily_stats заполняются Celery beat задачей
- [ ] Тест: API endpoints аналитики возвращают корректные данные
- [ ] Тест: фильтры и пагинация в GET /analytics/calls

**Файлы:** `tests/integration/test_analytics.py`
**Заметки:** -

---

### 6.5 Тесты алертов

- [ ] Тест: алерт при >50% переключений
- [ ] Тест: алерт при >5 ошибок за 10 минут
- [ ] Тест: алерт при p95 > 3 секунды
- [ ] Тест: алерт при аномальном расходе API
- [ ] Тест: Telegram webhook вызывается при алерте

**Файлы:** `tests/unit/test_alerts.py`
**Заметки:** Mock Alertmanager и Telegram API

---

## При завершении фазы

1. Убедись, что все задачи отмечены [x]
2. Измени статус фазы: [x] Завершена
3. Заполни дату "Завершена: YYYY-MM-DD"
4. Проверь покрытие:
   ```bash
   pytest tests/ --cov=src --cov-report=html
   ```
5. Выполни коммит:
   ```bash
   git add .
   git commit -m "checklist(phase-4-analytics): phase-6 testing completed"
   ```
6. Обнови PROGRESS.md — Фаза 4 Аналитика завершена!
7. Вся система Call Center AI завершена!
