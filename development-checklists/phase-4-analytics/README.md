# Фаза 4 — Аналитика и оптимизация

## Цель

Построить систему аналитики, мониторинга качества и инструменты оптимизации. Превратить колл-центр из "работающего" в "эффективно работающий": понимать метрики, находить проблемы, улучшать промпты и снижать расходы.

## Пререквизиты

- Фазы 1–3 завершены и работают в продакшене
- Накоплена статистика минимум за 2–4 недели эксплуатации
- PostgreSQL содержит логи звонков с транскрипциями

## Критерии успеха

- [ ] Grafana-дашборд отображает все ключевые метрики в реальном времени
- [ ] Все звонки логируются с полной транскрипцией и метаданными
- [ ] Автоматическая оценка качества работает для каждого звонка
- [ ] A/B тестирование промптов запущено минимум для 1 варианта
- [ ] Алерты настроены и работают (хотя бы Telegram)
- [ ] Веб-интерфейс администратора: журнал звонков + детали + управление промптами
- [ ] Стоимость обработки одного звонка снижена на 20%+ по сравнению с фазой 1
- [ ] Документирована процедура анализа проблемных звонков

## Фазы работы

1. [Метрики и дашборды](phase-01-metrics.md) — Prometheus экспортер, Grafana дашборды
2. [Оценка качества](phase-02-quality.md) — Автоматическая оценка качества, Celery
3. [A/B тестирование](phase-03-ab-testing.md) — Версионирование промптов, A/B тесты
4. [Админ-интерфейс](phase-04-admin-ui.md) — Веб-интерфейс: журнал, настройки, CRUD
5. [Оптимизация расходов](phase-05-cost-optimization.md) — Whisper, кэширование TTS, model routing
6. [Тестирование](phase-06-testing.md) — Тесты метрик, качества, A/B, алертов

## Источник требований

- `doc/development/phase-4-analytics.md` — основной
- `doc/technical/nfr.md` — нефункциональные требования (мониторинг, алерты)
- `doc/technical/deployment.md` — развёртывание (Grafana, Prometheus)
- `doc/development/api-specification.md` — аналитические API endpoints
- `doc/technical/data-model.md` — таблицы prompt_versions, prompt_ab_tests, daily_stats

## Новые Store API endpoints (аналитика)

| Метод | Endpoint | Описание |
|-------|----------|----------|
| GET | `/api/v1/analytics/calls` | Список звонков с фильтрами |
| GET | `/api/v1/analytics/calls/{id}` | Детали звонка |
| GET | `/api/v1/analytics/summary` | Агрегированная статистика |
| GET | `/api/v1/analytics/quality` | Отчёт по качеству |
| GET | `/api/v1/prompts` | Список версий промптов |
| POST | `/api/v1/prompts` | Создать новую версию промпта |
| PATCH | `/api/v1/prompts/{id}/activate` | Активировать версию |
| GET | `/api/v1/prompts/ab-tests` | Текущие A/B тесты |

## Зависимости от Фаз 1–3

- Все компоненты (AudioSocket, STT, TTS, LLM, Store Client) работают
- PostgreSQL содержит логи звонков
- Prometheus метрики экспортируются
- Все tools из фаз 1–3 работают

## Начало работы

Для начала или продолжения работы прочитай [PROGRESS.md](PROGRESS.md)
