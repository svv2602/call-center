# Фаза 3: A/B тестирование промптов

## Статус
- [ ] Не начата
- [ ] В процессе
- [ ] Завершена

**Начата:** -
**Завершена:** -

## Цель фазы

Реализовать версионирование промптов и A/B тестирование. Каждый звонок получает вариант промпта, метрики сравниваются для выбора лучшего.

## Задачи

### 3.0 ОБЯЗАТЕЛЬНО: Анализ и планирование

#### A. Анализ существующего кода
- [ ] Проверить таблицы prompt_versions, prompt_ab_tests в data-model
- [ ] Изучить как промпт передаётся в Agent (src/agent/prompts.py)
- [ ] Проверить поле calls.prompt_version

**Команды для поиска:**
```bash
grep -rn "prompt_version\|prompt_variants\|ab_test" src/
grep -rn "SYSTEM_PROMPT\|system_prompt" src/agent/
```

#### B. Анализ зависимостей
- [ ] Таблицы prompt_versions, prompt_ab_tests (миграция)
- [ ] Модификация Agent для получения промпта из БД
- [ ] Рандомизация варианта при начале звонка

**Новые абстракции:** Нет
**Новые env variables:** Нет
**Новые tools:** Нет
**Миграции БД:** Расширение — таблицы prompt_versions, prompt_ab_tests

**Референс-модуль:** `doc/development/phase-4-analytics.md` — секция 4.4

**Цель:** Определить механизм A/B тестирования промптов.

**Заметки для переиспользования:** -

---

### 3.1 Версионирование промптов

- [ ] Создать модуль `src/agent/prompt_manager.py`
- [ ] Хранение промптов в PostgreSQL (таблица prompt_versions)
- [ ] Поля: id, name, system_prompt, tools_config, is_active, metadata
- [ ] CRUD операции: create, get active, activate version
- [ ] При старте — загрузка активного промпта из БД
- [ ] Fallback: если БД недоступна → использовать хардкодированный промпт

**Файлы:** `src/agent/prompt_manager.py`
**Заметки:** -

---

### 3.2 A/B тестирование

- [ ] Создать модуль `src/agent/ab_testing.py`
- [ ] Таблица prompt_ab_tests: test_name, variant_a_id, variant_b_id, calls_a, calls_b, quality_a, quality_b, status, started_at
- [ ] При начале звонка: случайный выбор варианта A или B
- [ ] Запись варианта в calls.prompt_version
- [ ] Агрегация метрик по вариантам: % решения без оператора, avg quality, avg duration

**Файлы:** `src/agent/ab_testing.py`
**Заметки:** -

---

### 3.3 API для управления промптами

- [ ] `GET /prompts` — список версий промптов
- [ ] `POST /prompts` — создать новую версию
- [ ] `PATCH /prompts/{id}/activate` — активировать версию
- [ ] `GET /prompts/ab-tests` — текущие A/B тесты
- [ ] `POST /prompts/ab-tests` — создать новый A/B тест
- [ ] `PATCH /prompts/ab-tests/{id}/stop` — остановить тест, зафиксировать результат

**Файлы:** `src/api/routes.py`
**Заметки:** -

---

### 3.4 Статистическая значимость

- [ ] Расчёт статистической значимости разницы между вариантами
- [ ] Минимальный размер выборки для каждого варианта
- [ ] Автоматическое предложение о переключении при значимой разнице
- [ ] Панель в Grafana: сравнение вариантов

**Файлы:** `src/agent/ab_testing.py`
**Заметки:** -

---

### 3.5 Автоматическая доработка промптов

- [ ] Сбор проблемных диалогов (quality_score < 0.5)
- [ ] Анализ причин неудач (паттерны)
- [ ] Генерация предложений по улучшению промпта (LLM)
- [ ] Ручное одобрение менеджером → создание новой версии

**Файлы:** `src/tasks/prompt_optimizer.py`
**Заметки:** Celery задача, запускается по расписанию

---

## При завершении фазы

1. Убедись, что все задачи отмечены [x]
2. Измени статус фазы: [x] Завершена
3. Заполни дату "Завершена: YYYY-MM-DD"
4. Выполни коммит:
   ```bash
   git add .
   git commit -m "checklist(phase-4-analytics): phase-3 AB testing completed"
   ```
5. Обнови PROGRESS.md
6. Открой следующую фазу: `phase-04-admin-ui.md`
