# Фаза 4: Комплексные сценарии

## Статус
- [ ] Не начата
- [ ] В процессе
- [ ] Завершена

**Начата:** -
**Завершена:** -

## Цель фазы

Реализовать связку сценариев в цепочки (подбор → заказ → монтаж), обновить системный промпт для фазы 3, реализовать экспертные консультации с использованием базы знаний.

## Задачи

### 4.0 ОБЯЗАТЕЛЬНО: Анализ и планирование

#### A. Анализ существующего кода
- [ ] Изучить текущий промпт (MVP + заказы)
- [ ] Изучить сценарии из `doc/development/phase-3-services.md`
- [ ] Проверить как работает связка tool calls в цепочке

**Команды для поиска:**
```bash
cat src/agent/prompts.py
grep -rn "linked_order_id\|комплексн" src/
```

#### B. Анализ зависимостей
- [ ] Все tools фаз 1-3 реализованы
- [ ] База знаний наполнена (минимум 20 статей)
- [ ] CallerID, заказы, шиномонтаж работают

**Референс-модуль:** `doc/development/phase-3-services.md` — секция 3.3

**Цель:** Определить обновлённый промпт и правила комплексных сценариев.

**Заметки для переиспользования:** -

---

### 4.1 Обновление системного промпта

- [ ] Добавить возможности фазы 3:
  - Запис на шиномонтаж (вибір точки, дати, часу)
  - Експертна консультація з підбору шин
  - Порівняння брендів та моделей
  - Комплексне обслуговування: підбір + замовлення + запис на монтаж
- [ ] Правила консультации:
  - Використовуй базу знань для порівнянь та рекомендацій
  - Не вигадуй характеристики — шукай в базі знань
  - Якщо питання занадто складне — переключи на менеджера
- [ ] Правила записи на монтаж:
  - Обов'язково уточни: місто, бажану дату, зручний час
  - Запропонуй 2-3 найближчі слоти
  - Після запису — нагадай адресу та час

**Файлы:** `src/agent/prompts.py`
**Заметки:** -

---

### 4.2 Сценарий: Запись на шиномонтаж (полный цикл)

- [ ] Шаг 1: уточнить город → get_fitting_stations
- [ ] Шаг 2: клиент выбирает станцию → get_fitting_slots
- [ ] Шаг 3: клиент выбирает время → book_fitting
- [ ] Шаг 4: озвучить подтверждение (адрес, дата, время, цена)
- [ ] Связка с заказом: если клиент купил шины → linked_order_id
- [ ] Отмена/перенос: cancel_fitting

**Файлы:** `src/agent/agent.py`, `src/agent/prompts.py`
**Заметки:** -

---

### 4.3 Сценарий: Экспертная консультация

- [ ] Определение консультационного вопроса (сравнение, рекомендация)
- [ ] Вызов search_knowledge_base → получение контекста
- [ ] LLM формирует экспертный ответ на основе контекста из базы знаний
- [ ] Примеры: "Що краще — Michelin чи Continental?", "Який бюджет потрібен на комплект?"
- [ ] Если вопрос слишком сложный → предложить переключить на менеджера

**Файлы:** `src/agent/agent.py`, `src/agent/prompts.py`
**Заметки:** -

---

### 4.4 Комплексный сценарий: подбор → заказ → монтаж

- [ ] Агент проводит подбор шин (search_tires)
- [ ] Предлагает оформить заказ → create_order_draft → confirm_order
- [ ] После подтверждения заказа: "Бажаєте записатися на шиномонтаж?"
- [ ] Если да → get_fitting_stations → get_fitting_slots → book_fitting(linked_order_id=order_id)
- [ ] В конце: резюме всех действий (заказ + запись)

**Файлы:** `src/agent/agent.py`, `src/agent/prompts.py`
**Заметки:** Ключевой сценарий фазы 3 — связка трёх действий в одном звонке

---

## При завершении фазы

1. Убедись, что все задачи отмечены [x]
2. Измени статус фазы: [x] Завершена
3. Заполни дату "Завершена: YYYY-MM-DD"
4. Выполни коммит:
   ```bash
   git add .
   git commit -m "checklist(phase-3-services): phase-4 complex scenarios completed"
   ```
5. Обнови PROGRESS.md
6. Открой следующую фазу: `phase-05-testing.md`
